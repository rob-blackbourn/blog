<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Robs Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Robs Blog">
<meta property="og:url" content="https://rob-blackbourn.github.io/blog/page/2/index.html">
<meta property="og:site_name" content="Robs Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Rob Blackbourn">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/blog/atom.xml" title="Robs Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/blog/favicon.png">
  
  
  
<link rel="stylesheet" href="/blog/css/style.css">

  
    
<link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

  
<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Robs Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          
            <a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/rob-blackbourn"><span class="fa fa-github"></span></a>
          
            <a class="nav-icon" target="_blank" rel="noopener" href="https://www.linkedin.com/in/rob-blackbourn/"><span class="fa fa-linkedin"></span></a>
          
        
        
          <a class="nav-icon" href="/blog/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://rob-blackbourn.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-wasm-stdout-stderr" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2020/06/20/wasm-stdout-stderr/" class="article-date">
  <time class="dt-published" datetime="2020-06-20T20:59:00.000Z" itemprop="datePublished">2020-06-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/WebAssembly/">WebAssembly</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2020/06/20/wasm-stdout-stderr/">Handling Stdout/Stderr with JavaScript and WebAssembly</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>In my<br><a href="https://rob-blackbourn.github.io/blog/2020/06/20/wasm-string-passing/">previous post</a><br>I found out how to pass strings between JavaScript and WebAssembly. The problem<br>with that solution was that I had to export <code>console.log</code> to the WebAssembly<br>module. At some point I want to be able to take some library source code “off<br>the shelf”, compile and use it without modification.<br>Sadly many libraries will use <code>stdin</code>&#x2F;<code>stdout</code><br>with <code>printf</code>, <code>puts</code>, or <code>perror</code>.</p>
<p>This is going to mean more work at the WASI layer!</p>
<p>You can find the source code for this post<br><a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/example-wasm-stdout-stderr">here</a>.</p>
<h2 id="The-Problem"><a href="#The-Problem" class="headerlink" title="The Problem"></a>The Problem</h2><p>If a program issues a call like <code>printf</code> it’s often sending its output to the<br>terminal, or possibly to a file. In any case this is certainly escaping the<br>WebAssembly sandbox. The<br><a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wasi-libc">wasm-libc</a><br>library was built with the expectation of a WASI implementation. We can use this<br>to handle enough <code>stdio</code> to suit our needs.</p>
<h2 id="The-C-Code"><a href="#The-C-Code" class="headerlink" title="The C Code"></a>The C Code</h2><p>Here is the C code I’d like to provide WASI support for.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __wasi__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;locale.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> is_locale_initialised = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">initLocale</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// The locale must be initialised before using</span></span><br><span class="line">    <span class="comment">// multi byte characters.</span></span><br><span class="line">    is_locale_initialised = <span class="number">1</span>;</span><br><span class="line">    setlocale(LC_ALL, <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((used)) <span class="type">void</span> <span class="title function_">callPerror</span><span class="params">(<span class="type">char</span>* ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_locale_initialised == <span class="number">0</span>)</span><br><span class="line">        initLocale();</span><br><span class="line"></span><br><span class="line">    perror(<span class="string">&quot;Help!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((used)) <span class="type">void</span> <span class="title function_">writeToStdout</span><span class="params">(<span class="type">char</span>* ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_locale_initialised == <span class="number">0</span>)</span><br><span class="line">        initLocale();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fputs</span>(ptr, <span class="built_in">stdout</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((used)) <span class="type">void</span> <span class="title function_">writeToStderr</span><span class="params">(<span class="type">char</span>* ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_locale_initialised == <span class="number">0</span>)</span><br><span class="line">        initLocale();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fputs</span>(ptr, <span class="built_in">stderr</span>);</span><br><span class="line">    fflush(<span class="built_in">stderr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Clearly the line at the start <code>#define __wasi__</code> needs some explanation. Without<br>this, compilation broke with the error<br><code>#error &lt;wasi/api.h&gt; is only supported on WASI platforms</code>. When I checked the<br>include file the <code>__wasi__</code> was the culprit. Defining it enabled the<br>stdio functionality.</p>
<h2 id="The-JavaScript-Example"><a href="#The-JavaScript-Example" class="headerlink" title="The JavaScript Example"></a>The JavaScript Example</h2><p>This is basically a clone of the previous post. The example code is as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> setupWasi = <span class="built_in">require</span>(<span class="string">&#x27;./setup-wasi&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Setup the WASI instance.</span></span><br><span class="line">  <span class="keyword">const</span> wasi = <span class="keyword">await</span> <span class="title function_">setupWasi</span>(<span class="string">&#x27;./stdio-example.wasm&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the functions exported from the WebAssembly</span></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    writeToStdout,</span><br><span class="line">    writeToStderr,</span><br><span class="line">    callPerror</span><br><span class="line">  &#125; = wasi.<span class="property">instance</span>.<span class="property">exports</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> ptr1 = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    ptr1 = wasi.<span class="property">wasiMemoryManager</span>.<span class="title function_">convertFromString</span>(<span class="string">&#x27;To stdout\n&#x27;</span>)</span><br><span class="line">    <span class="title function_">writeToStdout</span>(ptr1.<span class="property">byteOffset</span>)</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    wasi.<span class="property">wasiMemoryManager</span>.<span class="title function_">free</span>(ptr1)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    ptr1 = wasi.<span class="property">wasiMemoryManager</span>.<span class="title function_">convertFromString</span>(<span class="string">&#x27;To stderr\n&#x27;</span>)</span><br><span class="line">    <span class="title function_">writeToStderr</span>(ptr1.<span class="property">byteOffset</span>)</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    wasi.<span class="property">wasiMemoryManager</span>.<span class="title function_">free</span>(ptr1)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">callPerror</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">main</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Done&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>I’ve used the helper function <code>convertFromString</code> to create the string in the<br>memory space of the WebAssembly instance.</p>
<h2 id="The-WASI-Code"><a href="#The-WASI-Code" class="headerlink" title="The WASI Code"></a>The WASI Code</h2><p>Running the code exposes the calls we need to implement. It turned out we need:<br><code>fd_close</code>, <code>fd_seek</code>, <code>fd_write</code>, and <code>fd_fdstat_get</code>.</p>
<p>My goal here is to implement <code>stdout</code> and <code>stderr</code> with <code>console.log</code> and<br><code>console.error</code>. Here is my implementation.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">fd_close = <span class="function"><span class="params">fd</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable constant_">WASI_ESUCCESS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fd_seek = <span class="function">(<span class="params">fd, offset_low, offset_high, whence, newOffset</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable constant_">WASI_ESUCCESS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fd_write = <span class="function">(<span class="params">fd, iovs, iovsLen, nwritten</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// We only care about stdout or stderr</span></span><br><span class="line">  <span class="keyword">if</span> (!(fd === <span class="variable constant_">STDOUT</span> | fd === <span class="variable constant_">STDERR</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable constant_">WASI_ERRNO_BADF</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(<span class="variable language_">this</span>.<span class="property">wasiMemoryManager</span>.<span class="property">memory</span>.<span class="property">buffer</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create a UInt8Array for each buffer</span></span><br><span class="line">  <span class="keyword">const</span> buffers = <span class="title class_">Array</span>.<span class="title function_">from</span>(&#123; <span class="attr">length</span>: iovsLen &#125;, <span class="function">(<span class="params">_, i</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ptr = iovs + i * <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">const</span> buf = view.<span class="title function_">getUint32</span>(ptr, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">const</span> bufLen = view.<span class="title function_">getUint32</span>(ptr + <span class="number">4</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable language_">this</span>.<span class="property">wasiMemoryManager</span>.<span class="property">memory</span>.<span class="property">buffer</span>, buf, bufLen);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> textDecoder = <span class="keyword">new</span> <span class="title class_">TextDecoder</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Turn each buffer into a utf-8 string.</span></span><br><span class="line">  <span class="keyword">let</span> written = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> text = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  buffers.<span class="title function_">forEach</span>(<span class="function"><span class="params">buf</span> =&gt;</span> &#123;</span><br><span class="line">    text += textDecoder.<span class="title function_">decode</span>(buf)</span><br><span class="line">    written += buf.<span class="property">byteLength</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return the bytes written.</span></span><br><span class="line">  view.<span class="title function_">setUint32</span>(nwritten, written, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Send the output to the console.</span></span><br><span class="line">  <span class="keyword">if</span> (fd === <span class="variable constant_">STDOUT</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stdoutText</span> = <span class="title function_">drainWriter</span>(<span class="variable language_">console</span>.<span class="property">log</span>, <span class="variable language_">this</span>.<span class="property">stdoutText</span>, text)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fd == <span class="variable constant_">STDERR</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">stderrText</span> = <span class="title function_">drainWriter</span>(<span class="variable language_">console</span>.<span class="property">error</span>, <span class="variable language_">this</span>.<span class="property">stderrText</span>, text)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="variable constant_">WASI_ESUCCESS</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fd_fdstat_get = <span class="function">(<span class="params">fd, stat</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// We only care about stdout or stderr</span></span><br><span class="line">  <span class="keyword">if</span> (!(fd === <span class="variable constant_">STDOUT</span> | fd === <span class="variable constant_">STDERR</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable constant_">WASI_ERRNO_BADF</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(<span class="variable language_">this</span>.<span class="property">wasiMemoryManager</span>.<span class="property">memory</span>.<span class="property">buffer</span>)</span><br><span class="line">  <span class="comment">// filetype</span></span><br><span class="line">  view.<span class="title function_">setUint8</span>(stat + <span class="number">0</span>, <span class="variable constant_">WASI_FILETYPE_CHARACTER_DEVICE</span>);</span><br><span class="line">  <span class="comment">// fdflags</span></span><br><span class="line">  view.<span class="title function_">setUint32</span>(stat + <span class="number">2</span>, <span class="variable constant_">WASI_FDFLAGS_APPEND</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="comment">// rights base</span></span><br><span class="line">  view.<span class="title function_">setBigUint64</span>(stat + <span class="number">8</span>, <span class="variable constant_">WASI_RIGHTS_FD_WRITE</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="comment">// rights inheriting</span></span><br><span class="line">  view.<span class="title function_">setBigUint64</span>(stat + <span class="number">16</span>, <span class="variable constant_">WASI_RIGHTS_FD_WRITE</span>, <span class="literal">true</span>);        </span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="variable constant_">WASI_ESUCCESS</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For <code>fd_close</code> and <code>fd_seek</code> there’s nothing to do. We Can’t close <code>console.log</code><br>and its not random access so we can’t seek.<br>The <code>fd_stat_get</code> function was a bit of a guess with<br>the rights inherit, but it worked. The <code>fd_write</code> function needed to be sensitive to newlines as there’s no way to suppress a newline in<br>the console functions. The text received gets appended until a newline is received, then we report it. The<br><code>drainWriter</code> function is as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">drainWriter</span> (write, prev, current) &#123;</span><br><span class="line">  <span class="keyword">let</span> text = prev + current</span><br><span class="line">  <span class="keyword">while</span> (text.<span class="title function_">includes</span>(<span class="string">&#x27;\n&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> [line, rest] = text.<span class="title function_">split</span>(<span class="string">&#x27;\n&#x27;</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="title function_">write</span>(line)</span><br><span class="line">    text = rest</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> text</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>I’m feeling quite pleased. We’ve added some complication with the WASI<br>stubs, but the code is still fairly small and understandable. My goal<br>is to get to a point where I can drop in a C library and compile it to<br>WebAssembly without modification. At the moment this seems like a<br>realistic possibility.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2020/06/20/wasm-stdout-stderr/" data-id="cma87l7g0000awrjpfg4u3bvh" data-title="Handling Stdout/Stderr with JavaScript and WebAssembly" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/C/" rel="tag">C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/clang/" rel="tag">clang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/libc/" rel="tag">libc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/strings/" rel="tag">strings</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm-libc/" rel="tag">wasm-libc</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-wasm-string-passing" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2020/06/20/wasm-string-passing/" class="article-date">
  <time class="dt-published" datetime="2020-06-20T10:04:00.000Z" itemprop="datePublished">2020-06-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/WebAssembly/">WebAssembly</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2020/06/20/wasm-string-passing/">How to Pass Strings Between JavaScript and WebAssembly</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>In my<br><a href="https://rob-blackbourn.github.io/blog/2020/06/07/wasm-arrays/">first post</a><br>on WebAssembly I dodged the classic “Hello, World!” example as I thought it might<br>be a bit tricky. Little did I realise how hard it was going to be!</p>
<p>In this post I’m going to look at how to solve it. The code for the project<br>can be found <a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/example-wasm-string-passing">here</a>.</p>
<h2 id="The-Problem"><a href="#The-Problem" class="headerlink" title="The Problem"></a>The Problem</h2><p>In JavaScript strings are encoded with utf-8. This format encodes characters<br>that cannot be represented in the ascii character set with more than one byte.</p>
<h2 id="The-JavaScript-Side"><a href="#The-JavaScript-Side" class="headerlink" title="The JavaScript Side"></a>The JavaScript Side</h2><p>On the JavaScript side we can use<br><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/TextEncoder">TextEncoder</a> and<br><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/TextDecoder/TextDecoder">TextDecoder</a><br>in the following manner.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WasiMemoryManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (memory, malloc, free) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">memory</span> = memory</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">malloc</span> = malloc</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">free</span> = free</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Convert a pointer from the wasm module to JavaScript string.</span></span><br><span class="line">  convertToString (ptr, length) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// The pointer is a multi byte character array encoded with utf-8.</span></span><br><span class="line">      <span class="keyword">const</span> array = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable language_">this</span>.<span class="property">memory</span>.<span class="property">buffer</span>, ptr, length)</span><br><span class="line">      <span class="keyword">const</span> decoder = <span class="keyword">new</span> <span class="title class_">TextDecoder</span>()</span><br><span class="line">      <span class="keyword">const</span> string = decoder.<span class="title function_">decode</span>(array)</span><br><span class="line">      <span class="keyword">return</span> string</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// Free the memory sent to use from the WebAssembly instance.</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">free</span>(ptr)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Convert a JavaScript string to a pointer to multi byte character array</span></span><br><span class="line">  <span class="title function_">convertFromString</span>(<span class="params">string</span>) &#123;</span><br><span class="line">    <span class="comment">// Encode the string in utf-8.</span></span><br><span class="line">    <span class="keyword">const</span> encoder = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>()</span><br><span class="line">    <span class="keyword">const</span> bytes = encoder.<span class="title function_">encode</span>(string)</span><br><span class="line">    <span class="comment">// Copy the string into memory allocated in the WebAssembly</span></span><br><span class="line">    <span class="keyword">const</span> ptr = <span class="variable language_">this</span>.<span class="title function_">malloc</span>(bytes.<span class="property">byteLength</span>)</span><br><span class="line">    <span class="keyword">const</span> buffer = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable language_">this</span>.<span class="property">memory</span>.<span class="property">buffer</span>, ptr, bytes.<span class="property">byteLength</span> + <span class="number">1</span>)</span><br><span class="line">    buffer.<span class="title function_">set</span>(bytes)</span><br><span class="line">    <span class="keyword">return</span> buffer</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note how <code>malloc</code> and <code>free</code> and used to manage the memory in the<br>WebAssembly module.</p>
<h2 id="The-C-Side"><a href="#The-C-Side" class="headerlink" title="The C Side"></a>The C Side</h2><p>The C standard library provides support for multi byte characters<br><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/c/string/multibyte">[1]</a>,<br>so I coded up a function to count the <em>letters</em> (not the bytes) of a string, and<br>a function to log “Hello, World!” in english and mandarin.</p>
<p>This was a complete failure!</p>
<p>Looking harder at the examples I noticed I was missing a called to <code>setlocale</code>,<br>so I added that to my C code. The final code looks as follows.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;locale.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Import console.log from JavaScript.</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">consoleLog</span><span class="params">(<span class="type">char</span>* ptr, <span class="type">int</span> length)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> is_locale_initialised = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">initLocale</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// The locale must be initialised before using</span></span><br><span class="line">    <span class="comment">// multi byte characters.</span></span><br><span class="line">    is_locale_initialised = <span class="number">1</span>;</span><br><span class="line">    setlocale(LC_ALL, <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Count the letters in a utf-8 encoding string.</span></span><br><span class="line">__attribute__((used)) <span class="type">size_t</span> <span class="title function_">countLetters</span><span class="params">(<span class="type">char</span>* ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_locale_initialised == <span class="number">0</span>)</span><br><span class="line">        initLocale();</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> letters = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* end = ptr + <span class="built_in">strlen</span>(ptr);</span><br><span class="line">    mblen(<span class="literal">NULL</span>, <span class="number">0</span>); <span class="comment">// reset the conversion state</span></span><br><span class="line">    <span class="keyword">while</span>(ptr &lt; end) &#123;</span><br><span class="line">        <span class="type">int</span> next = mblen(ptr, end - ptr);</span><br><span class="line">        <span class="keyword">if</span>(next == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ptr += next;</span><br><span class="line">        ++letters;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> letters;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Say hello in english</span></span><br><span class="line">__attribute__((used)) <span class="type">void</span> <span class="title function_">sayHelloWorld</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_locale_initialised == <span class="number">0</span>)</span><br><span class="line">        initLocale();</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* s1 = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">    <span class="type">size_t</span> len = <span class="built_in">strlen</span>(s1);</span><br><span class="line">    <span class="type">char</span>* s2 = <span class="built_in">malloc</span>(len + <span class="number">1</span>);</span><br><span class="line">    consoleLog(<span class="built_in">strcpy</span>(s2, s1), (<span class="type">int</span>) len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Say hello in Mandarin</span></span><br><span class="line">__attribute__((used)) <span class="type">void</span> <span class="title function_">sayHelloWorldInMandarin</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_locale_initialised == <span class="number">0</span>)</span><br><span class="line">        initLocale();</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">wchar_t</span>* wstr = <span class="string">L&quot;你好，世界！&quot;</span>;</span><br><span class="line">    <span class="type">mbstate_t</span> state;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;state, <span class="number">0</span>, <span class="keyword">sizeof</span>(state));</span><br><span class="line">    <span class="type">size_t</span> len =  wcsrtombs(<span class="literal">NULL</span>, &amp;wstr, <span class="number">0</span>, &amp;state);</span><br><span class="line">    <span class="type">char</span>* mbstr = <span class="built_in">malloc</span>(len + <span class="number">1</span>);</span><br><span class="line">    wcsrtombs(mbstr, &amp;wstr, len + <span class="number">1</span>, &amp;state);</span><br><span class="line">    consoleLog(mbstr, (<span class="type">int</span>) len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then I ran the program and BOOM I get an error<br>complaining that <code>wasi_snapshot_preview1</code> is not defined. I knew what this meant<br>(the libc implementation needed a <a target="_blank" rel="noopener" href="https://wasi.dev/">WASI</a> module to implement<br>system calls), but I didn’t think I needed one, as I’m only using strings.</p>
<p>It turns out that the first thing <code>setlocale</code> does is check some environment<br>variables. To do that it needs some wasi functions to call out of the wasm<br>sandbox.</p>
<h2 id="Implementing-a-Minimal-WASI"><a href="#Implementing-a-Minimal-WASI" class="headerlink" title="Implementing a Minimal WASI"></a>Implementing a Minimal WASI</h2><p>After a consulting the <a target="_blank" rel="noopener" href="https://github.com/WebAssembly/WASI/blob/master/phases/snapshot/docs.md">WASI API documentation</a><br>I decided I needed to implement<br><a target="_blank" rel="noopener" href="https://github.com/WebAssembly/WASI/blob/master/phases/snapshot/docs.md#-environ_getenviron-pointerpointeru8-environ_buf-pointeru8---errno">environ_get</a><br>and it’s companion<br><a target="_blank" rel="noopener" href="https://github.com/WebAssembly/WASI/blob/master/phases/snapshot/docs.md#-environ_sizes_get---errno-size-size">environ_sizes_get</a>. I put these in a class called <code>Wasi</code><br>and passed them to the module on instantiation using the <code>wasi_snapshot_preview1</code><br>key as follows:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(buf, &#123;</span><br><span class="line">  <span class="attr">wasi_snapshot_preview1</span>: wasi,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Now when I ran the program I got no errors about <code>wasi_snapshot_preview1</code>, but I<br>get a new error saying that <code>proc_exit</code> was missing. I found that in the docs,<br>and it gets called to terminate the process. As I’ve got nothing to terminate<br>I created a stub for it. My <code>Wasi</code> class looks as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">WasiMemoryManager</span> = <span class="built_in">require</span>(<span class="string">&#x27;./wasi-memory-manager&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// An implementation of WASI which supports the minimum</span></span><br><span class="line"><span class="comment">// required to use multi byte characters.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Wasi</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (env) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">env</span> = env</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instance</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">wasiMemoryManager</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialise the instance from the WebAssembly.</span></span><br><span class="line">  init = <span class="function">(<span class="params">instance</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">instance</span> = instance</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">wasiMemoryManager</span> = <span class="keyword">new</span> <span class="title class_">WasiMemoryManager</span>(</span><br><span class="line">      instance.<span class="property">exports</span>.<span class="property">memory</span>,</span><br><span class="line">      instance.<span class="property">exports</span>.<span class="property">malloc</span>,</span><br><span class="line">      instance.<span class="property">exports</span>.<span class="property">free</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="variable constant_">WASI_ESUCCESS</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the environment variables.</span></span><br><span class="line">  environ_get = <span class="function">(<span class="params">environ, environBuf</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> encoder = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>()</span><br><span class="line">    <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(<span class="variable language_">this</span>.<span class="property">wasiMemoryManager</span>.<span class="property">memory</span>.<span class="property">buffer</span>)</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">entries</span>(<span class="variable language_">this</span>.<span class="property">env</span>).<span class="title function_">map</span>(</span><br><span class="line">      <span class="function">(<span class="params">[key, value]</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;key&#125;</span>=<span class="subst">$&#123;value&#125;</span>`</span></span><br><span class="line">    ).<span class="title function_">forEach</span>(<span class="function"><span class="params">envVar</span> =&gt;</span> &#123;</span><br><span class="line">      view.<span class="title function_">setUint32</span>(environ, environBuf, <span class="literal">true</span>)</span><br><span class="line">      environ += <span class="number">4</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> bytes = encoder.<span class="title function_">encode</span>(envVar)</span><br><span class="line">      <span class="keyword">const</span> buf = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="variable language_">this</span>.<span class="property">wasiMemoryManager</span>.<span class="property">memory</span>.<span class="property">buffer</span>, environBuf, bytes.<span class="property">length</span> + <span class="number">1</span>)</span><br><span class="line">      environBuf += buf.<span class="property">byteLength</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">WASI_ESUCCESS</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Get the size required to store the environment variables.</span></span><br><span class="line">  environ_sizes_get = <span class="function">(<span class="params">environCount, environBufSize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> encoder = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>()</span><br><span class="line">    <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">DataView</span>(<span class="variable language_">this</span>.<span class="property">wasiMemoryManager</span>.<span class="property">memory</span>.<span class="property">buffer</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> envVars = <span class="title class_">Object</span>.<span class="title function_">entries</span>(<span class="variable language_">this</span>.<span class="property">env</span>).<span class="title function_">map</span>(</span><br><span class="line">      <span class="function">(<span class="params">[key, value]</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;key&#125;</span>=<span class="subst">$&#123;value&#125;</span>`</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> size = envVars.<span class="title function_">reduce</span>(</span><br><span class="line">      <span class="function">(<span class="params">acc, envVar</span>) =&gt;</span> acc + encoder.<span class="title function_">encode</span>(envVar).<span class="property">byteLength</span> + <span class="number">1</span>,</span><br><span class="line">      <span class="number">0</span></span><br><span class="line">    )</span><br><span class="line">    view.<span class="title function_">setUint32</span>(environCount, envVars.<span class="property">length</span>, <span class="literal">true</span>)</span><br><span class="line">    view.<span class="title function_">setUint32</span>(environBufSize, size, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">WASI_ESUCCESS</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This gets called on exit to stop the running program.</span></span><br><span class="line">  <span class="comment">// We don&#x27;t have anything to stop!</span></span><br><span class="line">  proc_exit = <span class="function">(<span class="params">rval</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">WASI_ESUCCESS</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Wasi</span></span><br></pre></td></tr></table></figure>

<p>And to hook it all up I did the following.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Wasi</span> = <span class="built_in">require</span>(<span class="string">&#x27;./wasi&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">setupWasi</span>(<span class="params">fileName</span>) &#123;</span><br><span class="line">  <span class="comment">// Read the wasm file.</span></span><br><span class="line">  <span class="keyword">const</span> buf = fs.<span class="title function_">readFileSync</span>(fileName)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the Wasi instance passing in some environment variables.</span></span><br><span class="line">  <span class="keyword">const</span> wasi = <span class="keyword">new</span> <span class="title class_">Wasi</span>(&#123;</span><br><span class="line">    <span class="string">&quot;LANG&quot;</span>: <span class="string">&quot;en_GB.UTF-8&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TERM&quot;</span>: <span class="string">&quot;xterm&quot;</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Instantiate the wasm module.</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(buf, &#123;</span><br><span class="line">    <span class="attr">wasi_snapshot_preview1</span>: wasi,</span><br><span class="line">    <span class="attr">env</span>: &#123;</span><br><span class="line">      <span class="comment">// This function is exported to the web assembly.</span></span><br><span class="line">      <span class="attr">consoleLog</span>: <span class="keyword">function</span>(<span class="params">ptr, length</span>) &#123;</span><br><span class="line">        <span class="comment">// This converts the pointer to a string and frees he memory.</span></span><br><span class="line">        <span class="keyword">const</span> string = wasi.<span class="property">wasiMemoryManager</span>.<span class="title function_">convertToString</span>(ptr, length)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(string)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialise the wasi instance</span></span><br><span class="line">  wasi.<span class="title function_">init</span>(res.<span class="property">instance</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> wasi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = setupWasi</span><br></pre></td></tr></table></figure>

<h2 id="The-Example"><a href="#The-Example" class="headerlink" title="The Example"></a>The Example</h2><p>The last thing to do was write the example. Here it is:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> setupWasi = <span class="built_in">require</span>(<span class="string">&#x27;./setup-wasi&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Setup the WASI instance.</span></span><br><span class="line">  <span class="keyword">const</span> wasi = <span class="keyword">await</span> <span class="title function_">setupWasi</span>(<span class="string">&#x27;./string-example.wasm&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the functions exported from the WebAssembly</span></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    countLetters,</span><br><span class="line">    sayHelloWorld,</span><br><span class="line">    sayHelloWorldInMandarin</span><br><span class="line">  &#125; = wasi.<span class="property">instance</span>.<span class="property">exports</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> buf1 = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> s1 = <span class="string">&#x27;犬 means dog&#x27;</span></span><br><span class="line">    <span class="comment">// Convert the JavaScript string into a pointer in the WebAssembly</span></span><br><span class="line">    buf1 = wasi.<span class="property">wasiMemoryManager</span>.<span class="title function_">convertFromString</span>(s1)</span><br><span class="line">    <span class="comment">// The Chinese character will take up more than one byte.</span></span><br><span class="line">    <span class="keyword">const</span> l1 = <span class="title function_">countLetters</span>(buf1.<span class="property">byteOffset</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`expected length <span class="subst">$&#123;s1.length&#125;</span> got <span class="subst">$&#123;l1&#125;</span> byte length was <span class="subst">$&#123;buf1.byteLength&#125;</span>`</span>)</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// Free the pointer we created in WebAssembly.</span></span><br><span class="line">    wasi.<span class="property">wasiMemoryManager</span>.<span class="title function_">free</span>(buf1)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Should log &quot;Hello, World!&quot; to the console</span></span><br><span class="line">  <span class="title function_">sayHelloWorld</span>()</span><br><span class="line">  <span class="title function_">sayHelloWorldInMandarin</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">main</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Done&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>And it works! Here’s the output.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">expected length 11 got 11 byte length was 14</span><br><span class="line">Hello World</span><br><span class="line">你好，世界！</span><br><span class="line">Done</span><br></pre></td></tr></table></figure>

<h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>I realise node already has a WASI module, but I wanted to be able to<br>run the code in a browser. I would have preferred to use wasmer-js,<br>but I had problems getting it to work, and it felt like a bit of a<br>sledgehammer for the problem I was trying to solve.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2020/06/20/wasm-string-passing/" data-id="cma87l7g1000iwrjp0vi28g39" data-title="How to Pass Strings Between JavaScript and WebAssembly" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/C/" rel="tag">C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/clang/" rel="tag">clang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/libc/" rel="tag">libc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/strings/" rel="tag">strings</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm-libc/" rel="tag">wasm-libc</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-wasm-dataframe-libc" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2020/06/14/wasm-dataframe-libc/" class="article-date">
  <time class="dt-published" datetime="2020-06-14T10:38:00.000Z" itemprop="datePublished">2020-06-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/WebAssembly/">WebAssembly</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2020/06/14/wasm-dataframe-libc/">Using libc with WebAssembly enabled DataFrames</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Using-libc-with-WebAssembly-enabled-DataFrames"><a href="#Using-libc-with-WebAssembly-enabled-DataFrames" class="headerlink" title="Using libc with WebAssembly enabled DataFrames"></a>Using libc with WebAssembly enabled DataFrames</h1><p>This post describes how to use the C standard library with WebAssembly enabled<br>DataFrames. You can find the source code<br><a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/example-wasm-dataframe-2">here</a>.</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In my previous<br><a href="https://rob-blackbourn.github.io/blog/2020/06/13/wasm-dataframes/">post</a><br>I avoided solving the problem of linking to standard<br>library to provide memory allocation for my WebAssembly project by writing my<br>own memory allocator. In order to use external C packages I will need a<br>standard library.</p>
<h2 id="wsi-libc"><a href="#wsi-libc" class="headerlink" title="wsi-libc"></a>wsi-libc</h2><p>The <a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wasi-libc">wasi-libc</a> project does what it<br>says on the tin by providing a standard library for wasm.</p>
<p>I have changed my setup as my laptop required reinstallation. I’m now running<br>Ubuntu 20.04 LTS.</p>
<p>I installed the latest (version 10) LLVM tool chain as a Debian package which<br>I got from <a target="_blank" rel="noopener" href="https://apt.llvm.org/">this page</a>. I did the following.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://apt.llvm.org/llvm.sh</span><br><span class="line">sudo ./llvm.sh</span><br></pre></td></tr></table></figure>

<p>That installed clang et al with the suffix “-10”, such that clang could be<br>found as <code>/usr/bin/clang-10</code>.</p>
<p>I installed <a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wabt">wabt</a> in <code>/opt/wabt</code>.</p>
<p>I cloned the wasi-libc library and built it as follows.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@github.com:WebAssembly/wasi-libc.git</span><br><span class="line"><span class="built_in">cd</span> wasi-libc</span><br><span class="line">sudo WASM_CC=clang-10 WASM_NM=llvm-nm-10 WASM_AR=llvm-ar-10 INSTALL_DIR=/opt/wasi-libc make install</span><br></pre></td></tr></table></figure>

<h2 id="The-C-Source-Code"><a href="#The-C-Source-Code" class="headerlink" title="The C Source Code"></a>The C Source Code</h2><p>In my previous post I had two source files: <code>memory-allocation.c</code> and <code>array-methods.c</code>.<br>We can delete <code>memory-allocation.c</code> as we’ll use <code>malloc</code> and <code>free</code> from the<br>standard library. I split he array methods into two files: <code>array-methods-int.c</code><br>and <code>array-methods-double.c</code>, included <code>stdlib.h</code> and changed the memory allocation<br>to use the standard library.</p>
<p>Here is the start of <code>array-methods-int.c</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__((used)) <span class="type">int</span>* <span class="title function_">addInt32Arrays</span> <span class="params">(<span class="type">int</span> *array1, <span class="type">int</span>* array2, <span class="type">int</span> length)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span>* result = (<span class="type">int</span>*) <span class="built_in">malloc</span>(length * <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">    result[i] = array1[i] + array2[i];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then I changed the makefile as follows.</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">SYSROOT=/opt/wasi-libc</span><br><span class="line"></span><br><span class="line">LLVM_VERSION=10</span><br><span class="line">CC=clang-<span class="variable">$(LLVM_VERSION)</span></span><br><span class="line">LD=wasm-ld-<span class="variable">$(LLVM_VERSION)</span></span><br><span class="line">CFLAGS=--target=wasm32-unknown-unknown-wasm --optimize=3 --sysroot=<span class="variable">$(SYSROOT)</span></span><br><span class="line">LDFLAGS=--export-all --no-entry --allow-undefined -L<span class="variable">$(SYSROOT)</span>/lib/wasm32-wasi -lc -lm</span><br><span class="line"></span><br><span class="line">WASM2WAT=/opt/wabt/bin/wasm2wat</span><br><span class="line"></span><br><span class="line">sources = array-methods-int.c array-methods-double.c</span><br><span class="line">objects = $(sources:%.c=%.bc)</span><br><span class="line">target = data-frame</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: all</span></span><br><span class="line"></span><br><span class="line"><span class="section">all: <span class="variable">$(target)</span>.wat</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(target)</span>.wat: <span class="variable">$(target)</span>.wasm</span><br><span class="line">	<span class="variable">$(WASM2WAT)</span> <span class="variable">$(target)</span>.wasm -o <span class="variable">$(target)</span>.wat</span><br><span class="line"></span><br><span class="line"><span class="variable">$(target)</span>.wasm: <span class="variable">$(objects)</span></span><br><span class="line">	<span class="variable">$(LD)</span> <span class="variable">$(objects)</span> <span class="variable">$(LDFLAGS)</span> -o <span class="variable">$(target)</span>.wasm</span><br><span class="line">	</span><br><span class="line"><span class="section">%.bc: %.c</span></span><br><span class="line">	<span class="variable">$(CC)</span> -c -emit-llvm <span class="variable">$(CFLAGS)</span> <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -f <span class="variable">$(target)</span>.wasm</span><br><span class="line">	rm -f <span class="variable">$(target)</span>.wat</span><br><span class="line">	rm -f <span class="variable">$(objects)</span></span><br></pre></td></tr></table></figure>

<p>The compilation stage node sets <code>--sysroot</code>. This appears to set up the include<br>paths correctly.</p>
<p>The link stage adds the path to the libraries <code>-L$(SYSROOT)/lib/wasm32-wasi</code> and<br>and includes libc and libm <code>-lc -lm</code>.</p>
<h2 id="The-JavaScript-Code"><a href="#The-JavaScript-Code" class="headerlink" title="The JavaScript Code"></a>The JavaScript Code</h2><p>All I needed to do was to change the memory allocation imports to use <code>malloc</code> and <code>free</code>.</p>
<p>Everything just worked!</p>
<p>As a test I added a unary function <code>logFloat64Array</code>. This required sme minor<br>changes to the javascript to allow ‘int’ type series to fall through to the <code>double</code><br>methods. Again it all just worked.</p>
<h2 id="Things-To-Do"><a href="#Things-To-Do" class="headerlink" title="Things To Do"></a>Things To Do</h2><p>I need to understand what the <code>crt1.o</code> file is all about. I tried to link, but<br>that gives me other errors.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2020/06/14/wasm-dataframe-libc/" data-id="cma87l7g00006wrjp9m1v9zq1" data-title="Using libc with WebAssembly enabled DataFrames" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/C/" rel="tag">C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/DataFrame/" rel="tag">DataFrame</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/array/" rel="tag">array</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/arrays/" rel="tag">arrays</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/clang/" rel="tag">clang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/libc/" rel="tag">libc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm-libc/" rel="tag">wasm-libc</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-datascience-javascript" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2020/06/13/datascience-javascript/" class="article-date">
  <time class="dt-published" datetime="2020-06-13T13:57:00.000Z" itemprop="datePublished">2020-06-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/WebAssembly/">WebAssembly</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2020/06/13/datascience-javascript/">The future of Data Science is JavaScript and WebAssembly</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>In my previous posts<br><a href="https://rob-blackbourn.github.io/blog/2020/06/07/wasm-arrays/">[1]</a><br><a href="https://rob-blackbourn.github.io/blog/2020/06/10/simplifyinf-memory-management/">[2]</a><br><a href="https://rob-blackbourn.github.io/blog/2020/06/10/example-js-dataframe/">[3]</a><br><a href="https://rob-blackbourn.github.io/blog/2020/06/13/wasm-dataframes/">[4]</a><br>I demonstrated how to write a simple <a target="_blank" rel="noopener" href="https://pandas.pydata.org/">pandas</a>-style<br>data frame in JavaScript using <a target="_blank" rel="noopener" href="https://webassembly.org/">WebAssembly</a> (a near<br>native speed virtual machine available in every modern browser or server-side<br>engine such as <a target="_blank" rel="noopener" href="https://nodejs.org/en/">nodejs</a>).<br>This demonstrated the following features:</p>
<ul>
<li><p>Elegant Syntax</p>
<p>Expressions can be written in the following manner.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> df = <span class="title class_">DataFrame</span>.<span class="title function_">fromObject</span>(</span><br><span class="line">  [</span><br><span class="line">    &#123; <span class="attr">col0</span>: <span class="string">&#x27;a&#x27;</span>, <span class="attr">col1</span>: <span class="number">5</span>, <span class="attr">col2</span>: <span class="number">8.1</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">col0</span>: <span class="string">&#x27;b&#x27;</span>, <span class="attr">col1</span>: <span class="number">6</span>, <span class="attr">col2</span>: <span class="number">3.2</span> &#125;</span><br><span class="line">  ],</span><br><span class="line">  &#123; <span class="attr">col0</span>: <span class="string">&#x27;object&#x27;</span>, <span class="attr">col1</span>: <span class="string">&#x27;int&#x27;</span>, <span class="attr">col2</span>: <span class="string">&#x27;double&#x27;</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">df[<span class="string">&#x27;col3&#x27;</span>] = df[<span class="string">&#x27;col1&#x27;</span>] + df[<span class="string">&#x27;col2&#x27;</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Near native speed.</p>
<p>All operations are written in C and are performed in a compiled WebAssembly<br>module.</p>
</li>
<li><p>Portable.</p>
<p>The code runs in <strong>any</strong> browser or server side JavaScript engine (e.g.<br>chrome, nodejs, etc.).</p>
</li>
<li><p>Uses standard tooling.</p>
<p>The C code was compiled with the current standard<br><a target="_blank" rel="noopener" href="https://clang.llvm.org/">clang</a><br>compiler which supports WebAssembly<br><a target="_blank" rel="noopener" href="https://lld.llvm.org/WebAssembly.html">out of the box</a>.</p>
</li>
</ul>
<h2 id="The-Future-of-Data-Science"><a href="#The-Future-of-Data-Science" class="headerlink" title="The Future of Data Science?"></a>The Future of Data Science?</h2><p>Clearly this is a bold claim!</p>
<p>There are currently two clear platform leaders in the data science eco-system:<br><a target="_blank" rel="noopener" href="https://cran.r-project.org/">R</a>,<br>and <a target="_blank" rel="noopener" href="https://www.python.org/">Python</a><br>using the <a target="_blank" rel="noopener" href="https://www.scipy.org/">scipy</a> toolkit,<br>and also a number of attractive outsiders. The choice of which platform to<br>choose typically depends on language preference, but more compellingly what<br>packages a particular language&#x2F;version provides. It is not unusual for a project<br>to be constrained to a legacy version of a platform simply because a key package<br>has not been ported to a current version.</p>
<p>So how can JavaScript and WebAssembly help?</p>
<h3 id="Elegant-Syntax"><a href="#Elegant-Syntax" class="headerlink" title="Elegant Syntax"></a>Elegant Syntax</h3><p>Surprisingly, yes! The posts referenced above clearly demonstrate how JavaScript<br>can be written in a manner which elegantly represents vector-arithmetic.</p>
<h3 id="Speed"><a href="#Speed" class="headerlink" title="Speed"></a>Speed</h3><p>With WebAssembly there is no significant compromise in speed over natively<br>compiled languages.</p>
<h3 id="Bindings"><a href="#Bindings" class="headerlink" title="Bindings"></a>Bindings</h3><p>With other languages a <em>binding</em> must be written to integrate a package<br>into the language. In many cases this is <strong>completely</strong> unnecessary for<br>WebAssembly.</p>
<h3 id="Fortran"><a href="#Fortran" class="headerlink" title="Fortran"></a>Fortran</h3><p>In my opinion this is the killer advantage. There are a huge number of key data<br>science libraries implemented in many different flavours of Fortran. Binding to<br>these libraries is an ongoing and fraught task.</p>
<p>Happily <a target="_blank" rel="noopener" href="https://llvm.org/">LLVM</a> (a language compiler supported by the majority<br>of operating systems) is currently incorporating<br><a target="_blank" rel="noopener" href="https://github.com/flang-compiler/flang">flang</a><br>(a Fortran compiler) into it’s toolchain, supporting <strong>all</strong> versions of Fortran<br>up to and including 2018. This provides the possibility of compiling <strong>any</strong><br>Fortran package directly to WebAssembly.</p>
<h2 id="The-Catch"><a href="#The-Catch" class="headerlink" title="The Catch"></a>The Catch</h2><p>The first catch is operator overloading. I’m not sure if “catch” is the right<br>word. My solution using the <a target="_blank" rel="noopener" href="https://babeljs.io/">babel</a> transpiler works fine,<br>and transpiling is how <a target="_blank" rel="noopener" href="https://reactjs.org/">React</a> (one of the most popular web<br>frameworks, which uses custom syntax in JavaScript) does and will always work.<br>There is a <a target="_blank" rel="noopener" href="https://github.com/tc39/proposal-operator-overloading">proposal</a><br>to incorporate operator overloading into JavaScript (currently at stage 1 where<br>3 means acceptance), which leads me to believe it is a feature which my become<br>native to the language.</p>
<p>The second catch is the standard library. You’ll note if you’ve read the<br>previous posts that I had to provide a memory allocator as this is not available<br>in the WebAssembly environment. WebAssembly is just a virtual machine, and at<br>present it doesn’t come with the usual support code which most libraries depend<br>on. This is all being built out at the present in the form of<br><a target="_blank" rel="noopener" href="https://wasi.dev/">wasi</a>, but it’s not here yet.</p>
<p>Lastly flang isn’t in the current stable release of LLVM. It was<br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=yenZorebMOA">incorporated in the repo in November 2019</a>,<br>and I would expect it to be in the next major release.</p>
<h2 id="Do-I-Want-to-Write-in-JavaScript"><a href="#Do-I-Want-to-Write-in-JavaScript" class="headerlink" title="Do I Want to Write in JavaScript?"></a>Do I Want to Write in JavaScript?</h2><p>Personally I don’t care what language I write in, as long as it doesn’t get in<br>the way of the problem I’m trying to solve. Because of the low cost of entry,<br>JavaScript has become ubiquitous, and so it’s level of documentation and support<br>is huge, which I like.</p>
<p>If it provides seamless access to the packages I need I’m a buyer.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2020/06/13/datascience-javascript/" data-id="cma87l7g00005wrjpenne5bfs" data-title="The future of Data Science is JavaScript and WebAssembly" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/C/" rel="tag">C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/DataFrame/" rel="tag">DataFrame</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/array/" rel="tag">array</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/arrays/" rel="tag">arrays</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/data/" rel="tag">data</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/datascience/" rel="tag">datascience</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/science/" rel="tag">science</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-wasm-dataframes" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2020/06/13/wasm-dataframes/" class="article-date">
  <time class="dt-published" datetime="2020-06-13T11:41:00.000Z" itemprop="datePublished">2020-06-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/WebAssembly/">WebAssembly</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2020/06/13/wasm-dataframes/">Implementing DataFrames in JavaScript with Calculations in WebAssembly</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>This post describes a simple pandas style DataFrame implementation with the<br>array calculations performed in JavaScript.</p>
<p>The code for this post can be found <a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/example-wasm-dataframe-1">here</a>.</p>
<h2 id="The-DataFrame-and-Series-Implementations"><a href="#The-DataFrame-and-Series-Implementations" class="headerlink" title="The DataFrame and Series Implementations"></a>The DataFrame and Series Implementations</h2><p>The series and data frame implementations are taken from my<br><a href="https://rob-blackbourn.github.io/blog/2020/06/10/example-js-dataframe/">previous post</a><br>with minor modifications.</p>
<h3 id="Type-awareness"><a href="#Type-awareness" class="headerlink" title="Type awareness"></a>Type awareness</h3><p>The series (and therefore the data frame) will need to be aware of the type of<br>data they contain. For simplicity I have limited the types to:</p>
<ul>
<li><code>&#39;int&#39;</code></li>
<li><code>&#39;double&#39;</code></li>
<li><code>&#39;object&#39;</code></li>
</ul>
<p>A series is constructed as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> s1 = <span class="keyword">new</span> <span class="title class_">Series</span>(<span class="string">&#x27;height&#x27;</span>, [<span class="number">1.82</span>, <span class="number">1.73</span>, <span class="number">1.69</span>, <span class="number">1.92</span>], <span class="string">&#x27;double&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>The code for the series now looks like this.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> arrayMethods <span class="keyword">from</span> <span class="string">&#x27;./array-methods&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Series</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (name, array, type) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">array</span> = array</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">type</span> = type</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="variable language_">this</span>, &#123;</span><br><span class="line">      <span class="attr">get</span>: <span class="function">(<span class="params">obj, prop, receiver</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">          <span class="comment">// This is a known property: i.e. name, array or type.</span></span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(obj, prop, receiver)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (arrayMethods.<span class="title function_">has</span>(prop)) &#123;</span><br><span class="line">          <span class="comment">// The property is an operator.</span></span><br><span class="line">          <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> <span class="keyword">new</span> <span class="title class_">Series</span>(<span class="string">&#x27;&#x27;</span>, ...arrayMethods.<span class="title function_">get</span>(prop)(obj, ...args))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// The property requested is passed to the array.</span></span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(obj.<span class="property">array</span>, prop, receiver.<span class="property">array</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">set</span>: <span class="function">(<span class="params">obj, prop, value, receiver</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(obj, prop, value, receiver)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(obj.<span class="property">array</span>, prop, value, receiver.<span class="property">array</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">apply</span>: <span class="function">(<span class="params">target, thisArgument, argumentList</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(target, thisArgument, argumentList)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// construct: Reflect.construct,</span></span><br><span class="line">      <span class="attr">defineProperty</span>: <span class="title class_">Reflect</span>.<span class="property">defineProperty</span>,</span><br><span class="line">      <span class="attr">getOwnPropertyDescriptor</span>: <span class="title class_">Reflect</span>.<span class="property">getOwnPropertyDescriptor</span>,</span><br><span class="line">      <span class="attr">deleteProperty</span>: <span class="title class_">Reflect</span>.<span class="property">deleteProperty</span>,</span><br><span class="line">      <span class="attr">getPrototypeOf</span>: <span class="title class_">Reflect</span>.<span class="property">getPrototypeOf</span>,</span><br><span class="line">      <span class="attr">setPrototypeOf</span>: <span class="title class_">Reflect</span>.<span class="property">setPrototypeOf</span>,</span><br><span class="line">      <span class="attr">isExtensible</span>: <span class="title class_">Reflect</span>.<span class="property">isExtensible</span>,</span><br><span class="line">      <span class="attr">preventExtensions</span>: <span class="title class_">Reflect</span>.<span class="property">preventExtensions</span>,</span><br><span class="line">      <span class="attr">has</span>: <span class="title class_">Reflect</span>.<span class="property">has</span>,</span><br><span class="line">      <span class="attr">ownKeys</span>: <span class="title class_">Reflect</span>.<span class="property">ownKeys</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  toString () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`(<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>;<span class="subst">$&#123;<span class="variable language_">this</span>.type&#125;</span>): <span class="subst">$&#123;<span class="variable language_">this</span>.array.join(<span class="string">&#x27;, &#x27;</span>)&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Comparing this to the<br><a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/example-js-dataframe/blob/master/src/Series.js">previous implementation</a><br>we can see three changes (plus a minor change to <code>toString</code>).</p>
<p>The constructor takes in an extra <code>type</code> parameter.</p>
<p>The operations are no longer defined in the class; they are now provided by the <code>array-methods</code> module.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> arrayMethods <span class="keyword">from</span> <span class="string">&#x27;./array-methods&#x27;</span></span><br></pre></td></tr></table></figure>

<p>The last change is to modify the way the proxy finds the operator methods with <code>arrayMethods.has(prop)</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="variable language_">this</span>, &#123;</span><br><span class="line">  <span class="attr">get</span>: <span class="function">(<span class="params">obj, prop, receiver</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(obj, prop, receiver)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (arrayMethods.<span class="title function_">has</span>(prop)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> <span class="keyword">new</span> <span class="title class_">Series</span>(<span class="string">&#x27;&#x27;</span>, ...arrayMethods.<span class="title function_">get</span>(prop)(obj, ...args))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(obj.<span class="property">array</span>, prop, receiver.<span class="property">array</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here is the implementation of the DataFrame.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Series</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./Series&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DataFrame</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (series) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">series</span> = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> series) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">series</span>[item.<span class="property">name</span>] = item</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="variable language_">this</span>, &#123;</span><br><span class="line">      <span class="attr">get</span>: <span class="function">(<span class="params">obj, prop, receiver</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> prop <span class="keyword">in</span> obj ? <span class="title class_">Reflect</span>.<span class="title function_">get</span>(obj, prop, receiver) : <span class="title class_">Reflect</span>.<span class="title function_">get</span>(obj.<span class="property">series</span>, prop, receiver.<span class="property">series</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">set</span>: <span class="function">(<span class="params">obj, prop, value, receiver</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">          <span class="title class_">Reflect</span>.<span class="title function_">set</span>(obj, prop, value, receiver)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          value.<span class="property">name</span> = prop</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(obj.<span class="property">series</span>, prop, value, receiver.<span class="property">series</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">apply</span>: <span class="function">(<span class="params">target, thisArgument, argumentList</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> target <span class="keyword">in</span> thisArgument ? <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(target, thisArgument, argumentList) : <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(target, thisArgument.<span class="property">array</span>, argumentList)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">defineProperty</span>: <span class="title class_">Reflect</span>.<span class="property">defineProperty</span>,</span><br><span class="line">      <span class="attr">getOwnPropertyDescriptor</span>: <span class="title class_">Reflect</span>.<span class="property">getOwnPropertyDescriptor</span>,</span><br><span class="line">      <span class="attr">deleteProperty</span>: <span class="title class_">Reflect</span>.<span class="property">deleteProperty</span>,</span><br><span class="line">      <span class="attr">getPrototypeOf</span>: <span class="title class_">Reflect</span>.<span class="property">getPrototypeOf</span>,</span><br><span class="line">      <span class="attr">setPrototypeOf</span>: <span class="title class_">Reflect</span>.<span class="property">setPrototypeOf</span>,</span><br><span class="line">      <span class="attr">isExtensible</span>: <span class="title class_">Reflect</span>.<span class="property">isExtensible</span>,</span><br><span class="line">      <span class="attr">preventExtensions</span>: <span class="title class_">Reflect</span>.<span class="property">preventExtensions</span>,</span><br><span class="line">      <span class="attr">has</span>: <span class="title class_">Reflect</span>.<span class="property">has</span>,</span><br><span class="line">      <span class="attr">ownKeys</span>: <span class="title class_">Reflect</span>.<span class="property">ownKeys</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> fromObject (data, types) &#123;</span><br><span class="line">    <span class="keyword">const</span> series = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> column <span class="keyword">in</span> data[i]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(column <span class="keyword">in</span> series)) &#123;</span><br><span class="line">          series[column] = <span class="keyword">new</span> <span class="title class_">Series</span>(column, <span class="keyword">new</span> <span class="title class_">Array</span>(data.<span class="property">length</span>), types[column])</span><br><span class="line">        &#125;</span><br><span class="line">        series[column][i] = data[i][column]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> seriesList = <span class="title class_">Object</span>.<span class="title function_">values</span>(series)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataFrame</span>(seriesList)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  toString () &#123;</span><br><span class="line">    <span class="keyword">const</span> columns = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyNames</span>(<span class="variable language_">this</span>.<span class="property">series</span>)</span><br><span class="line">    <span class="keyword">let</span> s = columns.<span class="title function_">join</span>(<span class="string">&#x27;, &#x27;</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="keyword">const</span> maxLength = <span class="title class_">Object</span>.<span class="title function_">values</span>(<span class="variable language_">this</span>.<span class="property">series</span>)</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="property">length</span>)</span><br><span class="line">      .<span class="title function_">reduce</span>(<span class="function">(<span class="params">accumulator, currentValue</span>) =&gt;</span> <span class="title class_">Math</span>.<span class="title function_">max</span>(accumulator, currentValue), <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; maxLength; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> row = []</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> column <span class="keyword">of</span> columns) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="variable language_">this</span>.<span class="property">series</span>[column].<span class="property">length</span>) &#123;</span><br><span class="line">          row.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">series</span>[column][i])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          row.<span class="title function_">push</span>(<span class="literal">null</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      s += row.<span class="title function_">join</span>(<span class="string">&#x27;, &#x27;</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    s += columns.<span class="title function_">map</span>(<span class="function"><span class="params">column</span> =&gt;</span> <span class="variable language_">this</span>.<span class="property">series</span>[column].<span class="property">type</span>).<span class="title function_">join</span>(<span class="string">&#x27;, &#x27;</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The only changes are in the <code>fromObject</code> helper method which takes an extra<br>argument for the types and the <code>toString</code> to print the types. A DataFrame is now constructed as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> df = <span class="title class_">DataFrame</span>.<span class="title function_">fromObject</span>(</span><br><span class="line">  [</span><br><span class="line">    &#123; <span class="attr">col0</span>: <span class="string">&#x27;a&#x27;</span>, <span class="attr">col1</span>: <span class="number">5</span>, <span class="attr">col2</span>: <span class="number">8.1</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">col0</span>: <span class="string">&#x27;b&#x27;</span>, <span class="attr">col1</span>: <span class="number">6</span>, <span class="attr">col2</span>: <span class="number">3.2</span> &#125;</span><br><span class="line">  ],</span><br><span class="line">  &#123; <span class="attr">col0</span>: <span class="string">&#x27;object&#x27;</span>, <span class="attr">col1</span>: <span class="string">&#x27;int&#x27;</span>, <span class="attr">col2</span>: <span class="string">&#x27;double&#x27;</span>&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="Array-Methods"><a href="#Array-Methods" class="headerlink" title="Array Methods"></a>Array Methods</h2><p>A new file has been added to create an <code>ArrayMethods</code> singleton. This is used<br>as a central store of array methods.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ArrayMethods</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> () &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">ArrayMethods</span>.<span class="property">instance</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_methods</span> = &#123;&#125;</span><br><span class="line">      <span class="title class_">ArrayMethods</span>.<span class="property">instance</span> = <span class="variable language_">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">ArrayMethods</span>.<span class="property">instance</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  set (name, method) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_methods</span>[name] = method</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  has (name) &#123;</span><br><span class="line">    <span class="keyword">return</span> name <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">_methods</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  get (name) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_methods</span>[name]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> instance = <span class="keyword">new</span> <span class="title class_">ArrayMethods</span>()</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">freeze</span>(instance)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> instance</span><br></pre></td></tr></table></figure>

<h2 id="The-WebAssembly-Calculations"><a href="#The-WebAssembly-Calculations" class="headerlink" title="The WebAssembly Calculations"></a>The WebAssembly Calculations</h2><p>The calculations have been written in C following the methods describe in<br><a href="https://rob-blackbourn.github.io/blog/2020/06/07/wasm-arrays/">this post</a>,<br>and <a href="https://rob-blackbourn.github.io/blog/2020/06/10/simplifyinf-memory-management/">this post</a>.</p>
<p>Here is the code for addition.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((used)) <span class="type">int</span>* <span class="title function_">addInt32Arrays</span> <span class="params">(<span class="type">int</span> *array1, <span class="type">int</span>* array2, <span class="type">int</span> length)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span>* result = (<span class="type">int</span>*) allocateMemory(length * <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">    result[i] = array1[i] + array2[i];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((used)) <span class="type">double</span>* <span class="title function_">addFloat64Arrays</span> <span class="params">(<span class="type">double</span>* array1, <span class="type">double</span>* array2, <span class="type">int</span> length)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">double</span>* result = (<span class="type">double</span>*) allocateMemory(length * <span class="keyword">sizeof</span>(<span class="type">double</span>));</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">    result[i] = array1[i] + array2[i];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note how we need one function for integers and another for doubles.</p>
<p>There is a makefile to build the wasm.</p>
<h2 id="Marshalling-JavaScript-to-WebAssembly"><a href="#Marshalling-JavaScript-to-WebAssembly" class="headerlink" title="Marshalling JavaScript to WebAssembly"></a>Marshalling JavaScript to WebAssembly</h2><p>I have tidied up the marshalling between JavaScript and WebAssembly. I created<br>a class to manage the wasm functions.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">WasmFunctionManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (memory, allocateMemory, freeMemory) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">memory</span> = memory</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">allocateMemory</span> = allocateMemory</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">freeMemory</span> = freeMemory</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  createTypedArray (typedArrayType, length) &#123;</span><br><span class="line">    <span class="keyword">const</span> typedArray = <span class="keyword">new</span> <span class="title function_">typedArrayType</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">memory</span>.<span class="property">buffer</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">allocateMemory</span>(length * typedArrayType.<span class="property">BYTES_PER_ELEMENT</span>),</span><br><span class="line">      length)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (typedArray.<span class="property">byteOffset</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RangeError</span>(<span class="string">&#x27;Unable to allocate memory for typed array&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> typedArray</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">invokeUnaryFunction</span>(<span class="params">func, array, typedArrayType</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> input = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> output = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      input = <span class="variable language_">this</span>.<span class="title function_">createTypedArray</span>(typedArrayType, array.<span class="property">length</span>)</span><br><span class="line">      input.<span class="title function_">set</span>(array)</span><br><span class="line"></span><br><span class="line">      output = <span class="keyword">new</span> <span class="title function_">typedArrayType</span>(</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">memory</span>.<span class="property">buffer</span>,</span><br><span class="line">        <span class="title function_">func</span>(input.<span class="property">byteOffset</span>, array.<span class="property">length</span>),</span><br><span class="line">        array.<span class="property">length</span></span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (output.<span class="property">byteOffset</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RangeError</span>(<span class="string">&#x27;Failed to allocate memory&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> result = <span class="title class_">Array</span>.<span class="title function_">from</span>(output)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// Ensure the memory gets freed.</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">freeMemory</span>(input.<span class="property">byteOffset</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">freeMemory</span>(output.<span class="property">byteOffset</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">invokeBinaryFunction</span>(<span class="params">func, lhs, rhs, typedArrayType</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (lhs.<span class="property">length</span> !== rhs.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RangeError</span>(<span class="string">&#x27;Arrays must the the same length&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> length = lhs.<span class="property">length</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> input1 = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> input2 = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> output = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      input1 = <span class="variable language_">this</span>.<span class="title function_">createTypedArray</span>(typedArrayType, length)</span><br><span class="line">      input2 = <span class="variable language_">this</span>.<span class="title function_">createTypedArray</span>(typedArrayType, length)</span><br><span class="line"></span><br><span class="line">      input1.<span class="title function_">set</span>(lhs)</span><br><span class="line">      input2.<span class="title function_">set</span>(rhs)</span><br><span class="line"></span><br><span class="line">      output = <span class="keyword">new</span> <span class="title function_">typedArrayType</span>(</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">memory</span>.<span class="property">buffer</span>,</span><br><span class="line">        <span class="title function_">func</span>(input1.<span class="property">byteOffset</span>, input2.<span class="property">byteOffset</span>, length),</span><br><span class="line">        length</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (output.<span class="property">byteOffset</span> === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RangeError</span>(<span class="string">&#x27;Failed to allocate memory&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> result = <span class="title class_">Array</span>.<span class="title function_">from</span>(output)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// Ensure the memory gets freed.</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">freeMemory</span>(input1.<span class="property">byteOffset</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">freeMemory</span>(input2.<span class="property">byteOffset</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">freeMemory</span>(output.<span class="property">byteOffset</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This follows the ideas presented in the previous posts, but adds some error<br>checking, and a <code>try ... finally</code> clause to prevent memory leaks.</p>
<h2 id="Setting-up-the-operators"><a href="#Setting-up-the-operators" class="headerlink" title="Setting up the operators"></a>Setting up the operators</h2><p>To set up the operators we first need to decide whether to use the <code>&#39;int&#39;</code>,<br><code>&#39;double&#39;</code> or <code>&#39;object&#39;</code> functions.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">chooseBestType</span>(<span class="params">lhsType, rhsType</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (lhsType === <span class="string">&#x27;int&#x27;</span> &amp;&amp; rhsType == <span class="string">&#x27;int&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;int&#x27;</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    (lhsType === <span class="string">&#x27;int&#x27;</span> &amp;&amp; rhsType === <span class="string">&#x27;double&#x27;</span>) ||</span><br><span class="line">    (lhsType === <span class="string">&#x27;double&#x27;</span> &amp;&amp; rhsType === <span class="string">&#x27;int&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;double&#x27;</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;object&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Once we have chosen the type we need to build a wrapper function to invoke the<br>appropriate method. Here is the helper that makes a binary operation.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">makeBinaryOperation</span>(<span class="params">wasmFunctionManager, intFunc, doubleFunc, defaultFunc</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">lhs, rhs</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> bestType = <span class="title function_">chooseBestType</span>(lhs.<span class="property">type</span>, rhs.<span class="property">type</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bestType === <span class="string">&#x27;int&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> result =  wasmFunctionManager.<span class="title function_">invokeBinaryFunction</span>(</span><br><span class="line">        intFunc,</span><br><span class="line">        lhs.<span class="property">array</span>,</span><br><span class="line">        rhs.<span class="property">array</span>,</span><br><span class="line">        <span class="title class_">Int32Array</span></span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">return</span> [result, bestType]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bestType === <span class="string">&#x27;double&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> result = wasmFunctionManager.<span class="title function_">invokeBinaryFunction</span>(</span><br><span class="line">        doubleFunc,</span><br><span class="line">        lhs.<span class="property">array</span>,</span><br><span class="line">        rhs.<span class="property">array</span>,</span><br><span class="line">        <span class="title class_">Float64Array</span></span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">return</span> [result, bestType]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="title function_">defaultFunc</span>(lhs, rhs)</span><br><span class="line">      <span class="keyword">return</span> [result, bestType]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Lastly we create the wasm instance and register the types. Here is an edited version which demonstrates registering the addition operator.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">setupWasm</span> () &#123;</span><br><span class="line">  <span class="comment">// Read the wasm file.</span></span><br><span class="line">  <span class="keyword">const</span> buf = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./src-wasm/data-frame.wasm&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Instantiate the wasm module.</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(buf, &#123;&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the memory exports from the wasm instance.</span></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    memory,</span><br><span class="line">    allocateMemory,</span><br><span class="line">    freeMemory,</span><br><span class="line"></span><br><span class="line">    addInt32Arrays,</span><br><span class="line">    addFloat64Arrays,</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// .. import the rest of the methods</span></span><br><span class="line">  &#125; = res.<span class="property">instance</span>.<span class="property">exports</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> wasmFunctionManager = <span class="keyword">new</span> <span class="title class_">WasmFunctionManager</span>(memory, allocateMemory, freeMemory)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Register the add method.</span></span><br><span class="line">  arrayMethods.<span class="title function_">set</span>(</span><br><span class="line">    <span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&#x27;+&#x27;</span>),</span><br><span class="line">    <span class="title function_">makeBinaryOperation</span>(</span><br><span class="line">      wasmFunctionManager,</span><br><span class="line">      addInt32Arrays,</span><br><span class="line">      addFloat64Arrays,</span><br><span class="line">      <span class="function">(<span class="params">lhs, rhs</span>) =&gt;</span> lhs.<span class="property">array</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">value, index</span>) =&gt;</span> value + rhs.<span class="property">array</span>[index])</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// register the rest of the methods ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Running-the-code"><a href="#Running-the-code" class="headerlink" title="Running the code"></a>Running the code</h2><p>We can run the code as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DataFrame</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./DataFrame&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; setupWasm &#125; <span class="keyword">from</span> <span class="string">&#x27;./setup-wasm&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">example</span> () &#123;</span><br><span class="line">  <span class="string">&#x27;operator-overloading enabled&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> df = <span class="title class_">DataFrame</span>.<span class="title function_">fromObject</span>(</span><br><span class="line">    [</span><br><span class="line">      &#123; <span class="attr">col0</span>: <span class="string">&#x27;a&#x27;</span>, <span class="attr">col1</span>: <span class="number">5</span>, <span class="attr">col2</span>: <span class="number">8.1</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">col0</span>: <span class="string">&#x27;b&#x27;</span>, <span class="attr">col1</span>: <span class="number">6</span>, <span class="attr">col2</span>: <span class="number">3.2</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">    &#123; <span class="attr">col0</span>: <span class="string">&#x27;object&#x27;</span>, <span class="attr">col1</span>: <span class="string">&#x27;int&#x27;</span>, <span class="attr">col2</span>: <span class="string">&#x27;double&#x27;</span>&#125;</span><br><span class="line">  )</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(df.<span class="title function_">toString</span>())</span><br><span class="line">  df[<span class="string">&#x27;col3&#x27;</span>] = df[<span class="string">&#x27;col1&#x27;</span>] + df[<span class="string">&#x27;col2&#x27;</span>]</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(df.<span class="title function_">toString</span>())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span> () &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">setupWasm</span>()</span><br><span class="line"></span><br><span class="line">  <span class="title function_">example</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run the async main function.</span></span><br><span class="line"><span class="title function_">main</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Done&#x27;</span>)).<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(error))</span><br></pre></td></tr></table></figure>

<h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>Clearly the DataFrame needs a lot of work. There is no concept of grouping,<br>indices, dates and times, etc. However we have a working proof on concept that provides a syntactically elegant and efficient implementation.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2020/06/13/wasm-dataframes/" data-id="cma87l7g00008wrjpacf892ko" data-title="Implementing DataFrames in JavaScript with Calculations in WebAssembly" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/C/" rel="tag">C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/DataFrame/" rel="tag">DataFrame</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/array/" rel="tag">array</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/arrays/" rel="tag">arrays</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-simplifyinf-memory-management" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2020/06/10/simplifyinf-memory-management/" class="article-date">
  <time class="dt-published" datetime="2020-06-10T14:12:00.000Z" itemprop="datePublished">2020-06-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/WebAssembly/">WebAssembly</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2020/06/10/simplifyinf-memory-management/">Simplifying WebAssembly C Memory Management by Using Clang Builtin&#39;s</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Following on from my<br><a href="https://rob-blackbourn.github.io/blog/2020/06/07/wasm-arrays/">previous post</a><br>regarding passing arrays between JavaScript<br>and WebAssembly, I have found out how to remove the need to call back into JavaScript</p>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>These examples have been tested with <a target="_blank" rel="noopener" href="https://nodejs.org/">nodejs v12.9.1</a>,<br><a target="_blank" rel="noopener" href="https://clang.llvm.org/">clang 10.0.0</a>,<br>and <a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wabt">wabt 1.0.16</a> on Ubuntu 18.04.</p>
<p>I installed <code>clang</code> in <code>/opt/clang</code>, <code>wabt</code> in <code>/opt/wabt</code>, and I use<br><a target="_blank" rel="noopener" href="https://github.com/nodenv/nodenv">nodenv</a> to manage my <code>nodejs</code> environment.</p>
<p>Update your path.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/opt/clang/bin:/opt/wabt/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<h2 id="What-was-the-problem"><a href="#What-was-the-problem" class="headerlink" title="What was the problem?"></a>What was the problem?</h2><p>In order to find the size of the memory and grow it, I was having to import<br>functions from JavaScript. I now find there are two built in functions that<br>do exactly what I want:</p>
<ul>
<li>__builtin_wasm_memory_size(0)</li>
<li>__builtin_wasm_memory_grow(0, blocks)</li>
</ul>
<p>This means my <code>growMoreMemory</code> function now looks like this.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BLKSIZ 65536</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">header_t</span>* <span class="title function_">getMoreMemory</span><span class="params">(<span class="type">unsigned</span> bytes_required)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// We need to add the header to the bytes required.</span></span><br><span class="line">  bytes_required += <span class="keyword">sizeof</span>(<span class="type">header_t</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The memory gets delivered in blocks. Ensure we get enough.</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> blocks = bytes_required / BLKSIZ;</span><br><span class="line">  <span class="keyword">if</span> (blocks * BLKSIZ &lt; bytes_required)</span><br><span class="line">    blocks += <span class="number">1</span>;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> start_of_new_memory = __builtin_wasm_memory_size(<span class="number">0</span>) * BLKSIZ;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__builtin_wasm_memory_grow(<span class="number">0</span>, blocks) == <span class="number">-1</span>)</span><br><span class="line">  	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">long</span> end_of_new_memory = __builtin_wasm_memory_size(<span class="number">0</span>) * BLKSIZ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the block to insert.</span></span><br><span class="line">  <span class="type">header_t</span>* block_to_insert = (<span class="type">header_t</span> *) start_of_new_memory;</span><br><span class="line">  block_to_insert-&gt;value.size = end_of_new_memory - start_of_new_memory - <span class="keyword">sizeof</span>(<span class="type">header_t</span>);</span><br><span class="line">  block_to_insert-&gt;value.next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add to the free list</span></span><br><span class="line">  freeMemory((<span class="type">void</span> *) (block_to_insert + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> free_list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="The-code"><a href="#The-code" class="headerlink" title="The code"></a>The code</h2><p>You can find the code <a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/example-wasm-array-passing-2">here</a>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2020/06/10/simplifyinf-memory-management/" data-id="cma87l7fy0001wrjp0pybewtw" data-title="Simplifying WebAssembly C Memory Management by Using Clang Builtin&#39;s" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/clang/" rel="tag">clang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/malloc/" rel="tag">malloc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/memory/" rel="tag">memory</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-example-js-dataframe" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2020/06/10/example-js-dataframe/" class="article-date">
  <time class="dt-published" datetime="2020-06-10T14:12:00.000Z" itemprop="datePublished">2020-06-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/WebAssembly/">WebAssembly</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2020/06/10/example-js-dataframe/">An example of a pandas style DataFrame in JavaScript</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>This post describes an example implementation of a pandas style DataFrame. See<br><a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/example-js-dataframe">here</a> for the source<br>code.</p>
<p>The goal is to be able to do the following.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> df = <span class="title class_">DataFrame</span>.<span class="title function_">fromObject</span>(</span><br><span class="line">  [</span><br><span class="line">    &#123; <span class="string">&#x27;col0&#x27;</span>: <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;col1&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;col2&#x27;</span>: <span class="number">8.1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&#x27;col0&#x27;</span>: <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;col1&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;col2&#x27;</span>: <span class="number">3.2</span> &#125;</span><br><span class="line">  ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">df[<span class="string">&#x27;col3&#x27;</span>] = df[<span class="string">&#x27;col1&#x27;</span>] + df[<span class="string">&#x27;col2&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>In plain old JavaScript this is not possible. Let’s see how we can implement it.</p>
<h2 id="The-goal"><a href="#The-goal" class="headerlink" title="The goal"></a>The goal</h2><p>So what is a <em>DataFrame</em>? To answer this we first need to look at a <em>Series</em>.</p>
<h3 id="So-What-is-a-Series"><a href="#So-What-is-a-Series" class="headerlink" title="So What is a Series?"></a>So What is a Series?</h3><p>A <em>Series</em> is the building block of a <em>DataFrame</em>. I take a <em>Series</em> to be a<br>named vector (array), which will be initialized as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> s1 = <span class="keyword">new</span> <span class="title class_">Series</span>(<span class="string">&#x27;height&#x27;</span>, [<span class="number">1.82</span>, <span class="number">1.76</span>, <span class="number">1.72</span>, <span class="number">1.89</span>])</span><br></pre></td></tr></table></figure>

<p>The series should be indexable.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s1[<span class="number">0</span>] === <span class="number">1.82</span></span><br></pre></td></tr></table></figure>

<p>The series should support vector arithmetic.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> height = <span class="keyword">new</span> <span class="title class_">Series</span>(<span class="string">&#x27;height&#x27;</span>, [<span class="number">1.82</span>, <span class="number">1.76</span>, <span class="number">1.72</span>, <span class="number">1.89</span>])</span><br><span class="line"><span class="keyword">let</span> weight = <span class="keyword">new</span> <span class="title class_">Series</span>(<span class="string">&#x27;weight&#x27;</span>, [<span class="number">81.3</span>, <span class="number">73.2</span>, <span class="number">68.9</span>, <span class="number">92.1</span>])</span><br><span class="line"><span class="keyword">let</span> score = height / weight</span><br></pre></td></tr></table></figure>

<h3 id="So-What-is-a-DataFrame"><a href="#So-What-is-a-DataFrame" class="headerlink" title="So What is a DataFrame?"></a>So What is a DataFrame?</h3><p>I take a <em>DataFrame</em> to be a collection of <em>Series</em>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> df = <span class="title class_">DataFrame</span>([</span><br><span class="line">  height,</span><br><span class="line">  weight</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<h2 id="The-problems-to-solve"><a href="#The-problems-to-solve" class="headerlink" title="The problems to solve"></a>The problems to solve</h2><p>There are two problems to solve in order to implement this in JavaScript:</p>
<ul>
<li>Operator overloading</li>
<li>Property accessing</li>
</ul>
<h3 id="Operator-Overloading"><a href="#Operator-Overloading" class="headerlink" title="Operator Overloading"></a>Operator Overloading</h3><p>We want to support vector arithmetic (multiplying two arrays). Unfortunately<br>JavaScript does not support operator overloading so we will have to pre-process<br>the code. We can do this with the <a target="_blank" rel="noopener" href="https://babeljs.io/">babel</a> transpiler<br>and a plugin. I’m using the<br><a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/jetblack-operator-overloading">@jetblack&#x2F;operator-overloading</a><br>plugin, which is a bag-of-bolts, but I wrote it so I know how it works! </p>
<h3 id="Property-accessing"><a href="#Property-accessing" class="headerlink" title="Property accessing"></a>Property accessing</h3><p>In order for a series to have both a name and be indexable we need control over<br>the property accessing. We can do that with a<br><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">Proxy</a><br>object. The <code>Proxy</code> object provides a layer of indirection between requests on<br>the object, and the actions performed.</p>
<h2 id="Setting-up-your-environment"><a href="#Setting-up-your-environment" class="headerlink" title="Setting up your environment"></a>Setting up your environment</h2><p>Lets write some code!</p>
<p>First install the node modules. I’m using babel, the operator overloading<br>plugin, and<br><a target="_blank" rel="noopener" href="https://standardjs.com/">standardjs</a> as a linter and formatter.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Initialise the package.json</span></span><br><span class="line">npm init -y</span><br><span class="line"><span class="comment"># Install the babel tool chain.</span></span><br><span class="line">npm install --save-dev @babel/core@7.10.1 @babel/preset-env@7.10.2 @babel/cli@7.10.1 @babel/node@7.10.1</span><br><span class="line"><span class="comment"># Install the operator overloading plugin.</span></span><br><span class="line">npm install --save-dev git+https://github.com/rob-blackbourn/jetblack-operator-overloading.git<span class="comment">#0.1.0</span></span><br><span class="line"><span class="comment"># Install standardjs for linting and formatting</span></span><br><span class="line">npm install --save-dev babel-eslint@10.1.0 standard@14.3.4</span><br></pre></td></tr></table></figure>

<p>We configure standardjs by editing the package.json and adding the following.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">&quot;standard&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;parser&quot;</span><span class="punctuation">:</span> <span class="string">&quot;babel-eslint&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>If you are using using vscode create the <code>.vscode/settings.json</code> as follows<br>then restart vscode to start the standardjs server.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;javascript.validate.enable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;standard.enable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;standard.autoFixOnSave&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;[javascript]&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;editor.formatOnSave&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Configure babel by creating the <code>.bablerc</code> file with the usual preset and the<br>operator overloading plugin. The operator overloading plugin requires arrow<br>functions. Targeting <code>node</code> (or any modern browser) achieves this.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;presets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">[</span><span class="string">&quot;@babel/preset-env&quot;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;current&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;module:@jetblack/operator-overloading&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Edit the <code>package.json</code> and add some scripts for building the transpiled code<br>and running it.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;babel src --out-dir=dist --source-maps&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node dist/main.js&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  ...</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="The-Implementation"><a href="#The-Implementation" class="headerlink" title="The Implementation"></a>The Implementation</h2><p>Put the code in a subdirectory called <code>src</code>.</p>
<h3 id="Series-Code"><a href="#Series-Code" class="headerlink" title="Series Code"></a>Series Code</h3><p>In the <code>src</code> directory create a file called <code>Series.js</code> with the following<br>content.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Series</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (name, array) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">array</span> = array</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="variable language_">this</span>, &#123;</span><br><span class="line">      <span class="attr">get</span>: <span class="function">(<span class="params">obj, prop, receiver</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(obj, prop, receiver)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(obj.<span class="property">array</span>, prop, receiver.<span class="property">array</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">set</span>: <span class="function">(<span class="params">obj, prop, value, receiver</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(obj, prop, value, receiver)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(obj.<span class="property">array</span>, prop, value, receiver.<span class="property">array</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">apply</span>: <span class="function">(<span class="params">target, thisArgument, argumentList</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(target, thisArgument, argumentList)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">defineProperty</span>: <span class="title class_">Reflect</span>.<span class="property">defineProperty</span>,</span><br><span class="line">      <span class="attr">getOwnPropertyDescriptor</span>: <span class="title class_">Reflect</span>.<span class="property">getOwnPropertyDescriptor</span>,</span><br><span class="line">      <span class="attr">deleteProperty</span>: <span class="title class_">Reflect</span>.<span class="property">deleteProperty</span>,</span><br><span class="line">      <span class="attr">getPrototypeOf</span>: <span class="title class_">Reflect</span>.<span class="property">getPrototypeOf</span>,</span><br><span class="line">      <span class="attr">setPrototypeOf</span>: <span class="title class_">Reflect</span>.<span class="property">setPrototypeOf</span>,</span><br><span class="line">      <span class="attr">isExtensible</span>: <span class="title class_">Reflect</span>.<span class="property">isExtensible</span>,</span><br><span class="line">      <span class="attr">preventExtensions</span>: <span class="title class_">Reflect</span>.<span class="property">preventExtensions</span>,</span><br><span class="line">      <span class="attr">has</span>: <span class="title class_">Reflect</span>.<span class="property">has</span>,</span><br><span class="line">      <span class="attr">ownKeys</span>: <span class="title class_">Reflect</span>.<span class="property">ownKeys</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [<span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&#x27;+&#x27;</span>)] (other) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Series</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>+<span class="subst">$&#123;other.name&#125;</span>`</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">array</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">value, index</span>) =&gt;</span> value + other.<span class="property">array</span>[index])</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [<span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&#x27;-&#x27;</span>)] (other) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Series</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>-<span class="subst">$&#123;other.name&#125;</span>`</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">array</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">value, index</span>) =&gt;</span> value - other.<span class="property">array</span>[index])</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [<span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&#x27;*&#x27;</span>)] (other) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Series</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>*<span class="subst">$&#123;other.name&#125;</span>`</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">array</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">value, index</span>) =&gt;</span> value * other.<span class="property">array</span>[index])</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  [<span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&#x27;/&#x27;</span>)] (other) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Series</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>/<span class="subst">$&#123;other.name&#125;</span>`</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">array</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">value, index</span>) =&gt;</span> value / other.<span class="property">array</span>[index])</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  toString () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`(<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>): <span class="subst">$&#123;<span class="variable language_">this</span>.array.join(<span class="string">&#x27;, &#x27;</span>)&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The code can be split into two parts.</p>
<p>The constructor returns a <code>Proxy</code><br>object, which  intercepts calls to the Series. It first checks if the property<br>or function is provided by the Series itself. If not it delegates the action<br>to the array. Note how the <code>Proxy</code> is returned from the constructor; this is a<br>poorly documented feature.</p>
<p>The operators are provided by the <code>[Symbol.for(&#39;+&#39;)]</code> methods.</p>
<h3 id="DataFrame-Code"><a href="#DataFrame-Code" class="headerlink" title="DataFrame Code"></a>DataFrame Code</h3><p>In the <code>src</code> directory create a file called <code>DataFrame.js</code> with the following<br>content.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Series</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./Series&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">DataFrame</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (series) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">series</span> = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> series) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">series</span>[item.<span class="property">name</span>] = item</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="variable language_">this</span>, &#123;</span><br><span class="line">      <span class="attr">get</span>: <span class="function">(<span class="params">obj, prop, receiver</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> prop <span class="keyword">in</span> obj ? <span class="title class_">Reflect</span>.<span class="title function_">get</span>(obj, prop, receiver) : <span class="title class_">Reflect</span>.<span class="title function_">get</span>(obj.<span class="property">series</span>, prop, receiver.<span class="property">series</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">set</span>: <span class="function">(<span class="params">obj, prop, value, receiver</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> prop <span class="keyword">in</span> obj ? <span class="title class_">Reflect</span>.<span class="title function_">set</span>(obj, prop, value, receiver) : <span class="title class_">Reflect</span>.<span class="title function_">set</span>(obj.<span class="property">series</span>, prop, value, receiver.<span class="property">series</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">apply</span>: <span class="function">(<span class="params">target, thisArgument, argumentList</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> target <span class="keyword">in</span> thisArgument ? <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(target, thisArgument, argumentList) : <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(target, thisArgument.<span class="property">array</span>, argumentList)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">defineProperty</span>: <span class="title class_">Reflect</span>.<span class="property">defineProperty</span>,</span><br><span class="line">      <span class="attr">getOwnPropertyDescriptor</span>: <span class="title class_">Reflect</span>.<span class="property">getOwnPropertyDescriptor</span>,</span><br><span class="line">      <span class="attr">deleteProperty</span>: <span class="title class_">Reflect</span>.<span class="property">deleteProperty</span>,</span><br><span class="line">      <span class="attr">getPrototypeOf</span>: <span class="title class_">Reflect</span>.<span class="property">getPrototypeOf</span>,</span><br><span class="line">      <span class="attr">setPrototypeOf</span>: <span class="title class_">Reflect</span>.<span class="property">setPrototypeOf</span>,</span><br><span class="line">      <span class="attr">isExtensible</span>: <span class="title class_">Reflect</span>.<span class="property">isExtensible</span>,</span><br><span class="line">      <span class="attr">preventExtensions</span>: <span class="title class_">Reflect</span>.<span class="property">preventExtensions</span>,</span><br><span class="line">      <span class="attr">has</span>: <span class="title class_">Reflect</span>.<span class="property">has</span>,</span><br><span class="line">      <span class="attr">ownKeys</span>: <span class="title class_">Reflect</span>.<span class="property">ownKeys</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> fromObject (data) &#123;</span><br><span class="line">    <span class="keyword">const</span> series = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; data.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> column <span class="keyword">in</span> data[i]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(column <span class="keyword">in</span> series)) &#123;</span><br><span class="line">          series[column] = <span class="keyword">new</span> <span class="title class_">Series</span>(column, <span class="keyword">new</span> <span class="title class_">Array</span>(data.<span class="property">length</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        series[column][i] = data[i][column]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> seriesList = <span class="title class_">Object</span>.<span class="title function_">values</span>(series)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataFrame</span>(seriesList)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  toString () &#123;</span><br><span class="line">    <span class="keyword">const</span> columns = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyNames</span>(<span class="variable language_">this</span>.<span class="property">series</span>)</span><br><span class="line">    <span class="keyword">let</span> s = columns.<span class="title function_">join</span>(<span class="string">&#x27;, &#x27;</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="keyword">const</span> maxLength = <span class="title class_">Object</span>.<span class="title function_">values</span>(<span class="variable language_">this</span>.<span class="property">series</span>)</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function"><span class="params">x</span> =&gt;</span> x.<span class="property">length</span>)</span><br><span class="line">      .<span class="title function_">reduce</span>(<span class="function">(<span class="params">accumulator, currentValue</span>) =&gt;</span> <span class="title class_">Math</span>.<span class="title function_">max</span>(accumulator, currentValue), <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; maxLength; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> row = []</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> column <span class="keyword">of</span> columns) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="variable language_">this</span>.<span class="property">series</span>[column].<span class="property">length</span>) &#123;</span><br><span class="line">          row.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="property">series</span>[column][i])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          row.<span class="title function_">push</span>(<span class="literal">null</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      s += row.<span class="title function_">join</span>(<span class="string">&#x27;, &#x27;</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This would be pretty short without the <code>toString</code>!</p>
<p>As with the <code>Series</code> class we use a <code>Proxy</code> object to control property<br>accessing.</p>
<p>I decided to keep the constructor clean; it just takes an array<br>of <code>Series</code>. However, in the real world we want a variety of constructors. The<br>convenience class method <code>DataFrame.fromObject</code> provides a way of building the series from<br>a list of objects.</p>
<h2 id="Try-it-out"><a href="#Try-it-out" class="headerlink" title="Try it out"></a>Try it out</h2><p>Let’s start with a series.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;operator-overloading enabled&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Series</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./Series&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> height = <span class="keyword">new</span> <span class="title class_">Series</span>(<span class="string">&#x27;height&#x27;</span>, [<span class="number">1.82</span>, <span class="number">1.72</span>, <span class="number">1.64</span>, <span class="number">1.88</span>])</span><br><span class="line"><span class="keyword">const</span> weight = <span class="keyword">new</span> <span class="title class_">Series</span>(<span class="string">&#x27;weight&#x27;</span>, [<span class="number">81.4</span>, <span class="number">72.3</span>, <span class="number">69.9</span>, <span class="number">79.5</span>])</span><br><span class="line"><span class="keyword">const</span> ratio = weight / height</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ratio.<span class="title function_">toString</span>())</span><br><span class="line"></span><br><span class="line">&gt; (weight/height): <span class="number">44.72527472527473</span>, <span class="number">42.03488372093023</span>, <span class="number">42.6219512195122</span>, <span class="number">42.287234042553195</span></span><br></pre></td></tr></table></figure>

<p>And let’s try using array methods to see if the request gets forwarded by the<br>proxy to the array.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Series</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./Series&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> s1 = <span class="keyword">new</span> <span class="title class_">Series</span>(<span class="string">&#x27;numbers&#x27;</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line">s1.<span class="title function_">push</span>(<span class="number">5</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(s1.<span class="title function_">toString</span>())</span><br><span class="line"></span><br><span class="line">&gt; (numbers): <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>Finally let’s test the DataFrame.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;operator-overloading enabled&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">DataFrame</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./DataFrame&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> df = <span class="title class_">DataFrame</span>.<span class="title function_">fromObject</span>(</span><br><span class="line">  [</span><br><span class="line">    &#123; <span class="attr">col0</span>: <span class="string">&#x27;a&#x27;</span>, <span class="attr">col1</span>: <span class="number">5</span>, <span class="attr">col2</span>: <span class="number">8.1</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">col0</span>: <span class="string">&#x27;b&#x27;</span>, <span class="attr">col1</span>: <span class="number">6</span>, <span class="attr">col2</span>: <span class="number">3.2</span> &#125;</span><br><span class="line">  ]</span><br><span class="line">)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(df.<span class="title function_">toString</span>())</span><br><span class="line">&gt; col0, col1, col2</span><br><span class="line">&gt; a, <span class="number">5</span>, <span class="number">8.1</span></span><br><span class="line">&gt; b, <span class="number">6</span>, <span class="number">3.2</span></span><br><span class="line"></span><br><span class="line">df[<span class="string">&#x27;col3&#x27;</span>] = df[<span class="string">&#x27;col1&#x27;</span>] + df[<span class="string">&#x27;col2&#x27;</span>]</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(df.<span class="title function_">toString</span>())</span><br><span class="line">&gt; col0, col1, col2, col3</span><br><span class="line">&gt; a, <span class="number">5</span>, <span class="number">8.1</span>, <span class="number">13.1</span></span><br><span class="line">&gt; b, <span class="number">6</span>, <span class="number">3.2</span>, <span class="number">9.2</span></span><br></pre></td></tr></table></figure>

<h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>Obviously there’s a lot  in a pandas DataFrame not covered here, but I think<br>this demonstrates how the basic syntax could be achieved.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2020/06/10/example-js-dataframe/" data-id="cma87l7fz0003wrjp8e4ldn42" data-title="An example of a pandas style DataFrame in JavaScript" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/dataframe/" rel="tag">dataframe</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-wasm-arrays" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2020/06/07/wasm-arrays/" class="article-date">
  <time class="dt-published" datetime="2020-06-07T13:39:38.000Z" itemprop="datePublished">2020-06-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2020/06/07/wasm-arrays/">Passing arrays between wasm and JavaScript</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>In this post I’ll demonstrate some ways of passing arrays between JavaScript<br>and WebAssembly. The source code is <a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/example-wasm-array-passing">here</a>.</p>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>These examples have been tested with <a target="_blank" rel="noopener" href="https://nodejs.org/">nodejs v12.9.1</a>,<br><a target="_blank" rel="noopener" href="https://clang.llvm.org/">clang 10.0.0</a>,<br>and <a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wabt">wabt 1.0.16</a> on Ubuntu 18.04.</p>
<p>I installed <code>clang</code> in <code>/opt/clang</code>, <code>wabt</code> in <code>/opt/wabt</code>, and I use<br><a target="_blank" rel="noopener" href="https://github.com/nodenv/nodenv">nodenv</a> to manage my <code>nodejs</code> environment.</p>
<p>Update your path.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/opt/clang/bin:/opt/wabt/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<h2 id="No-Hello-World"><a href="#No-Hello-World" class="headerlink" title="No Hello, World?"></a>No Hello, World?</h2><p>Sadly the typically hello world example is tricky for WebAssembly; so we’ll do<br>a traditional “add two numbers” instead.</p>
<h3 id="Write-the-C-code"><a href="#Write-the-C-code" class="headerlink" title="Write the C code"></a>Write the C code</h3><p>Start by writing the C code in the file <code>example1.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((used)) <span class="type">int</span> <span class="title function_">addTwoInts</span> <span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This looks pretty vanilla apart from <code>__attribute__((used))</code>. This appears to<br>mark the function as something that can be exported from the module.</p>
<h3 id="Build-the-wasm-module"><a href="#Build-the-wasm-module" class="headerlink" title="Build the wasm module."></a>Build the wasm module.</h3><p>Now lets compile.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">clang example1.c \</span><br><span class="line">  --target=wasm32-unknown-unknown-wasm \</span><br><span class="line">  --optimize=3 \</span><br><span class="line">  -nostdlib \</span><br><span class="line">  -Wl,--export-all \</span><br><span class="line">  -Wl,--no-entry \</span><br><span class="line">  -Wl,--allow-undefined \</span><br><span class="line">  --output example1.wasm</span><br></pre></td></tr></table></figure>

<p>So many flags! Lets go through them.</p>
<ul>
<li><code>--target=wasm32-unknown-unknown-wasm</code> tells the compiler&#x2F;linker to produce<br>wasm.</li>
<li><code>--optimize=3</code> seems to ne necessary to produce valid wasm. I don’t know why,<br>and I might be wrong.</li>
<li><code>-nostdlib</code> tells the compiler&#x2F;linker that we don’t have a standard library,<br>which is very sad.</li>
<li><code>-Wl,--export-all</code> tells the linker to export anything it can.</li>
<li><code>-Wl,--no-entry</code> tells the linker that there’s no main; this is just a library.</li>
<li><code>-Wl,--allow-undefined</code> tells the linked to allow the code to access functions<br>and variables that have not been defined. We’ll need to provide them when we<br>instantiate the WebAssembly instance. This won’t be used in this example, but<br>we’ll need it later.</li>
<li><code>--output example1.wasm</code> does what it says on the tin.</li>
</ul>
<p>If all went well you now have an <code>example.wasm</code> file.</p>
<h3 id="Write-the-JavaScript"><a href="#Write-the-JavaScript" class="headerlink" title="Write the JavaScript"></a>Write the JavaScript</h3><p>Write a JavaScript file <code>example1.js</code> with the following content.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Read the wasm file.</span></span><br><span class="line">  <span class="keyword">const</span> buf = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./example1.wasm&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create a WebAssembly instance from the wasm.</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(buf, &#123;&#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Get the function to call.</span></span><br><span class="line">  <span class="keyword">const</span> &#123; addTwoInts &#125; = res.<span class="property">instance</span>.<span class="property">exports</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Call the function.</span></span><br><span class="line">  <span class="keyword">const</span> a = <span class="number">38</span>, b = <span class="number">4</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">addTwoInts</span>(a, b)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;a&#125;</span> + <span class="subst">$&#123;b&#125;</span> =  <span class="subst">$&#123;result&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">main</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Done&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>The code comments should make it pretty clear whats happening here. We read the<br>compiled wasm into a buffer, instantiate the WebAssembly, get the function, run<br>it, and print out the result.</p>
<p>The <code>WebAssembly.instantiate</code> function is a promise, and I have chosen to use<br>the <code>await</code> syntax to make the code more readable, so I make an <code>async main</code><br>function which I call as a promise on the last line.</p>
<p>Lets run it.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node example1.js</span><br></pre></td></tr></table></figure>

<p>If all went well you should see the following.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">38 + 4 =  42</span><br><span class="line">Done</span><br></pre></td></tr></table></figure>

<h3 id="What-just-happened"><a href="#What-just-happened" class="headerlink" title="What just happened?"></a>What just happened?</h3><p>The bit I want to talk about here is how the wasm got instantiated. The first<br>argument to <code>WebAssembly.instantiate</code> was the <code>buf</code> holding the wasm. The second<br>was an empty <code>importObject</code>. The <code>importObject</code> can configure the properties<br>of the instance it creates. This might include the memory it uses, a table of<br>function references, imported and exported functions, etc. So why does an empty<br>object work?</p>
<p>We can look at the WebAssembly text (or <code>wat</code>) with the <code>wabt</code> tool <code>wasm2wat</code>.<br>To produce this we need to do the following.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wasm2wat example2.wasm -o example2.wat</span><br></pre></td></tr></table></figure>

<p>The <code>example2.wat</code> file should look like this (edited for readability).</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">module</span></span><br><span class="line">  (<span class="name">type</span> (<span class="comment">;0;) (func))</span></span><br><span class="line">  (<span class="name">type</span> (<span class="comment">;1;) (func (param i32 i32) (result i32)))</span></span><br><span class="line">  (<span class="name">func</span> $__wasm_call_ctors (<span class="name">type</span> <span class="number">0</span>))</span><br><span class="line">  (<span class="name">func</span> $addTwoInts (<span class="name">type</span> <span class="number">1</span>) (<span class="name">param</span> i32 i32) (<span class="name">result</span> i32)</span><br><span class="line">    local.get <span class="number">1</span></span><br><span class="line">    local.get <span class="number">0</span></span><br><span class="line">    i32.add)</span><br><span class="line">  (<span class="name">table</span> (<span class="comment">;0;) 1 1 funcref)</span></span><br><span class="line">  (<span class="name">memory</span> (<span class="comment">;0;) 2)</span></span><br><span class="line">  (<span class="name">global</span> (<span class="comment">;0;) (mut i32) (i32.const 66560))</span></span><br><span class="line">  (<span class="name">global</span> (<span class="comment">;1;) i32 (i32.const 1024))</span></span><br><span class="line">  (<span class="name">export</span> <span class="string">&quot;memory&quot;</span> (<span class="name">memory</span> <span class="number">0</span>))</span><br><span class="line">  (<span class="name">export</span> <span class="string">&quot;addTwoInts&quot;</span> (<span class="name">func</span> $addTwoInts))</span><br></pre></td></tr></table></figure>

<p>Near the top you can see our <code>addTwoInts</code> function with a satisfyingly small<br>amount of code which is almost understandable. Then there are mentions of<br><code>table</code> and <code>memory</code>. At the end wel can see <code>memory</code> exported along with our<br>function.</p>
<p>What has happened is that the clang tool-chain has generated a bunch of stuff<br>that we would otherwise need to put in the <code>importObject</code>. You can switch this<br>off (see <a target="_blank" rel="noopener" href="https://lld.llvm.org/WebAssembly.html">here</a>) and control everything<br>from the JavaScript side, but I quite like it.</p>
<h2 id="Passing-arrays-to-wasm"><a href="#Passing-arrays-to-wasm" class="headerlink" title="Passing arrays to wasm"></a>Passing arrays to wasm</h2><p>Now we’ve established our tools work, and seen some of the features clang<br>provides we can get to arrays.</p>
<h3 id="Write-the-C-code-1"><a href="#Write-the-C-code-1" class="headerlink" title="Write the C code"></a>Write the C code</h3><p>Write a file <code>example2.c</code> with the following contents.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((used)) <span class="type">int</span> <span class="title function_">sumArrayInt32</span> <span class="params">(<span class="type">int</span> *<span class="built_in">array</span>, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">    <span class="type">int</span> total = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">        total += <span class="built_in">array</span>[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> total;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Compile it to wasm as we did before.</p>
<h3 id="Write-the-JavaScript-1"><a href="#Write-the-JavaScript-1" class="headerlink" title="Write the JavaScript"></a>Write the JavaScript</h3><p>Write a javascript file call <code>example2.js</code> with the following contents.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Load the wasm into a buffer.</span></span><br><span class="line">  <span class="keyword">const</span> buf = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./example2.wasm&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Instantiate the wasm.</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(buf, &#123;&#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Get the function out of the exports.</span></span><br><span class="line">  <span class="keyword">const</span> &#123; sumArrayInt32, memory &#125; = res.<span class="property">instance</span>.<span class="property">exports</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Create an array that can be passed to the WebAssembly instance.</span></span><br><span class="line">  <span class="keyword">const</span> array = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(memory.<span class="property">buffer</span>, <span class="number">0</span>, <span class="number">5</span>)</span><br><span class="line">  array.<span class="title function_">set</span>([<span class="number">3</span>, <span class="number">15</span>, <span class="number">18</span>, <span class="number">4</span>, <span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call the function and display the results.</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">sumArrayInt32</span>(array.<span class="property">byteOffset</span>, array.<span class="property">length</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`sum([<span class="subst">$&#123;array.join(<span class="string">&#x27;,&#x27;</span>)&#125;</span>]) = <span class="subst">$&#123;result&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This does the same thing!</span></span><br><span class="line">  <span class="keyword">if</span> (result == <span class="title function_">sumArrayInt32</span>(<span class="number">0</span>, <span class="number">5</span>)) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Memory is an integer array starting at 0`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">main</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Done&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>The first part is the same as the previous example.</p>
<p>Then we create the array.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> array = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(memory.<span class="property">buffer</span>, <span class="number">0</span>, <span class="number">5</span>)</span><br><span class="line">array.<span class="title function_">set</span>([<span class="number">3</span>, <span class="number">15</span>, <span class="number">18</span>, <span class="number">4</span>, <span class="number">2</span>])</span><br></pre></td></tr></table></figure>

<p>The wasm instance has a memory buffer which is exposed to JavaScript as<br>an <code>ArrayBuffer</code> in <code>memory.buffer</code>. We create our <code>Int32Array</code> using the<br>first available “memory location” <code>0</code>, and specify that it is <code>5</code><br>integers in length. Note the memory location is in terms of bytes, and<br>the length in terms of integers. The <code>set</code> method copies the JavaScript<br>array into the memory buffer.</p>
<p>Then we call the function.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="title function_">sumArrayInt32</span>(array.<span class="property">byteOffset</span>, array.<span class="property">length</span>)</span><br></pre></td></tr></table></figure>

<p>We pass in the offset in bytes to the array in the memory buffer and<br>the length (in integers) of the array. This gets passed to the function<br>we wrote in C.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sumArrayInt32</span> <span class="params">(<span class="type">int</span> *<span class="built_in">array</span>, <span class="type">int</span> length)</span></span><br></pre></td></tr></table></figure>

<p>The result gets passed back as an integer.</p>
<h2 id="Passing-output-arrays-to-wasm"><a href="#Passing-output-arrays-to-wasm" class="headerlink" title="Passing output arrays to wasm"></a>Passing output arrays to wasm</h2><p>This gives us some of what we want, but what if we want to get an array<br>back from wasm? The first approach is to pass an output array.</p>
<h3 id="Write-the-C-code-2"><a href="#Write-the-C-code-2" class="headerlink" title="Write the C code"></a>Write the C code</h3><p>Write a file <code>example3.c</code> with the following contents.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((used)) <span class="type">void</span> <span class="title function_">addArraysInt32</span> <span class="params">(<span class="type">int</span> *array1, <span class="type">int</span>* array2, <span class="type">int</span>* result, <span class="type">int</span> length)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">        result[i] = array1[i] + array2[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The function takes in three arrays, multiplying each element of the two<br>input arrays and storing the output in the result array. Nothing need be<br>returned.</p>
<h3 id="Write-the-JavaScript-2"><a href="#Write-the-JavaScript-2" class="headerlink" title="Write the JavaScript"></a>Write the JavaScript</h3><p>Write a file called <code>example3.js</code> with the following content.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Load the wasm into a buffer.</span></span><br><span class="line">  <span class="keyword">const</span> buf = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./example3.wasm&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make an instance.</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(buf, &#123;&#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Get function.</span></span><br><span class="line">  <span class="keyword">const</span> &#123; addArraysInt32, memory &#125; = res.<span class="property">instance</span>.<span class="property">exports</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Create the arrays.</span></span><br><span class="line">  <span class="keyword">const</span> length = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> offset = <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> array1 = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(memory.<span class="property">buffer</span>, offset, length)</span><br><span class="line">  array1.<span class="title function_">set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line">  offset += length * <span class="title class_">Int32Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line">  <span class="keyword">const</span> array2 = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(memory.<span class="property">buffer</span>, offset, length)</span><br><span class="line">  array2.<span class="title function_">set</span>([<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>])</span><br><span class="line"></span><br><span class="line">  offset += length * <span class="title class_">Int32Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(memory.<span class="property">buffer</span>, offset, length)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call the function.</span></span><br><span class="line">  <span class="title function_">addArraysInt32</span>(</span><br><span class="line">    array1.<span class="property">byteOffset</span>,</span><br><span class="line">    array2.<span class="property">byteOffset</span>,</span><br><span class="line">    result.<span class="property">byteOffset</span>,</span><br><span class="line">    length)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Show the results.</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[<span class="subst">$&#123;array1.join(<span class="string">&quot;, &quot;</span>)&#125;</span>] + [<span class="subst">$&#123;array2.join(<span class="string">&quot;, &quot;</span>)&#125;</span>] = [<span class="subst">$&#123;result.join(<span class="string">&quot;, &quot;</span>)&#125;</span>]`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">main</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Done&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>We can see some differences here in the way we create the arrays. The<br>code to create the first array looks the same, but what’s going on for<br>the others?</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">offset += length * <span class="title class_">Int32Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"><span class="keyword">const</span> array2 = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(memory.<span class="property">buffer</span>, offset, length)</span><br></pre></td></tr></table></figure>

<p>Our first example was easy, as we only had one array. When we create<br>subsequent arrays we need to lay them out in memory such that they don’t<br>overlap each other. To do this we calculate the number of bytes required<br>with <code>length * Int32Array.BYTES_PER_ELEMENT</code> and add it to the previous<br>offset to ensure each array has it’s own space. Note again how the offset<br>is in bytes, but the length is in units of integers.</p>
<p>Next we call the function.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">addArraysInt32</span>(array1.<span class="property">byteOffset</span>, array2.<span class="property">byteOffset</span>, result.<span class="property">byteOffset</span>, length)</span><br></pre></td></tr></table></figure>

<p>This maps on to the prototype of our C implementation.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">addArraysInt32</span> <span class="params">(<span class="type">int</span> *array1, <span class="type">int</span>* array2, <span class="type">int</span>* result, <span class="type">int</span> length)</span></span><br></pre></td></tr></table></figure>

<p>Now we can get array data out of wasm!</p>
<p>But wait, something is missing. What if we want to create an array<br>inside the wasm module and pass it out? What if our array calculation<br>needs to create it’s own arrays in order to support the calculation?</p>
<p>To do that we need to provided some memory management.</p>
<h2 id="Understanding-wasm-memory-management"><a href="#Understanding-wasm-memory-management" class="headerlink" title="Understanding wasm memory management"></a>Understanding wasm memory management</h2><p>As we have seen, wasm memory is managed in JavaScript through the<br><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Memory"><code>WebAssembly.Memory</code></a><br>object. This has a <code>buffer</code> which is an <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer"><code>ArrayBuffer</code></a>. The buffer has a <code>byteLength</code> property, which gives us the<br>upper bound of the memory.</p>
<p>It also has a <code>grow</code> method which can be used to get more memory.</p>
<p>I couldn’t find any documentation on how to get to this information from<br>inside the wasm instance, but we can solve this problem by calling back<br>to the JavaScript from wasm.</p>
<h2 id="Calling-JavaScript-from-wasm"><a href="#Calling-JavaScript-from-wasm" class="headerlink" title="Calling JavaScript from wasm"></a>Calling JavaScript from wasm</h2><p>We can call JavaScript from wasm by <em>importing</em> a function when we<br>instantiate the wasm module.</p>
<h3 id="Write-the-C-code-3"><a href="#Write-the-C-code-3" class="headerlink" title="Write the C code"></a>Write the C code</h3><p>Write a file <code>example4.c</code> with the following contents.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">someFunction</span><span class="params">(<span class="type">int</span> i)</span>;</span><br><span class="line"></span><br><span class="line">__attribute__((used)) <span class="type">void</span> <span class="title function_">callSomeFunction</span> <span class="params">(<span class="type">int</span> i)</span></span><br><span class="line">&#123;</span><br><span class="line">  someFunction(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here declare an <em>external</em> function <code>someFunction</code> that will be<br>provided by JavaScript, and then export <code>callSomeFunction</code> that, when<br>invoked, will run the imported function.</p>
<h3 id="Write-the-JavaScript-3"><a href="#Write-the-JavaScript-3" class="headerlink" title="Write the JavaScript"></a>Write the JavaScript</h3><p>Write a file called <code>example4.js</code> with the following content.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Load the wasm into a buffer.</span></span><br><span class="line">  <span class="keyword">const</span> buf = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./example4.wasm&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make the instance, importing a function called someFunction which</span></span><br><span class="line">  <span class="comment">// logs its arguments to the console.</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(buf, &#123;</span><br><span class="line">    <span class="attr">env</span>: &#123;</span><br><span class="line">      <span class="attr">someFunction</span>: <span class="keyword">function</span> (<span class="params">i</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`someFunction called with <span class="subst">$&#123;i&#125;</span>`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Get the exported function callSomeFunction from the wasm instance.</span></span><br><span class="line">  <span class="keyword">const</span> &#123; callSomeFunction &#125; = res.<span class="property">instance</span>.<span class="property">exports</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Calling the function should call back into the function we imported.</span></span><br><span class="line">  <span class="title function_">callSomeFunction</span>(<span class="number">42</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">main</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Done&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>Rather than passing in an empty object to <code>WebAssembly.instantiate</code> as we<br>did previously, we now pass an object with an <code>env</code> property. This<br>contains a property <code>someFunction</code> with it’s implementation (it just<br>logs its argument to the console).</p>
<p>Calling the function <code>callSomeFunction</code> calls back to the function we<br>provided to the wasm module <code>someFunction</code>.</p>
<p>Now we have a way of the wasm module finding out how much memory it has<br>and asking for more.</p>
<h2 id="Passing-arrays-from-wasm-to-JavaScript"><a href="#Passing-arrays-from-wasm-to-JavaScript" class="headerlink" title="Passing arrays from wasm to JavaScript"></a>Passing arrays from wasm to JavaScript</h2><p>First we need some C code to perform memory management. I wrote a trivial<br>implementation of <code>malloc</code> which can be found <a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/example-wasm-array-passing/blob/master/memory-allocation.c">here</a>.<br>Copy this file to the work folder as <code>memory-allocation.c</code> The code provides<br>three functions.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">allocateMemory</span> <span class="params">(<span class="type">unsigned</span> bytes_required)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">freeMemory</span><span class="params">(<span class="type">void</span> *memory_to_free)</span>;</span><br><span class="line"><span class="type">double</span> <span class="title function_">reportFreeMemory</span><span class="params">()</span></span><br></pre></td></tr></table></figure>

<p>Obviously it’s stupid to write your own <code>malloc</code>. Rob bad.</p>
<h3 id="Write-the-C-code-4"><a href="#Write-the-C-code-4" class="headerlink" title="Write the C code"></a>Write the C code</h3><p>Write a file <code>example5.c</code> with the following contents.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">void</span> *<span class="title function_">allocateMemory</span><span class="params">(<span class="type">unsigned</span> bytes_required)</span>;</span><br><span class="line"></span><br><span class="line">__attribute__((used)) <span class="type">int</span>* <span class="title function_">addArrays</span> <span class="params">(<span class="type">int</span> *array1, <span class="type">int</span>* array2, <span class="type">int</span> length)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span>* result = allocateMemory(length * <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">    result[i] = array1[i] + array2[i];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The code is similar to the previous example, but instead of taking in a result<br>array, it creates and returns the array itself.</p>
<h3 id="Write-the-JavaScript-4"><a href="#Write-the-JavaScript-4" class="headerlink" title="Write the JavaScript"></a>Write the JavaScript</h3><p>Write a file called <code>example5.js</code> containing the following code.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A simple memory manager.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryManager</span> &#123;</span><br><span class="line">  <span class="comment">// The WebAssembly.Memory object for the instance.</span></span><br><span class="line">  memory = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return the buffer length in bytes.</span></span><br><span class="line">  <span class="title function_">memoryBytesLength</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">memory</span>.<span class="property">buffer</span>.<span class="property">byteLength</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Grow the memory by the requested blocks, returning the new buffer length</span></span><br><span class="line">  <span class="comment">// in bytes.</span></span><br><span class="line">  <span class="title function_">grow</span>(<span class="params">blocks</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">memory</span>.<span class="title function_">grow</span>(blocks)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">memory</span>.<span class="property">buffer</span>.<span class="property">byteLength</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Read the wasm file.</span></span><br><span class="line">  <span class="keyword">const</span> buf = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./example5.wasm&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create an object to manage the memory.</span></span><br><span class="line">  <span class="keyword">const</span> memoryManager = <span class="keyword">new</span> <span class="title class_">MemoryManager</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Instantiate the wasm module.</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(buf, &#123;</span><br><span class="line">    <span class="attr">env</span>: &#123;</span><br><span class="line">      <span class="comment">// The wasm module calls this function to grow the memory</span></span><br><span class="line">      <span class="attr">grow</span>: <span class="keyword">function</span>(<span class="params">blocks</span>) &#123;</span><br><span class="line">        memoryManager.<span class="title function_">grow</span>(blocks)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// The wasm module calls this function to get the current memory size.</span></span><br><span class="line">      <span class="attr">memoryBytesLength</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        memoryManager.<span class="title function_">memoryBytesLength</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the memory exports from the wasm instance.</span></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    memory,</span><br><span class="line">    allocateMemory,</span><br><span class="line">    freeMemory,</span><br><span class="line">    reportFreeMemory</span><br><span class="line">  &#125; = res.<span class="property">instance</span>.<span class="property">exports</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Give the memory manager access to the instances memory.</span></span><br><span class="line">  memoryManager.<span class="property">memory</span> = memory</span><br><span class="line"></span><br><span class="line">  <span class="comment">// How many free bytes are there?</span></span><br><span class="line">  <span class="keyword">const</span> startFreeMemoryBytes = <span class="title function_">reportFreeMemory</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`There are <span class="subst">$&#123;startFreeMemoryBytes&#125;</span> bytes of free memory`</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Get the exported array function.</span></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    addArrays</span><br><span class="line">  &#125; = res.<span class="property">instance</span>.<span class="property">exports</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Make the arrays to pass into the wasm function using allocateMemory.</span></span><br><span class="line">  <span class="keyword">const</span> length = <span class="number">5</span></span><br><span class="line">  <span class="keyword">const</span> bytesLength = length * <span class="title class_">Int32Array</span>.<span class="property">BYTES_PER_ELEMENT</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> array1 = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(memory.<span class="property">buffer</span>, <span class="title function_">allocateMemory</span>(bytesLength), length)</span><br><span class="line">  array1.<span class="title function_">set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> array2 = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(memory.<span class="property">buffer</span>, <span class="title function_">allocateMemory</span>(bytesLength), length)</span><br><span class="line">  array2.<span class="title function_">set</span>([<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the arrays. The result is the memory pointer to the result array.</span></span><br><span class="line">  result = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(</span><br><span class="line">    memory.<span class="property">buffer</span>,</span><br><span class="line">    <span class="title function_">addArrays</span>(array1.<span class="property">byteOffset</span>, array2.<span class="property">byteOffset</span>, length),</span><br><span class="line">    length)</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[<span class="subst">$&#123;array1.join(<span class="string">&quot;, &quot;</span>)&#125;</span>] + [<span class="subst">$&#123;array2.join(<span class="string">&quot;, &quot;</span>)&#125;</span>] = [<span class="subst">$&#123;result.join(<span class="string">&quot;, &quot;</span>)&#125;</span>]`</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Show that some memory has been used.</span></span><br><span class="line">  pctFree = <span class="number">100</span> * <span class="title function_">reportFreeMemory</span>() / startFreeMemoryBytes</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Free memory <span class="subst">$&#123;pctFree&#125;</span>%`</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Free the memory.</span></span><br><span class="line">  <span class="title function_">freeMemory</span>(array1.<span class="property">byteOffset</span>)</span><br><span class="line">  <span class="title function_">freeMemory</span>(array2.<span class="property">byteOffset</span>)</span><br><span class="line">  <span class="title function_">freeMemory</span>(result.<span class="property">byteOffset</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Show that all the memory has been released.</span></span><br><span class="line">  pctFree = <span class="number">100</span> * <span class="title function_">reportFreeMemory</span>() / startFreeMemoryBytes</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Free memory <span class="subst">$&#123;pctFree&#125;</span>%`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">main</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Done&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>That’s a lot of code!</p>
<p>Let’s get started with the memory management. The script starts declaring a<br><code>MemoryManagement</code> class.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryManager</span> &#123;</span><br><span class="line">  <span class="comment">// The WebAssembly.Memory object for the instance.</span></span><br><span class="line">  memory = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return the buffer length in bytes.</span></span><br><span class="line">  <span class="title function_">memoryBytesLength</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">memory</span>.<span class="property">buffer</span>.<span class="property">byteLength</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Grow the memory by the requested blocks, returning the new buffer length</span></span><br><span class="line">  <span class="comment">// in bytes.</span></span><br><span class="line">  <span class="title function_">grow</span>(<span class="params">blocks</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">memory</span>.<span class="title function_">grow</span>(blocks)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">memory</span>.<span class="property">buffer</span>.<span class="property">byteLength</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Once the <code>memory</code> property has been set it can provide the length in bytes of<br>the memory, and it can grow the memory for a given number of blocks returning<br>the new memory length in bytes.</p>
<p>We pass the functions when creating the wasm instance, and assign the memory<br>object once to instance is created.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> memoryManager = <span class="keyword">new</span> <span class="title class_">MemoryManager</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(buf, &#123;</span><br><span class="line">  <span class="attr">env</span>: &#123;</span><br><span class="line">    <span class="attr">grow</span>: <span class="keyword">function</span>(<span class="params">blocks</span>) &#123;</span><br><span class="line">      memoryManager.<span class="title function_">grow</span>(blocks)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">memoryBytesLength</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      memoryManager.<span class="title function_">memoryBytesLength</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">memoryManager.<span class="property">memory</span> = res.<span class="property">instance</span>.<span class="property">exports</span>.<span class="property">memory</span></span><br></pre></td></tr></table></figure>

<p>When we create the arrays we use the memory allocator.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> array1 = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(memory.<span class="property">buffer</span>, <span class="title function_">allocateMemory</span>(bytesLength), length)</span><br></pre></td></tr></table></figure>

<p>The memory gets freed with the complimentary function near the end of the<br>script.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">freeMemory</span>(array1.<span class="property">byteOffset</span>)</span><br></pre></td></tr></table></figure>

<p>Finally we can call our function and get the results.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">result = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(</span><br><span class="line">  memory.<span class="property">buffer</span>,</span><br><span class="line">  <span class="title function_">addArrays</span>(array1.<span class="property">byteOffset</span>, array2.<span class="property">byteOffset</span>, length),</span><br><span class="line">  length)</span><br></pre></td></tr></table></figure>

<p>Note that what gets returned is the point in memory where the array has been<br>stored, so we need to wrap it in an <code>Int32Array</code> object. And don’t forget to<br>free it!</p>
<h2 id="Outro"><a href="#Outro" class="headerlink" title="Outro"></a>Outro</h2><p>Well that was a lot of code.</p>
<p>Obviously we can wrap this all up in some library code to hide the complexity,<br>but what have we gained. I can’t say for sure, but if the array calculations<br>run at near native speed this could provide enormous performance gains.</p>
<p>I could (and probably should) have used a <code>libc</code> implementation instead of<br>implementing <code>malloc</code>. I decided not to because I think it kept the focus on<br>the array passing problem, and not on integrating with libraries, which is a<br>whole other discussion.</p>
<p>Good luck with your coding.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2020/06/07/wasm-arrays/" data-id="cma87l7fx0000wrjp1zjyg3mg" data-title="Passing arrays between wasm and JavaScript" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/C/" rel="tag">C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/array/" rel="tag">array</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/arrays/" rel="tag">arrays</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/blog/">&laquo; Prev</a><a class="page-number" href="/blog/">1</a><span class="page-number current">2</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Admin/">Admin</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Serialization/">Serialization</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/WebAssembly/">WebAssembly</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/7610/" rel="tag">7610</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/DataFrame/" rel="tag">DataFrame</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/FinalizationRegistry/" rel="tag">FinalizationRegistry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/NegotiateStream/" rel="tag">NegotiateStream</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Pydantic/" rel="tag">Pydantic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Serialization/" rel="tag">Serialization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/array/" rel="tag">array</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/arrays/" rel="tag">arrays</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/asyncio/" rel="tag">asyncio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/clang/" rel="tag">clang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/cross-compile/" rel="tag">cross-compile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/data/" rel="tag">data</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/dataframe/" rel="tag">dataframe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/datascience/" rel="tag">datascience</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/dell/" rel="tag">dell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/finalizer/" rel="tag">finalizer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/inspiron/" rel="tag">inspiron</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/libc/" rel="tag">libc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/llvm/" rel="tag">llvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/malloc/" rel="tag">malloc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/marshalling/" rel="tag">marshalling</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/memory/" rel="tag">memory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/science/" rel="tag">science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/series/" rel="tag">series</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ssl/" rel="tag">ssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/strings/" rel="tag">strings</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ubuntu/" rel="tag">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ubuntu-20-04/" rel="tag">ubuntu-20.04</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/vscode/" rel="tag">vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/wasi/" rel="tag">wasi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/wasi-sdk/" rel="tag">wasi-sdk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/wasm-libc/" rel="tag">wasm-libc</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/7610/" style="font-size: 10px;">7610</a> <a href="/blog/tags/C/" style="font-size: 17.5px;">C</a> <a href="/blog/tags/DataFrame/" style="font-size: 12.5px;">DataFrame</a> <a href="/blog/tags/FinalizationRegistry/" style="font-size: 11.25px;">FinalizationRegistry</a> <a href="/blog/tags/JavaScript/" style="font-size: 18.75px;">JavaScript</a> <a href="/blog/tags/NegotiateStream/" style="font-size: 10px;">NegotiateStream</a> <a href="/blog/tags/Pydantic/" style="font-size: 10px;">Pydantic</a> <a href="/blog/tags/Python/" style="font-size: 10px;">Python</a> <a href="/blog/tags/Serialization/" style="font-size: 10px;">Serialization</a> <a href="/blog/tags/WebAssembly/" style="font-size: 20px;">WebAssembly</a> <a href="/blog/tags/array/" style="font-size: 13.75px;">array</a> <a href="/blog/tags/arrays/" style="font-size: 13.75px;">arrays</a> <a href="/blog/tags/asyncio/" style="font-size: 11.25px;">asyncio</a> <a href="/blog/tags/clang/" style="font-size: 16.25px;">clang</a> <a href="/blog/tags/cross-compile/" style="font-size: 11.25px;">cross-compile</a> <a href="/blog/tags/data/" style="font-size: 11.25px;">data</a> <a href="/blog/tags/dataframe/" style="font-size: 11.25px;">dataframe</a> <a href="/blog/tags/datascience/" style="font-size: 10px;">datascience</a> <a href="/blog/tags/dell/" style="font-size: 10px;">dell</a> <a href="/blog/tags/finalizer/" style="font-size: 11.25px;">finalizer</a> <a href="/blog/tags/inspiron/" style="font-size: 10px;">inspiron</a> <a href="/blog/tags/libc/" style="font-size: 12.5px;">libc</a> <a href="/blog/tags/linux/" style="font-size: 10px;">linux</a> <a href="/blog/tags/llvm/" style="font-size: 10px;">llvm</a> <a href="/blog/tags/malloc/" style="font-size: 10px;">malloc</a> <a href="/blog/tags/marshalling/" style="font-size: 12.5px;">marshalling</a> <a href="/blog/tags/memory/" style="font-size: 10px;">memory</a> <a href="/blog/tags/python/" style="font-size: 11.25px;">python</a> <a href="/blog/tags/science/" style="font-size: 11.25px;">science</a> <a href="/blog/tags/series/" style="font-size: 10px;">series</a> <a href="/blog/tags/ssl/" style="font-size: 10px;">ssl</a> <a href="/blog/tags/strings/" style="font-size: 11.25px;">strings</a> <a href="/blog/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/blog/tags/ubuntu-20-04/" style="font-size: 10px;">ubuntu-20.04</a> <a href="/blog/tags/vscode/" style="font-size: 10px;">vscode</a> <a href="/blog/tags/wasi/" style="font-size: 11.25px;">wasi</a> <a href="/blog/tags/wasi-sdk/" style="font-size: 15px;">wasi-sdk</a> <a href="/blog/tags/wasm/" style="font-size: 18.75px;">wasm</a> <a href="/blog/tags/wasm-libc/" style="font-size: 12.5px;">wasm-libc</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2025/05/">May 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/06/">June 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2025/05/03/pydantic-generic-serialization/">Serializing Pydantic with Metadata and Generic Fields</a>
          </li>
        
          <li>
            <a href="/blog/2024/01/24/wasm-gsl/">Revisiting WebAssembly Cross Compilation in January 2024</a>
          </li>
        
          <li>
            <a href="/blog/2023/05/23/python-start_tls/">Using asyncio start_tls in Python 3.11</a>
          </li>
        
          <li>
            <a href="/blog/2022/12/21/python-negotiatestream-client/">A Python client for .Net NegotiateStream</a>
          </li>
        
          <li>
            <a href="/blog/2021/12/19/dell-inspiron-7610-linux/">Setting up a Dell Inspiron 16 Plus (7610) for Linux</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
        <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" /></a></br>
All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></br>
      
      &copy; 2025 Rob Blackbourn<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/blog/js/jquery-3.6.4.min.js"></script>



  
<script src="/blog/fancybox/jquery.fancybox.min.js"></script>




<script src="/blog/js/script.js"></script>





  </div>
</body>
</html>