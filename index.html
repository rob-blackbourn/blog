<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Robs Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Robs Blog">
<meta property="og:url" content="https://rob-blackbourn.github.io/blog/index.html">
<meta property="og:site_name" content="Robs Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Rob Blackbourn">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/blog/atom.xml" title="Robs Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/blog/favicon.png">
  
  
  
<link rel="stylesheet" href="/blog/css/style.css">

  
    
<link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

  
<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Robs Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          
            <a class="nav-icon" target="_blank" rel="noopener" href="https://github.com/rob-blackbourn"><span class="fa fa-github"></span></a>
          
            <a class="nav-icon" target="_blank" rel="noopener" href="https://www.linkedin.com/in/rob-blackbourn/"><span class="fa fa-linkedin"></span></a>
          
        
        
          <a class="nav-icon" href="/blog/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://rob-blackbourn.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-pydantic-generic-serialization" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2025/05/03/pydantic-generic-serialization/" class="article-date">
  <time class="dt-published" datetime="2025-05-03T11:05:00.000Z" itemprop="datePublished">2025-05-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/Serialization/">Serialization</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2025/05/03/pydantic-generic-serialization/">Serializing Pydantic with Metadata and Generic Fields</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>I recently need a solution for serializing and deserializing Python. We initially<br>used pickle, but it was always a stop-gap, and it became an issue for debugging.</p>
<p>We switched to <a target="_blank" rel="noopener" href="https://github.com/pydantic/pydantic">Pydantic</a>, which provided<br>JSON serialization, but it left a problem with generic fields.</p>
<p>We had messages like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Shape</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Color</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    background: <span class="built_in">str</span> = <span class="string">&quot;black&quot;</span></span><br><span class="line">    foreground: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Property</span>[T: BaseModel](BaseModel):</span><br><span class="line">    model: T</span><br></pre></td></tr></table></figure>

<p>This worked for pickle, as it squirrelled away the python metadata, but it was<br>out of scope for pydantic which wanted to know all the candidate types in order to<br>provide a <a target="_blank" rel="noopener" href="https://docs.pydantic.dev/latest/concepts/unions/">union</a>.</p>
<p>Fortunately pydantic provides custom serialization.</p>
<h2 id="The-Serializer"><a href="#The-Serializer" class="headerlink" title="The Serializer"></a>The Serializer</h2><p>Our serializer looks like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, ValidationInfo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serialize_model_to_dict</span>(<span class="params">model: BaseModel</span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    dct = model.model_dump(mode=<span class="string">&#x27;json&#x27;</span>)</span><br><span class="line">    dct[<span class="string">&#x27;__module__&#x27;</span>] = model.__class__.__module__</span><br><span class="line">    dct[<span class="string">&#x27;__qualname__&#x27;</span>] = model.__class__.__qualname__</span><br><span class="line">    <span class="keyword">return</span> dct</span><br></pre></td></tr></table></figure>

<p>The serializer allows us to separate the stages of JSON serialization. First we<br>break the object into a JSON style python dictionary (using <code>mode=&#39;json&#39;</code>),<br>which ensures all of the sub-components are supported by JSON. Then we add<br>the metadata: the class’s module name and qualified name worked well. We can<br>then pass this on to pydantic to handle the rest.</p>
<h2 id="The-deserializer"><a href="#The-deserializer" class="headerlink" title="The deserializer"></a>The deserializer</h2><p>In pydantic, deserialization is part of “validation”. The validation part<br>looked like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, ValidationInfo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deserialize_model_from_dict</span>(<span class="params">dct: <span class="built_in">dict</span></span>) -&gt; BaseModel:</span><br><span class="line">    module = dct.pop(<span class="string">&#x27;__module__&#x27;</span>)</span><br><span class="line">    qualname = dct.pop(<span class="string">&#x27;__qualname__&#x27;</span>)</span><br><span class="line">    cls = <span class="built_in">getattr</span>(importlib.import_module(module), qualname)</span><br><span class="line">    model = cls.model_validate(dct)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deserialize_model_from_json</span>(<span class="params">data: <span class="built_in">str</span> | <span class="built_in">bytes</span> | <span class="built_in">bytearray</span></span>) -&gt; BaseModel:</span><br><span class="line">    dct = json.loads(data)</span><br><span class="line">    model = deserialize_model_from_dict(dct)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_model</span>(<span class="params">value: BaseModel | <span class="built_in">dict</span> | <span class="built_in">str</span> | <span class="built_in">bytes</span> | <span class="built_in">bytearray</span>, info: ValidationInfo</span>) -&gt; BaseModel:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> info.mode:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;python&#x27;</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, BaseModel):</span><br><span class="line">                <span class="keyword">return</span> value</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(value, <span class="built_in">dict</span>):</span><br><span class="line">                <span class="keyword">return</span> deserialize_model_from_dict(value)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(</span><br><span class="line">                    <span class="string">f&quot;unhandled type for mode <span class="subst">&#123;info.mode&#125;</span>: <span class="subst">&#123;<span class="built_in">type</span>(value)&#125;</span>&quot;</span></span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;json&#x27;</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, (<span class="built_in">str</span>, <span class="built_in">bytes</span>, <span class="built_in">bytearray</span>)):</span><br><span class="line">                <span class="keyword">return</span> deserialize_model_from_json(value)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(value, <span class="built_in">dict</span>):</span><br><span class="line">                <span class="keyword">return</span> deserialize_model_from_dict(value)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(</span><br><span class="line">                    <span class="string">f&quot;unhandled type for mode <span class="subst">&#123;info.mode&#125;</span>: <span class="subst">&#123;<span class="built_in">type</span>(value)&#125;</span>&quot;</span></span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> _:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Invalid mode: <span class="subst">&#123;info.mode&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>There’s a bunch of code here. The key part is in <code>deserialize_model_from_dict</code><br>where we can see the inverse of the serialization. It takes the module name and<br>class name from the supplied dictionary and creates the model class, from which it validates<br>the model.</p>
<p>The rest of the code provides the plumbing for pydantic. The entrypoint is the<br><code>validate_model</code> function. This gets called via a number of different routes.<br>The first is when a python model is created, when the <code>info.mode</code> will be<br><code>&#39;python&#39;</code> and the value will be of type <code>BaseModel</code>.</p>
<p>The second is when JSON data is provided when the <code>info.mode</code> is <code>&#39;json&#39;</code> and<br>the type is some kind of text data.</p>
<p>The third is during serialization when a dictionary is generated by an<br>intermediate step. Here the <code>info.mode</code> will be either <code>&#39;python&#39;</code> or <code>&#39;json&#39;</code><br>and the type of the value is a <code>dict</code>.</p>
<h2 id="The-Model-Attributes"><a href="#The-Model-Attributes" class="headerlink" title="The Model Attributes"></a>The Model Attributes</h2><p>This all gets wired up in the following manner:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Annotated</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> (</span><br><span class="line">    BaseModel,</span><br><span class="line">    PlainSerializer,</span><br><span class="line">    PlainValidator</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .serialization <span class="keyword">import</span> serialize_model_to_dict, validate_model</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Update</span>[T: BaseModel](BaseModel):</span><br><span class="line">    model: Annotated[</span><br><span class="line">        T,</span><br><span class="line">        PlainSerializer(serialize_model_to_dict),</span><br><span class="line">        PlainValidator(validate_model)</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>

<p>Note how we have to use typing annotations to pass in the serializer and validator.</p>
<p>The generated JSON looks as follows:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; model = Update(</span><br><span class="line">    model=User(</span><br><span class="line">        name=<span class="string">&#x27;John Doe&#x27;</span>,</span><br><span class="line">        date_of_birth=datetime(<span class="number">1990</span>, <span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">        height=<span class="number">1.75</span></span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line">&gt;&gt; text = update.model_dump_json()</span><br><span class="line">&gt;&gt; <span class="built_in">print</span>(text)</span><br><span class="line">&#123;<span class="string">&quot;model&quot;</span>:&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;John Doe&quot;</span>,<span class="string">&quot;date_of_birth&quot;</span>:<span class="string">&quot;1990-01-01T00:00:00&quot;</span>,<span class="string">&quot;height&quot;</span>:<span class="number">1.75</span>,<span class="string">&quot;__module__&quot;</span>:<span class="string">&quot;kafka_ex1.models&quot;</span>,<span class="string">&quot;__qualname__&quot;</span>:<span class="string">&quot;User&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>We keep the dunder names to avoid collisions and to flatter the pythonistas.</p>
<h2 id="Whole-Message-Serialization"><a href="#Whole-Message-Serialization" class="headerlink" title="Whole Message Serialization"></a>Whole Message Serialization</h2><p>It turned out that it would be useful to know the meta data of the root message, as we wanted to save all the messages to a data store and replay them. This turned out to require just one extra function.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, ValidationInfo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serialize_model_to_dict</span>(<span class="params">model: BaseModel</span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    dct = model.model_dump(mode=<span class="string">&#x27;json&#x27;</span>)</span><br><span class="line">    dct[<span class="string">&#x27;__module__&#x27;</span>] = model.__class__.__module__</span><br><span class="line">    dct[<span class="string">&#x27;__qualname__&#x27;</span>] = model.__class__.__qualname__</span><br><span class="line">    <span class="keyword">return</span> dct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serialize_model_to_json_str</span>(<span class="params">model: BaseModel</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    dct = serialize_model_to_dict(model)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(dct)</span><br></pre></td></tr></table></figure>

<p>Now we can create the metadata at the root level.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>update = Update(model=user)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>serialize_model_to_json_str(update)</span><br><span class="line">&#123;<span class="string">&quot;model&quot;</span>: &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>, <span class="string">&quot;date_of_birth&quot;</span>: <span class="string">&quot;1990-01-01T00:00:00&quot;</span>, <span class="string">&quot;height&quot;</span>: <span class="number">1.75</span>, <span class="string">&quot;__module__&quot;</span>: <span class="string">&quot;demo.models&quot;</span>, <span class="string">&quot;__qualname__&quot;</span>: <span class="string">&quot;User&quot;</span>&#125;, <span class="string">&quot;__module__&quot;</span>: <span class="string">&quot;demo.models&quot;</span>, <span class="string">&quot;__qualname__&quot;</span>: <span class="string">&quot;Update&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>We can see there is metadata at the root level.</p>
<p>Finally we can do a full roundtrip with any base model:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>update = Update(model=user)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>text = serialize_model_to_json_str(update)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>roundtrip = deserialize_model_from_json(text)</span><br></pre></td></tr></table></figure>

<p>Now we can save and retrieve any model. Happy days!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2025/05/03/pydantic-generic-serialization/" data-id="cma87l7gb0058wrjpaosm1m2z" data-title="Serializing Pydantic with Metadata and Generic Fields" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Pydantic/" rel="tag">Pydantic</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Python/" rel="tag">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Serialization/" rel="tag">Serialization</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-wasm-gsl" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2024/01/24/wasm-gsl/" class="article-date">
  <time class="dt-published" datetime="2024-01-24T12:20:00.000Z" itemprop="datePublished">2024-01-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/WebAssembly/">WebAssembly</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2024/01/24/wasm-gsl/">Revisiting WebAssembly Cross Compilation in January 2024</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>I was recently contacted by someone trying to follow a<br><a href="https://rob-blackbourn.github.io/blog/2020/06/24/wasm-gsl/">previous blog</a><br>on cross compiling C to WebAssembly. Things weren’t working; it seemed that things had changed.</p>
<p>This is a short post to look at how to cross compile an open source library to WebAssembly<br>using the current tooling (as of 2024-01-07).</p>
<p>As before I’ll use the <a target="_blank" rel="noopener" href="https://www.gnu.org/software/gsl">GNU Scientific Library</a>,<br>which (at the time of writing) is version 2.7.1.</p>
<h2 id="The-toolchain"><a href="#The-toolchain" class="headerlink" title="The toolchain"></a>The toolchain</h2><p>As before I used the clang toolchain from <a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wasi-sdk">wasi-sdk</a>.<br>I downloaded <a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-21/wasi-sdk-21.0-linux.tar.gz">wasi-sdk-21.0-linux.tar.gz</a><br>and unpacked it to <code>$HOME/local/wasi-sdk-21.0</code>.</p>
<p>I put the following shell script in the root folder of the GSL.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">WASI_SDK_HOME=<span class="variable">$HOME</span>/local/wasi-sdk-21.0</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$WASI_SDK_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy the wasm aware config files.</span></span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$WASI_SDK_HOME</span>/share/misc/config.* .</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf ./build</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line"></span><br><span class="line">CC=clang \</span><br><span class="line">CFLAGS=<span class="string">&quot;-fno-trapping-math --sysroot=<span class="variable">$WASI_SDK_HOME</span>/share/wasi-sysroot -mthread-model single&quot;</span> \</span><br><span class="line">CPP=clang-cpp \</span><br><span class="line">AR=llvm-ar \</span><br><span class="line">RANLIB=llvm-ranlib \</span><br><span class="line">NM=llvm-nm \</span><br><span class="line">LD=wasm-ld \</span><br><span class="line">../configure \</span><br><span class="line">    --prefix=<span class="variable">$HOME</span>/local/gsl-2.7 \</span><br><span class="line">    --host=wasm32-wasi \</span><br><span class="line">    --enable-shared=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># build and install it.</span></span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>There are three key changes from the previous method.</p>
<p>First the <code>autoconf</code> config files in the root folder GSL are overwritten by<br>those in the <code>was-sdk</code> with <code>cp $WASI_SDK_HOME/share/misc/config.* .</code>.<br>This provides the information autoconf needs to configure the project for<br>WebAssembly.</p>
<p>Second the flags to the compiler are now <code>--sysroot=$WASI_SDK_HOME/share/wasi-sysroot</code>,<br>rather than the previous <code>--target=wasm32-wasi</code>.</p>
<p>Lastly <code>make</code> should be called before <code>make install</code> for the project to build correctly.</p>
<h2 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h2><p>I used the same example program as before.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gsl/gsl_sf_bessel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">double</span> x = <span class="number">5.0</span>;</span><br><span class="line">  <span class="type">double</span> y = gsl_sf_bessel_J0 (x);</span><br><span class="line">  <span class="built_in">printf</span> (<span class="string">&quot;J0(%g) = %.18e\n&quot;</span>, x, y);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The following script was used to compile it.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">WASI_SDK_HOME=<span class="variable">$HOME</span>/local/wasi-sdk-21.0</span><br><span class="line">GSL_HOME=<span class="variable">$HOME</span>/local/gsl-2.7</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$WASI_SDK_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line">clang \</span><br><span class="line">    example.c -o example \</span><br><span class="line">    -O2 --sysroot=<span class="variable">$WASI_SDK_HOME</span>/share/wasi-sysroot \</span><br><span class="line">    -I<span class="variable">$GSL_HOME</span>/include -L<span class="variable">$GSL_HOME</span>/lib -lgsl -lm -lc</span><br></pre></td></tr></table></figure>

<p>The executable was indeed WebAssembly.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file example</span><br><span class="line">example: WebAssembly (wasm) binary module version 0x1 (MVP)</span><br></pre></td></tr></table></figure>

<p>As before we can test it with <a target="_blank" rel="noopener" href="https://github.com/wasmerio/wasmer">wasmer</a>,<br>using <a target="_blank" rel="noopener" href="https://github.com/wasmerio/wasmer/releases/download/v4.2.5/wasmer-linux-amd64.tar.gz">wasmer-linux-amd64.tar.gz</a>.<br>version 4.2.5, and unpacked it to <code>$HOME/local/wasmer-4.2.5</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="variable">$HOME</span>/local/wasmer-4.2.5/bin/wasmer example </span><br><span class="line">J0(5) = -1.775967713143382642e-01</span><br></pre></td></tr></table></figure>

<p>Success!</p>
<h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>It was worth the effort re-visiting this. I think my original<br>post was incomplete (I suspect I had copied the config files<br>in the previous attempt and forgotten), but also there were<br>some real changes.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2024/01/24/wasm-gsl/" data-id="cma87l7gb0056wrjpgqwy1z3w" data-title="Revisiting WebAssembly Cross Compilation in January 2024" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/C/" rel="tag">C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/clang/" rel="tag">clang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/cross-compile/" rel="tag">cross-compile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasi-sdk/" rel="tag">wasi-sdk</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-python-start_tls" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/05/23/python-start_tls/" class="article-date">
  <time class="dt-published" datetime="2023-05-23T08:15:00.000Z" itemprop="datePublished">2023-05-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/Python/">Python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/05/23/python-start_tls/">Using asyncio start_tls in Python 3.11</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>An upgradable stream starts life as a plain old socket connection, but is capable of being “upgraded” to use Transport Layer Security (TLS). This is sometimes known as STARTTLS. Common examples of this are SMTP, LDAP, and HTTP proxy tunneling with CONNECT.</p>
<p>The has been broken in Python, but is fixed in version 3.11!</p>
<p>To make things work you will need an SSL certificate and key, and for that certificate to be trusted by a certificate chain.</p>
<p>You can find a gist for this <a target="_blank" rel="noopener" href="https://gist.github.com/rob-blackbourn/100dab4ebd7952c41e9bf2f078e6022b">here</a>.</p>
<h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><p>The server starts without TLS. When a client connects, the server responds to three messages:</p>
<ul>
<li><code>PING</code> — the server responds with <code>PONG</code>.</li>
<li><code>STARTLS</code> — the server upgrades the connection to TLS.</li>
<li><code>QUIT</code> — the server closes the client connection.</li>
</ul>
<p>Let’s see the code.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> asyncio <span class="keyword">import</span> StreamReader, StreamWriter</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="keyword">from</span> os.path <span class="keyword">import</span> expanduser</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_client</span>(<span class="params"></span></span><br><span class="line"><span class="params">        ctx: ssl.SSLContext,</span></span><br><span class="line"><span class="params">        reader: StreamReader,</span></span><br><span class="line"><span class="params">        writer: StreamWriter</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Client connected&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        request = (<span class="keyword">await</span> reader.readline()).decode(<span class="string">&#x27;utf8&#x27;</span>).rstrip()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Read &#x27;<span class="subst">&#123;request&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> request == <span class="string">&#x27;QUIT&#x27;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> request == <span class="string">&#x27;PING&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Sending pong&quot;</span>)</span><br><span class="line">            writer.write(<span class="string">b&#x27;PONG\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">await</span> writer.drain()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> request == <span class="string">&#x27;STARTTLS&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Upgrading connection to TLS&quot;</span>)</span><br><span class="line">            <span class="keyword">await</span> writer.start_tls(ctx)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Closing client&quot;</span>)</span><br><span class="line">    writer.close()</span><br><span class="line">    <span class="keyword">await</span> writer.wait_closed()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Client closed&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">run_server</span>():</span><br><span class="line">    ctx = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER)</span><br><span class="line">    ctx.load_verify_locations(cafile=<span class="string">&quot;/etc/ssl/certs/ca-certificates.crt&quot;</span>)</span><br><span class="line">    ctx.load_cert_chain(</span><br><span class="line">        expanduser(<span class="string">&quot;~/.keys/server.crt&quot;</span>),</span><br><span class="line">        expanduser(<span class="string">&quot;~/.keys/server.key&quot;</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    handler = partial(handle_client, ctx)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Starting server&quot;</span>)</span><br><span class="line">    server = <span class="keyword">await</span> asyncio.start_server(socket.getfqdn(), host, <span class="number">10001</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> server:</span><br><span class="line">        <span class="keyword">await</span> server.serve_forever()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.run(run_server())</span><br></pre></td></tr></table></figure>

<p>Looking at the <code>run_server</code> function, the first job is to build the SLL context. After creating the context, the certificate authority bundle is loaded, then the certificate and key.</p>
<p>The partial function binds the SSL context as the first argument to the <code>handle_client</code> callback.</p>
<p>The server is then started without TLS and set running. The fully qualified domain name (FQDN) is used for the host (the “any” address “0.0.0.0” would be fine, but the FQDN works better on Windows).</p>
<p>When a client connects the <code>handle_client</code> function is called. The function begins a loop. For each iteration the loop starts by reading a line from the client. If it reads <code>PING</code> it writes <code>PONG</code>. If it reads <code>QUIT</code> it breaks out of the loop and closes the connection. If it reads <code>STARTTLS</code> it calls <code>await start_tls(ctx)</code> to upgrade the connection. That’s all there is to it! Very neat.</p>
<h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><p>This time let’s start with the code.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">start_client</span>():</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Connect to the server with using the fully qualified domain name&quot;</span>)</span><br><span class="line">    reader, writer = <span class="keyword">await</span> asyncio.open_connection(socket.getfqdn(), <span class="number">10001</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;The server certificate is <span class="subst">&#123;writer.get_extra_info(<span class="string">&#x27;peercert&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Sending PING&quot;</span>)</span><br><span class="line">    writer.write(<span class="string">b&#x27;PING\n&#x27;</span>)</span><br><span class="line">    response = (<span class="keyword">await</span> reader.readline()).decode(<span class="string">&#x27;utf-8&#x27;</span>).rstrip()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Received: <span class="subst">&#123;response&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Sending STARTTLS&quot;</span>)</span><br><span class="line">    writer.write(<span class="string">b&#x27;STARTTLS\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Upgrade the connection to TLS&quot;</span>)</span><br><span class="line">    ctx = ssl.create_default_context(</span><br><span class="line">        purpose=ssl.Purpose.SERVER_AUTH,</span><br><span class="line">        cafile=<span class="string">&#x27;/etc/ssl/certs/ca-certificates.crt&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">await</span> writer.start_tls(ctx)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;The server certificate is <span class="subst">&#123;writer.get_extra_info(<span class="string">&#x27;peercert&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Sending PING&quot;</span>)</span><br><span class="line">    writer.write(<span class="string">b&#x27;PING\n&#x27;</span>)</span><br><span class="line">    response = (<span class="keyword">await</span> reader.readline()).decode(<span class="string">&#x27;utf-8&#x27;</span>).rstrip()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Received: <span class="subst">&#123;response&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Sending QUIT&quot;</span>)</span><br><span class="line">    writer.write(<span class="string">b&#x27;QUIT\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Closing client&quot;</span>)</span><br><span class="line">    writer.close()</span><br><span class="line">    <span class="keyword">await</span> writer.wait_closed()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Client disconnected&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.run(start_client())</span><br></pre></td></tr></table></figure>

<p>The client starts by opening a connection without TLS. As with the server the FQDN is used, but this time it’s important. When the client upgrades to TLS the host must match the certificate, so an IP address won’t work. There is a choice here though, as the <code>start_tls</code> call takes the host name as an optional argument. After connecting the client checks to see if there’s an SSL server certificate with <code>get_extra_info(“peercert”)</code> call. This should return <code>None</code>.</p>
<p>Next the client writes a <code>PING</code> to the server over the unencrypted stream and reads the result (which should be <code>PONG</code>).</p>
<p>The next step is to upgrade the connection. The client writes <code>STARTTLS</code> to instruct the server to start the handshake. An SSL context is then made, and the <code>start_tls(ctx)</code> function is called on the writer. The client then checks for an SSL server certificate with <code>get_extra_info(&quot;peercert”)</code> which should now exist.</p>
<p>The client then writes <code>PING</code> over the now encrypted stream and reads the result (which should be <code>PONG</code>).</p>
<p>Finally the client writes <code>QUIT</code> and closes the connection.</p>
<h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>It’s been a long time coming, but the result is so simple!</p>
<p>Good luck with your coding.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2023/05/23/python-start_tls/" data-id="cma87l7ga0054wrjph4x0axp3" data-title="Using asyncio start_tls in Python 3.11" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/asyncio/" rel="tag">asyncio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/python/" rel="tag">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/ssl/" rel="tag">ssl</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-python-negotiatestream-client" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2022/12/21/python-negotiatestream-client/" class="article-date">
  <time class="dt-published" datetime="2022-12-21T11:52:00.000Z" itemprop="datePublished">2022-12-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/Python/">Python</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2022/12/21/python-negotiatestream-client/">A Python client for .Net NegotiateStream</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>I find the .Net <code>NegotiateStream</code> class useful for internal services as it provides single sign on, authentication and basic encryption. However, as a python programmer, I couldn’t find a client library.</p>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>For the impatient the repo can be found on <a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/jetblack-negotiate-stream">GitHub</a>.</p>
<h1 id="The-Protocol"><a href="#The-Protocol" class="headerlink" title="The Protocol"></a>The Protocol</h1><p>I won’t go into detail regarding the protocol, but it has two key features: a handshake (during which credentials are exchanged), and then the encryption&#x2F;decryption of data sent&#x2F;received.</p>
<p>The handshake stage is widely used by Windows intranet servers to avoid the need for entering credentials, and involves the generation and consumption of tokens which are base64 encoded and passed as HTTP headers. I’ve done this before using the<br><a target="_blank" rel="noopener" href="https://github.com/jborean93/pyspnego">pyspnego</a> package<br>for the <a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/bareasgi-sspi">SSPI authentication</a> layer<br>of a Python web server. The SPNEGO client generates a token that is passed to the server, which responds with a new token, and so on until authentication is complete.</p>
<p>The wire protocol uses the same tokens, but has different “headers”. This was revealed by inspecting the code from the<br><a target="_blank" rel="noopener" href="https://github.com/ernw/net.tcp-proxy">net.tcp-proxy</a> project.<br>During the handshake the header takes the form:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">struct.pack(<span class="string">&quot;&gt;BBBH&quot;</span>, state, major, minor, payload_size)</span><br></pre></td></tr></table></figure>

<p>The state can be one of “done” (0x14), “error” (0x15) and “in progress” (0x16). The major.minor version is 1.0, and the payload size is the length of the generated token. When the handshake is complete the header changes to simply the payload size, but as an unsigned int.</p>
<p>Let’s look at some code! First I needed to handle the handshake header record.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> enum</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HandshakeState</span>(enum.IntEnum):</span><br><span class="line">    DONE = <span class="number">0x14</span></span><br><span class="line">    ERROR = <span class="number">0x15</span></span><br><span class="line">    IN_PROGRESS = <span class="number">0x16</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HandshakeRecord</span>:</span><br><span class="line"></span><br><span class="line">    FORMAT = <span class="string">&quot;&gt;BBBH&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">            self,</span></span><br><span class="line"><span class="params">            state: HandshakeState,</span></span><br><span class="line"><span class="params">            major: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">            minor: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">            payload_size: <span class="built_in">int</span></span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.state = state</span><br><span class="line">        self.major = major</span><br><span class="line">        self.minor = minor</span><br><span class="line">        self.payload_size = payload_size</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pack</span>(<span class="params">self</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="keyword">return</span> struct.pack(</span><br><span class="line">            self.FORMAT,</span><br><span class="line">            self.state,</span><br><span class="line">            self.major,</span><br><span class="line">            self.minor,</span><br><span class="line">            self.payload_size</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">unpack</span>(<span class="params">cls, buf: <span class="built_in">bytes</span></span>) -&gt; HandshakeRecord:</span><br><span class="line">        (state, major, minor, payload_size) = struct.unpack(cls.FORMAT, buf)</span><br><span class="line">        <span class="keyword">return</span> HandshakeRecord(state, major, minor, payload_size)</span><br><span class="line">With that, <span class="keyword">and</span> the <span class="built_in">help</span> of pyspnego I can implement reading <span class="keyword">and</span> writing.</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NegotiateStream</span>(<span class="title class_ inherited__">Stream</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, hostname: <span class="built_in">str</span>, socket_: socket.socket</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">super</span>().__init__(socket_)</span><br><span class="line">        self._handshake_state = HandshakeState.IN_PROGRESS</span><br><span class="line">        self._client = spnego.client(hostname=hostname)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">self, data: <span class="built_in">bytes</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> self._handshake_state == HandshakeState.IN_PROGRESS:</span><br><span class="line">            handshake = HandshakeRecord(self._handshake_state, <span class="number">1</span>, <span class="number">0</span>, <span class="built_in">len</span>(data))</span><br><span class="line">            header = handshake.pack()</span><br><span class="line">            self.send(header + data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">while</span> data:</span><br><span class="line">                chunk = self._client.wrap(data[:<span class="number">0xFC30</span>])</span><br><span class="line">                header = struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="built_in">len</span>(chunk.data))</span><br><span class="line">                self.send(header + chunk.data)</span><br><span class="line">                data = data[<span class="number">0xFC30</span>:]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">self</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="keyword">if</span> self._handshake_state == HandshakeState.DONE:</span><br><span class="line"></span><br><span class="line">            payload_size = struct.unpack(<span class="string">&#x27;&lt;I&#x27;</span>, self.recv(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line">            payload = self.recv(payload_size)</span><br><span class="line">            unencrypted = self._client.unwrap(payload)</span><br><span class="line">            <span class="keyword">return</span> unencrypted.data</span><br><span class="line"></span><br><span class="line">        buf = self.recv(struct.calcsize(HandshakeRecord.FORMAT))</span><br><span class="line">        handshake = HandshakeRecord.unpack(buf)</span><br><span class="line"></span><br><span class="line">        self._handshake_state = handshake.state</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self._handshake_state != HandshakeState.ERROR:</span><br><span class="line">            <span class="keyword">return</span> self.recv(handshake.payload_size)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> handshake.payload_size == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> IOError(<span class="string">&quot;Negotiate error&quot;</span>)</span><br><span class="line"></span><br><span class="line">        payload = self.recv(handshake.payload_size)</span><br><span class="line">        _, error = struct.unpack(<span class="string">&#x27;&gt;II&#x27;</span>, payload)</span><br><span class="line">        <span class="keyword">raise</span> IOError(<span class="string">f&quot;Negotiate error: <span class="subst">&#123;error&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>Note the different headers. When the handshake is “in progress” the handshake style of header is used. After authentication the shorter form is used, and the client has to encrypt and decrypt the data.</p>
<p>Finally the handshake itself.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NegotiateStream</span>:</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">authenticate_as_client</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        in_token: <span class="type">Optional</span>[<span class="built_in">bytes</span>] = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self._client.complete:</span><br><span class="line">            out_token = self._client.step(in_token)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self._client.complete:</span><br><span class="line">                self.write(out_token)</span><br><span class="line">                in_token = self.read()</span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>This turned out to be pretty simple!</p>
<p>I coded up a simple client:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> jetblack_negotiate_stream <span class="keyword">import</span> NegotiateStream</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    hostname = socket.gethostname()</span><br><span class="line">    port = <span class="number">8181</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> socket.socket(socket.AF_INET, socket.SOCK_STREAM) <span class="keyword">as</span> sock:</span><br><span class="line">        sock.connect((hostname, port))</span><br><span class="line"></span><br><span class="line">        stream = NegotiateStream(hostname, sock)</span><br><span class="line"></span><br><span class="line">        stream.authenticate_as_client()</span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> (<span class="string">b&#x27;first line&#x27;</span>, <span class="string">b&#x27;second line&#x27;</span>, <span class="string">b&#x27;third line&#x27;</span>):</span><br><span class="line">            stream.write(data)</span><br><span class="line">            response = stream.read()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Received: &quot;</span>, response)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Done&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>And a simple C# echo server:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Security;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NegotiateStreamServer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> listener = <span class="keyword">new</span> TcpListener(IPAddress.Any, <span class="number">8181</span>);</span><br><span class="line">            listener.Start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Listening ...&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> client = listener.AcceptTcpClient();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;... Client connected.&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;Authenticating...&quot;</span>);</span><br><span class="line">                    <span class="keyword">var</span> stream = <span class="keyword">new</span> NegotiateStream(client.GetStream(), <span class="literal">false</span>);</span><br><span class="line">                    stream.AuthenticateAsServer();</span><br><span class="line"></span><br><span class="line">                    Console.WriteLine(</span><br><span class="line">                        <span class="string">&quot;... &#123;0&#125; authenticated using &#123;1&#125;&quot;</span>,</span><br><span class="line">                        stream.RemoteIdentity.Name,</span><br><span class="line">                        stream.RemoteIdentity.AuthenticationType);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">4096</span>];</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">var</span> bytesRead = stream.Read(buf, <span class="number">0</span>, buf.Length);</span><br><span class="line">                        <span class="keyword">var</span> message = Encoding.UTF8.GetString(buf, <span class="number">0</span>, bytesRead);</span><br><span class="line">                        Console.WriteLine(message);</span><br><span class="line">                        stream.Write(buf, <span class="number">0</span>, bytesRead);</span><br><span class="line">                    &#125;</span><br><span class="line">                    stream.Close();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(ex.ToString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>What a lot of code the server is. If you run the server, then the client, you should see the handshake, and the messages passing to and fro, encrypted.</p>
<p>As most of my Python servers are async, I made a couple of async versions. One is a straight async version of the synchronous socket client. The second is more”asyncio” style. I won’t show the code here, but here is a demo program using it:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> jetblack_negotiate_stream <span class="keyword">import</span> open_negotiate_stream</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    hostname = socket.gethostname()</span><br><span class="line">    port = <span class="number">8181</span></span><br><span class="line"></span><br><span class="line">    reader, writer = <span class="keyword">await</span> open_negotiate_stream(hostname, port)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> data <span class="keyword">in</span> (<span class="string">b&#x27;first line&#x27;</span>, <span class="string">b&#x27;second line&#x27;</span>, <span class="string">b&#x27;third line&#x27;</span>):</span><br><span class="line">        writer.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer.drain()</span><br><span class="line">        response = <span class="keyword">await</span> reader.read()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Received: &quot;</span>, response)</span><br><span class="line"></span><br><span class="line">    writer.close()</span><br><span class="line">    <span class="keyword">await</span> writer.wait_closed()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>

<p>By using the same pattern as <code>asyncio.open_connection</code> the negotiation gets tidied away inside <code>open_negotiate_stream</code> providing a clean consistent interface.</p>
<p>If you find any bugs, or wish to add features, please post issues and pull requests to the repo.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2022/12/21/python-negotiatestream-client/" data-id="cma87l7ga0052wrjp7zwahns0" data-title="A Python client for .Net NegotiateStream" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/NegotiateStream/" rel="tag">NegotiateStream</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/asyncio/" rel="tag">asyncio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-dell-inspiron-7610-linux" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2021/12/19/dell-inspiron-7610-linux/" class="article-date">
  <time class="dt-published" datetime="2021-12-19T07:50:00.000Z" itemprop="datePublished">2021-12-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/Admin/">Admin</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2021/12/19/dell-inspiron-7610-linux/">Setting up a Dell Inspiron 16 Plus (7610) for Linux</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>I recently bought a Dell Inspiron 16 Plus (7610) for use with Linux.<br>There have been a number of issues that have been solved by smart people on the internet.<br>This is a short list of things that I have done to make things work.</p>
<p>I used the Ubuntu 21.10 distribution.</p>
<h2 id="Status"><a href="#Status" class="headerlink" title="Status"></a>Status</h2><p>The trackpad is sometimes still weird, but it doesn’t get in the way too much.</p>
<h2 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h2><ul>
<li>CPU: i7-11800H</li>
<li>Memory: 16G</li>
<li>Graphics: Intel UHD Graphics</li>
<li>Disk: 512GB</li>
</ul>
<p>Note: I specifically chose the Intel UHD graphics to avoid issues with proprietary NVIDIA drivers.</p>
<h2 id="This-issues"><a href="#This-issues" class="headerlink" title="This issues"></a>This issues</h2><p>I’ve installed Ubuntu 21.10.</p>
<ul>
<li>Secure boot</li>
<li>Flickering screen</li>
<li>Battery drain while lid closed</li>
<li>Short battery life when unplugged</li>
<li>Trackpad weirdness</li>
</ul>
<h3 id="Secure-boot"><a href="#Secure-boot" class="headerlink" title="Secure boot"></a>Secure boot</h3><p>This is the first laptop I’ve had with secure boot.<br>When installing Ubuntu 21.10 from a USB stick you get a prompt about “secure boot”.<br>I went off and googled this, and by the time I got back it had timed out and made a decision for me.<br>I installed a few times, but ended up just switching secure boot off in the BIOS settings.<br>This hasn’t caused me any problems.</p>
<h3 id="Flickering-Screen"><a href="#Flickering-Screen" class="headerlink" title="Flickering Screen"></a>Flickering Screen</h3><p>This is due to a kernel driver default setting.<br>You can find the answer and links to explanations <a target="_blank" rel="noopener" href="https://askubuntu.com/questions/1361640/screen-flickering-on-inspiron-16-plus-7610-after-installing-20-04-lts">here</a>.</p>
<p>I added the args <code>i915.enable_psr=0</code> to the grub command line in <code>/etc/default/grub</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash i915.enable_psr=0&quot;</span><br></pre></td></tr></table></figure>

<p>Then</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo update-grub</span><br><span class="line">$ reboot</span><br></pre></td></tr></table></figure>

<h3 id="Battery-drain-while-lid-closed"><a href="#Battery-drain-while-lid-closed" class="headerlink" title="Battery drain while lid closed"></a>Battery drain while lid closed</h3><p>I noticed the battery loosing power when the lid was closed and the power unplugged.<br>This seems to have something to do with the sleep mode the laptop enters.<br>I found an answer <a target="_blank" rel="noopener" href="https://www.reddit.com/r/Dell/comments/8b6eci/xp_13_9370_battery_drain_while_suspended/">here</a>.</p>
<p>I added the args <code>mem_sleep_default=deep</code> to the grub command line in <code>/etc/default/grub</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash i915.enable_psr=0 mem_sleep_default=deep&quot;</span><br></pre></td></tr></table></figure>

<p>Then</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo update-grub</span><br><span class="line">$ reboot</span><br></pre></td></tr></table></figure>

<h1 id="Short-battery-life-when-unplugged"><a href="#Short-battery-life-when-unplugged" class="headerlink" title="Short battery life when unplugged"></a>Short battery life when unplugged</h1><p>This is a problem with all Linux laptops, and it is not specific to the Dell. It seems the way manufacturers get a long battery life when unplugged<br>is by turning things down (like cpu frequency) or turning things off (like turbo boost). These get turned back up when<br>the system notices the load requirements have increased.</p>
<p>To solve this you need some power management software.<br>There are a number of packages out there. I went for<br><a target="_blank" rel="noopener" href="https://github.com/AdnanHodzic/auto-cpufreq">auto-cpufreq</a>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo snap install auto-cpufreq</span><br></pre></td></tr></table></figure>

<p>I also decided to add the boot flag <code>intel_pstate=disable</code> to <code>/etc/default/grub</code><br>as recommended.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash i915.enable_psr=0 mem_sleep_default=deep intel_pstate=disable&quot;</span><br></pre></td></tr></table></figure>

<p>Then</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo update-grub</span><br><span class="line">$ reboot</span><br></pre></td></tr></table></figure>

<p>The <a target="_blank" rel="noopener" href="https://wiki.debian.org/thermald">thermald</a> package is also<br>recommended, but that was already installed.</p>
<h3 id="Trackpad-weirdness"><a href="#Trackpad-weirdness" class="headerlink" title="Trackpad weirdness"></a>Trackpad weirdness</h3><p>Sometimes the trackpad is weird.<br>The cursor movement becomes unresponsive, and clicks don’t work.<br>It seems to be more of a problem when the laptop is plugged in, but this may be anecdotal.</p>
<p>There are two views on this.</p>
<h4 id="Power-Management"><a href="#Power-Management" class="headerlink" title="Power Management"></a>Power Management</h4><p>The first is that it is an issue with power management on the trackpad.<br>You can find a discussion of that <a target="_blank" rel="noopener" href="https://askubuntu.com/questions/1231126/touchpad-power-management-issue-sticky-cursor-input-detection-delay-autosus?newreg=19ccd4cd1c1e46f38af9124cc16e4c54">here</a>.</p>
<p>To address this I created a file <code>/lib/systemd/system/disable-trackpad-pm.service</code> with the contents:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Disables trackpad power management to work around input delays</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">ExecStart=/bin/sh -c &quot;echo on &gt; /sys/bus/i2c/devices/i2c-0/device/power/control&quot;</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>Then:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl daemon-reload</span><br><span class="line">$ sudo systemctl <span class="built_in">enable</span> disable-trackpad-pm</span><br><span class="line">$ reboot</span><br></pre></td></tr></table></figure>

<p>This has helped, but I still get the weirdness occasionally, especially when the laptop is plugged in.</p>
<h4 id="Mechanical"><a href="#Mechanical" class="headerlink" title="Mechanical"></a>Mechanical</h4><p>The second view is that there is a mechanical problem.<br>The thought is that the battery (which is positioned under the trackpad)<br>interferes with the trackpad.<br>One solution proposed is to add some material (often plastic) between the battery and the trackpad.<br>You can find the instructions <a target="_blank" rel="noopener" href="https://www.dell.com/community/Inspiron/Running-List-of-Inspiron-7610-Touchpad-Issue-Posts/m-p/8095040/highlight/true#M132906">here</a>.</p>
<p>I haven’t tried this yet, but I’m thinking about it, unless another driver issue gets found in the next month or so.</p>
<h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>I really like the laptop (apart from the numeric keypad; why?),<br>and it’s been frustrating battling through these issues.</p>
<p>I’m hoping someone gets to the bottom of the trackpad issue, as<br>this is an excellent machine and great value for money.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2021/12/19/dell-inspiron-7610-linux/" data-id="cma87l7ga0051wrjp77jv7ubk" data-title="Setting up a Dell Inspiron 16 Plus (7610) for Linux" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/7610/" rel="tag">7610</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/dell/" rel="tag">dell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/inspiron/" rel="tag">inspiron</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/linux/" rel="tag">linux</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-howto-llvm-vscode-ubuntu" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2021/07/04/howto-llvm-vscode-ubuntu/" class="article-date">
  <time class="dt-published" datetime="2021-07-04T13:36:00.000Z" itemprop="datePublished">2021-07-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/Admin/">Admin</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2021/07/04/howto-llvm-vscode-ubuntu/">How To Use clang With vscode On Ubuntu 20.04</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>I wanted to use the clang compiler for a C++ project, using vscode as the IDE;<br>simples? No!!!</p>
<p>I’m running Ubuntu 20.04, and it seemed the obvious approach was to install the<br>default llvm tool chain (<code>sudo app install llvm</code>), write the obligatory “hello<br>world” program, and go to the vscode debug page and click “create a launch.json<br>file”. So far so good. Now I hit the <em>play</em> button and I get the error “unable<br>to find &#x2F;usr&#x2F;local&#x2F;bin&#x2F;lldb-mi”. WTF?</p>
<p>Now we go down the rabbit hole. You may choose to take the blue pill and move<br>one, or skip to the <em>solution</em>.</p>
<h2 id="lldb-mi"><a href="#lldb-mi" class="headerlink" title="lldb-mi"></a>lldb-mi</h2><p>Googling the error provided some useful facts.</p>
<ul>
<li>lldb is the debugger for the llvm tool-chain,</li>
<li>lldb-mi is an executable which is not part of the base llvm project,</li>
<li>Ubuntu or llvm have stopped shipping this executable with the llvm package.</li>
</ul>
<p>Given we are C++ programmers and therefore not lightweight, we choose to build<br><a target="_blank" rel="noopener" href="https://github.com/lldb-tools/lldb-mi">lldb-mi</a>. After cloning the project<br>we get an error creating the cmake build file with the default gcc compiler<br>which complains about <code>lib_lldb</code>. Google has little to offer here. I bite the<br>bullet and decide to build the entire llvm tool-chain.</p>
<h2 id="llvm"><a href="#llvm" class="headerlink" title="llvm"></a>llvm</h2><p>After cloning llvm and following the build instructions the build starts using<br><code>gcc</code> as the compiler. I notice that 10% of the build has occurred in 10<br>minutes, so I go for a coffee. At some point the build crashes on my 12 core<br>64GB machine, as it runs out of memory!</p>
<p>After a little more googling I install the <code>lld</code> linker and set the build type<br>to “release” to reduce memory usage. I kick off the build again, and now I get<br>a compilation error complaining about <code>_Atomic</code> being undefined. Again googling<br>doesn’t help much, so I decide to use the llvm tool chain to build itself. After<br>installing llvm and setting the C and C++ compiler to clang&#x2F;clang++ I try again<br>and it works!</p>
<h2 id="lldb-mi-revisited"><a href="#lldb-mi-revisited" class="headerlink" title="lldb-mi revisited"></a>lldb-mi revisited</h2><p>Using my compiled llvm tool chain I can successfully compile <code>lldb-mi</code>, and<br>vscode now allows me to debug my program. Superb!</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>Install the llvm tool chain with the <code>lld</code> linker. Also use <code>ninja</code> instead of<br><code>make</code> (<code>cmake</code> should be installed already).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install lld</span><br><span class="line">sudo apt install llvm</span><br><span class="line">sudo apt install ninja-build</span><br></pre></td></tr></table></figure>

<p>Clone llvm and build it. I used version 12.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth 1 --branch release/12.x git@github.com:llvm/llvm-project.git</span><br><span class="line"><span class="built_in">cd</span> llvm-project</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">LLVM_PROJECTS=<span class="string">&quot;clang;clang-tools-extra;compiler-rt;debuginfo-tests;libc;libclc;libcxx;libcxxabi;libunwind;lld;lldb;mlir;openmp;parallel-libs;polly;pstl&quot;</span></span><br><span class="line">LLVM_TARGETS=<span class="string">&quot;X86&quot;</span></span><br><span class="line">INSTALL_PREFIX=<span class="variable">$HOME</span>/local/llvm-12.0.0</span><br><span class="line">C_COMPILER=/usr/bin/clang</span><br><span class="line">CXX_COMPILER=/usr/bin/clang++</span><br><span class="line">LINKER=lld</span><br><span class="line">cmake \</span><br><span class="line">    -G Ninja \</span><br><span class="line">    -DCMAKE_INSTALL_PREFIX=<span class="variable">$INSTALL_PREFIX</span> \</span><br><span class="line">    -DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">    -DLLVM_USE_LINKER=<span class="variable">$LINKER</span> \</span><br><span class="line">    -DCMAKE_C_COMPILER=<span class="variable">$C_COMPILER</span> \</span><br><span class="line">    -DCMAKE_CXX_COMPILER=<span class="variable">$CXX_COMPILER</span> \</span><br><span class="line">    -DLLVM_ENABLE_PROJECTS=<span class="string">&quot;<span class="variable">$LLVM_PROJECTS</span>&quot;</span> \</span><br><span class="line">    -DLLVM_TARGETS_TO_BUILD=<span class="string">&quot;<span class="variable">$LLVM_TARGETS</span>&quot;</span> \</span><br><span class="line">    ../llvm</span><br><span class="line">cmake --build .</span><br><span class="line">cmake --build . --target install</span><br></pre></td></tr></table></figure>

<p>Build lldb-mi:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@github.com:lldb-tools/lldb-mi.git</span><br><span class="line"><span class="built_in">cd</span> lldb-mi</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake -G Ninja -DCMAKE_INSTALL_PREFIX=<span class="variable">$INSTALL_PREFIX</span> ..</span><br><span class="line">cmake --build .</span><br><span class="line">cmake --build . --target install</span><br></pre></td></tr></table></figure>

<p>Assuming you have the tool-chain on your path:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$HOME</span>/local/lvmm-12.0.0/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p>The vscode generated files looked like this:</p>
<p><code>launch.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// Use IntelliSense to learn about possible attributes.</span></span><br><span class="line">    <span class="comment">// Hover to view descriptions of existing attributes.</span></span><br><span class="line">    <span class="comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;clang++ - Build and debug active file&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;fileDirname&#125;/$&#123;fileBasenameNoExtension&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;fileDirname&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;externalConsole&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;MIMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lldb&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;setupCommands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Enable pretty-printing for gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-enable-pretty-printing&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;ignoreFailures&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;preLaunchTask&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C/C++: clang++ build active file&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;miDebuggerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/rob/local/llvm-12.0.0/bin/lldb-mi&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>tasks.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;tasks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppbuild&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C/C++: clang++ build active file&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/home/rob/local/llvm-12.0.0/bin/clang++&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;-g&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;$&#123;file&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;-o&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;$&#123;fileDirname&#125;/$&#123;fileBasenameNoExtension&#125;&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;fileDirname&#125;&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;problemMatcher&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;$gcc&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;isDefault&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;detail&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Task generated by Debugger.&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0.0&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Epilogue"><a href="#Epilogue" class="headerlink" title="Epilogue"></a>Epilogue</h2><p>It’s a day of my life that I won’t get back, but I’m loving the speed of the<br>compiler and the more sensible error messages.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2021/07/04/howto-llvm-vscode-ubuntu/" data-id="cma87l7g2000kwrjpcubecs2k" data-title="How To Use clang With vscode On Ubuntu 20.04" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/clang/" rel="tag">clang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/llvm/" rel="tag">llvm</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/ubuntu/" rel="tag">ubuntu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/ubuntu-20-04/" rel="tag">ubuntu-20.04</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/vscode/" rel="tag">vscode</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-wasm-dataframes-finalizers" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2020/07/15/wasm-dataframes-finalizers/" class="article-date">
  <time class="dt-published" datetime="2020-07-15T10:51:00.000Z" itemprop="datePublished">2020-07-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/WebAssembly/">WebAssembly</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2020/07/15/wasm-dataframes-finalizers/">Using Typed Arrays and Finalizers with a WebAssembly DataFrame</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In my previous posts on data frames we looked at how to:</p>
<ul>
<li><a href="https://rob-blackbourn.github.io/blog/2020/06/10/example-js-dataframe/">Create an expressive syntax using operator overloading and proxies</a></li>
<li><a href="https://rob-blackbourn.github.io/blog/2020/06/13/wasm-dataframes/">Use WebAssembly for efficient array calculations</a></li>
<li><a href="https://rob-blackbourn.github.io/blog/2020/06/14/wasm-dataframe-libc/">Use libc with WebAssembly</a></li>
</ul>
<p>The main problem with that implementation was the marshalling layer which was<br>hand written. It required all arrays to be copied in and out of the WebAssembly<br>instance, with manual allocation and freeing of memory.</p>
<p>This implementation introduces a marshalling layer which makes use of the<br><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/FinalizationRegistry">FinzalizationRegistry</a><br>which provides a callback for managing the destruction of objects.</p>
<p>You can find the source code <a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/example-wasm-dataframe-3">here</a>. To run the examples you will need a version of<br>node which supports the <code>--harmony-weak-refs</code> flag (I’m using 14.5.0), the<br><a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wasi-sdk">wasi-sdk 11</a><br>(with it’s bin directory on your path) and the<br><a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wabt">wabt 1.0.16</a><br>toolkit (with it’s bin directory on your path).</p>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p>You can find more information about the implementation of the marshalling layer in<br><a href="https://rob-blackbourn.github.io/blog/2020/07/07/wasi-finalizers-1/">this post</a>.<br>What I want to talk about here is <em>usability</em>.</p>
<p>Rather than bundle a fixed set of functions with the data frame I wanted it to be a structural object where the functions are<br>provided by an extensible repository. This way the user<br>isn’t limited to the operations defined by the data frame implementation.</p>
<p>A <code>C</code> function for multiplying two arrays might be written as follows -</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((used)) <span class="type">double</span>* <span class="title function_">divideFloat64Arrays</span> <span class="params">(<span class="type">double</span>* array1, <span class="type">double</span>* array2, <span class="type">unsigned</span> <span class="type">int</span> length)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">double</span>* result = (<span class="type">double</span>*) <span class="built_in">malloc</span>(length * <span class="keyword">sizeof</span>(<span class="type">double</span>));</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">    result[i] = array1[i] + array2[i];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The functions are registered in JavaScript as follows -</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">DataFrame</span>.<span class="title function_">registerFunction</span>(</span><br><span class="line">  <span class="comment">// The function or operation name.</span></span><br><span class="line">  <span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&#x27;/&#x27;</span>),</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">FunctionPrototype</span>(</span><br><span class="line">    <span class="comment">// The arguments</span></span><br><span class="line">    [</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">In</span>(<span class="keyword">new</span> <span class="title class_">TypedArrayType</span>(<span class="keyword">new</span> <span class="title class_">Float64Type</span>(), <span class="literal">null</span>)),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">In</span>(<span class="keyword">new</span> <span class="title class_">TypedArrayType</span>(<span class="keyword">new</span> <span class="title class_">Float64Type</span>(), <span class="literal">null</span>)),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">In</span>(<span class="keyword">new</span> <span class="title class_">Uint32Type</span>())</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">// The return type with automatic length discovery.</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">TypedArrayType</span>(<span class="keyword">new</span> <span class="title class_">Float64Type</span>(), <span class="function">(<span class="params">i, args</span>) =&gt;</span> args[<span class="number">2</span>])</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// The bound function</span></span><br><span class="line">  wasi.<span class="property">instance</span>.<span class="property">exports</span>.<span class="property">divideFloat64Arrays</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>which allows the following -</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> df = <span class="title class_">DataFrame</span>.<span class="title function_">fromObject</span>(</span><br><span class="line">  <span class="comment">// The data</span></span><br><span class="line">  [</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;mary&#x27;</span>, <span class="attr">height</span>: <span class="number">175.2</span>, <span class="attr">weight</span>: <span class="number">65.1</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">name</span>: <span class="string">&#x27;fred&#x27;</span>, <span class="attr">height</span>: <span class="number">183.7</span>, <span class="attr">weight</span>: <span class="number">82.2</span> &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// The types</span></span><br><span class="line">  &#123; <span class="attr">name</span>: <span class="title class_">Array</span>, <span class="attr">height</span>: <span class="title class_">Float32Array</span>, <span class="attr">weight</span>: <span class="title class_">Float64Array</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Calculations are performed by the bound function in the WebAssembly instance</span></span><br><span class="line">df[<span class="string">&#x27;approx_density&#x27;</span>] = df[<span class="string">&#x27;height&#x27;</span>] / df[<span class="string">&#x27;weight&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>Functions can also be added for performing calculations directly in JavaScript.<br>For example -</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Series</span>.<span class="title function_">registerFunction</span>(</span><br><span class="line">  <span class="comment">// The function name</span></span><br><span class="line">  <span class="title class_">Symbol</span>.<span class="title function_">for</span>(<span class="string">&#x27;**&#x27;</span>),</span><br><span class="line">  <span class="comment">// A null prototype is used for JavaScript functions</span></span><br><span class="line">  <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// The bound function implemented in JavaScript</span></span><br><span class="line">  <span class="function">(<span class="params">lhs, rhs, length</span>) =&gt;</span> lhs.<span class="title function_">map</span>(<span class="function">(<span class="params">value, index</span>) =&gt;</span> value ** rhs))</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> height = <span class="title class_">Series</span>.<span class="title function_">from</span>(<span class="string">&#x27;height&#x27;</span>, [<span class="number">1.82</span>, <span class="number">1.72</span>, <span class="number">1.64</span>, <span class="number">1.88</span>], <span class="title class_">Float64Array</span>)</span><br><span class="line"><span class="keyword">const</span> sqrHeight = height ** <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>There is a restriction on function prototypes. The first argument is always the<br>array from the first series, and the last argument is always the length of the<br>first array.</p>
<p>Although we have used <code>Symbol.for</code> to define the function for names that map to<br>an operation, we can use a string for arbitrary calculations -</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Series</span>.<span class="title function_">registerFunction</span>(</span><br><span class="line">  <span class="comment">// The function name</span></span><br><span class="line">  <span class="string">&#x27;fillna&#x27;</span>,</span><br><span class="line">  <span class="comment">// A null prototype is used for JavaScript functions</span></span><br><span class="line">  <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// The bound function implemented in JavaScript</span></span><br><span class="line">  <span class="function">(<span class="params">lhs, fill, length</span>) =&gt;</span> lhs.<span class="title function_">map</span>(<span class="function"><span class="params">value</span> =&gt;</span> <span class="title class_">Number</span>.<span class="built_in">isNaN</span>(value) ? fill : value))</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> height = <span class="title class_">Series</span>.<span class="title function_">from</span>(<span class="string">&#x27;height&#x27;</span>, [<span class="number">1.82</span>, <span class="number">1.72</span>, <span class="title class_">Number</span>.<span class="property">NaN</span>, <span class="number">1.88</span>], <span class="title class_">Float64Array</span>)</span><br><span class="line"><span class="keyword">const</span> maxHeight = height.<span class="title function_">fillna</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h3 id="The-WASI-Marshaller"><a href="#The-WASI-Marshaller" class="headerlink" title="The WASI Marshaller"></a>The WASI Marshaller</h3><p>In order for the data frame to be aware of the WebAssembly instance and the<br>associated marshalling support, it must be initialized.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Read the wasm file.</span></span><br><span class="line"><span class="keyword">const</span> buf = fs.<span class="title function_">readFileSync</span>(fileName)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the Wasi instance passing in environment variables.</span></span><br><span class="line"><span class="keyword">const</span> envVars = &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> wasi = <span class="keyword">new</span> <span class="title class_">Wasi</span>(envVars)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Instantiate the wasm module.</span></span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(buf, &#123;</span><br><span class="line">  <span class="attr">wasi_snapshot_preview1</span>: wasi.imports()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize the wasi instance</span></span><br><span class="line">wasi.<span class="title function_">init</span>(res.<span class="property">instance</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register the functions</span></span><br><span class="line"><span class="title function_">registerUnmarshalledFunctions</span>(wasi)</span><br><span class="line"><span class="title function_">registerInt32Functions</span>(wasi)</span><br><span class="line"><span class="title function_">registerFloat64Functions</span>(wasi)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize the data frame</span></span><br><span class="line"><span class="title class_">DataFrame</span>.<span class="title function_">init</span>(wasm)</span><br></pre></td></tr></table></figure>

<h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>Efficiency has improved enormously. As typed arrays are visible both<br>within the JavaScript interpreter and the WebAssembly instance, we only need to<br>pass the <em>reference</em> to the arrays when performing WebAssembly calculations. The<br>finalizer support means we don’t need to manually allocate, copy and free memory.</p>
<p>We’ve done all this without adding a much clutter beyond specifying the series<br>type. This could be improved by adding some heuristics to guess the types.</p>
<p>All this means it’s easier to use the power of WebAssembly without adding to<br>much burden to the data scientist.</p>
<p>While there is still much left to do (indices, selecting, support for more types<br>such as timestamps), this feels like a good step forward.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2020/07/15/wasm-dataframes-finalizers/" data-id="cma87l7g1000fwrjpduh29rny" data-title="Using Typed Arrays and Finalizers with a WebAssembly DataFrame" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/C/" rel="tag">C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/FinalizationRegistry/" rel="tag">FinalizationRegistry</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/clang/" rel="tag">clang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/data/" rel="tag">data</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/dataframe/" rel="tag">dataframe</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/finalizer/" rel="tag">finalizer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/marshalling/" rel="tag">marshalling</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/science/" rel="tag">science</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/series/" rel="tag">series</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasi/" rel="tag">wasi</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasi-sdk/" rel="tag">wasi-sdk</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-wasi-finalizers-1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2020/07/07/wasi-finalizers-1/" class="article-date">
  <time class="dt-published" datetime="2020-07-07T07:19:00.000Z" itemprop="datePublished">2020-07-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/WebAssembly/">WebAssembly</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2020/07/07/wasi-finalizers-1/">WASI Marshalling with Finalizers</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>In my<br><a href="https://rob-blackbourn.github.io/blog/2020/07/02/wasi-marshalling/">previous post</a><br>I described a marshalling library I’d written for WebAssembly (see<br><a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/jetblack-wasi-marshalling">here</a> for the source). There’s one<br>problem I have with it; too much copying!</p>
<p>But there’s a good reason for the copying. In order to ensure all allocated memory<br>is freed, the marshaller goes through three steps: allocating memory and<br>copying data, calling the function, then copying results and freeing the memory.<br>Without this control memory will leak.</p>
<p>Enter finalizers …</p>
<h2 id="FinalizationRegistry"><a href="#FinalizationRegistry" class="headerlink" title="FinalizationRegistry"></a>FinalizationRegistry</h2><p>Until recently there has been no way to hook into the end of a JavaScript<br>object’s lifecycle. There is a “stage 3” proposal that is going into production:<br><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/FinalizationRegistry">FinalizationRegistry</a>.<br>This is currently available in node (since 13.0.0), but must be enabled with the<br>flag “–harmony-weak-refs”.<br>It should be available in chrome (84), and firefox (79) in a few days.</p>
<p>When an object registers with the finalization registry it gets called back when<br>the object gets garbage collected. If we register our WebAssembly objects then we<br>can free the memory we have allocated when the garbage gets collected.</p>
<h2 id="How-does-finalizing-work"><a href="#How-does-finalizing-work" class="headerlink" title="How does finalizing work?"></a>How does finalizing work?</h2><p>I tried and tried to get finalizing to work. The following called the finalizer<br>cleanup function, but only when the program exited.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// run with node --harmony-weak-refs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> unfinalizedTags = <span class="keyword">new</span> <span class="title class_">Set</span>()<span class="keyword">let</span> counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> registry = <span class="keyword">new</span> <span class="title class_">FinalizationRegistry</span>(<span class="function"><span class="params">held</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;cleanup&#x27;</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> tag <span class="keyword">of</span> held) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(tag)</span><br><span class="line">    unfinalizedTags.<span class="title function_">delete</span>(tag)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Nohting gets finalized here.</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> counter = <span class="number">0</span>; counter &lt; <span class="number">1000</span>; ++counter) &#123;</span><br><span class="line">  <span class="keyword">let</span> array = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1000000</span>)</span><br><span class="line">  <span class="keyword">const</span> tag = <span class="string">&quot;tag&quot;</span> + counter</span><br><span class="line">  unfinalizedTags.<span class="title function_">add</span>(tag)</span><br><span class="line">  <span class="comment">// Register with the finalizer.</span></span><br><span class="line">  registry.<span class="title function_">register</span>(array, tag)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">    array[i] = <span class="title class_">Math</span>.<span class="title function_">random</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> sum = array.<span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, value</span>) =&gt;</span> acc + value, <span class="number">0</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(sum / array.<span class="property">length</span>, counter)</span><br><span class="line">  array = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The finalizer gets called with all the registered objects on exit.</span></span><br></pre></td></tr></table></figure>

<p>The following <em>does</em> call the finalizer while the code is running.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unfinalizedTags = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"><span class="keyword">let</span> counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> registry = <span class="keyword">new</span> <span class="title class_">FinalizationRegistry</span>(<span class="function"><span class="params">held</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;cleanup&#x27;</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> tag <span class="keyword">of</span> held) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(tag)</span><br><span class="line">    unfinalizedTags.<span class="title function_">delete</span>(tag)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">makePointlessGarbage</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> array = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1000000</span>)</span><br><span class="line">  <span class="keyword">const</span> tag = <span class="string">&quot;tag&quot;</span> + counter++</span><br><span class="line">  unfinalizedTags.<span class="title function_">add</span>(tag)</span><br><span class="line">  registry.<span class="title function_">register</span>(array, tag)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">    array[i] = <span class="title class_">Math</span>.<span class="title function_">random</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> sum = array.<span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, value</span>) =&gt;</span> acc + value, <span class="number">0</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(sum / array.<span class="property">length</span>, counter)</span><br><span class="line">  array = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">if</span> (counter &lt; <span class="number">100</span>) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(makePointlessGarbage, <span class="number">10</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`unfinalizedTags.size=<span class="subst">$&#123;unfinalizedTags.size&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(makePointlessGarbage, <span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p>This version calls the finalizer as the program is running but doesn’t finalize<br>on exit, leaving some objects unfinalized. I’m not so concerned about the<br>unfinalized objects with respect to memory management, as the WebAssembly<br>instance will be destroyed on exit.</p>
<p>It seems that the program needs to<br>give up control (with <code>setTimeout</code>) to allow the garbage collection to run. It<br>also seems that the cleanup function gets passed an iterable of values to free,<br>which is not how I read the documentation.</p>
<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><h3 id="Arrays"><a href="#Arrays" class="headerlink" title="Arrays"></a>Arrays</h3><p>Here is how we might un-marshall an array using the copy then free pattern.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">unmarshall (memoryManager, address, array) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Create a temporary typed array</span></span><br><span class="line">    <span class="keyword">const</span> typedArray = <span class="keyword">new</span> <span class="variable language_">this</span>.<span class="property">type</span>.<span class="title class_">TypedArrayType</span>(</span><br><span class="line">      memoryManager.<span class="property">memory</span>.<span class="property">buffer</span>,</span><br><span class="line">      address,</span><br><span class="line">      array.<span class="property">length</span>)</span><br><span class="line">    <span class="comment">// Return a copy of the array.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(typedArray)</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// Free the memory</span></span><br><span class="line">    memoryManager.<span class="title function_">free</span>(address)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We can change this to simply register the object for freeing. Note that creating the typed array is not really creating the array: it just provides a <em>view</em> into the<br>memory of the <em>element type</em> we want.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">unmarshall (memoryManager, address, array) &#123;</span><br><span class="line">  <span class="comment">// Create a typed array</span></span><br><span class="line">  <span class="keyword">const</span> typedArray = <span class="keyword">new</span> <span class="variable language_">this</span>.<span class="property">type</span>.<span class="title class_">TypedArrayType</span>(</span><br><span class="line">    memoryManager.<span class="property">memory</span>.<span class="property">buffer</span>,</span><br><span class="line">    address,</span><br><span class="line">    array.<span class="property">length</span>)</span><br><span class="line">  <span class="comment">// register for cleanup</span></span><br><span class="line">  memoryManager.<span class="title function_">freeWhenFinalized</span>(typedArray, address)</span><br><span class="line">  <span class="comment">// Return the typed array</span></span><br><span class="line">  <span class="keyword">return</span> typedArray</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This implementation is much more lightweight. In the previous version there was<br>a point in time where both arrays existed in memory, which could be a problem<br>for big data. However the “copy then free” version could resolve arrays of pointers, as<br>the <code>Array</code> can hold references to other arrays, rather than just numbers.</p>
<h3 id="Strings"><a href="#Strings" class="headerlink" title="Strings"></a>Strings</h3><p>Strings present a minor problem. Once we have un-marshalled a byte array to a<br>string we have nowhere to keep the address from the WebAssembly instance. To<br>solve this I created a <code>StringBuffer</code> which is an extension of <code>Uint8Array</code>,<br>with a couple of class methods for marshalling and un-marshalling, and an<br>instance method to decode the string.</p>
<h3 id="Pointers"><a href="#Pointers" class="headerlink" title="Pointers"></a>Pointers</h3><p>I implemented an <code>AddressType</code> which simply sets the contents of a <code>Pointer</code> to<br>the address. This works, but feels like a weak solution. I need some more use<br>cases before I know what to do here.</p>
<h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>We can now pass typed arrays, strings and pointers between JavaScript and a<br>WebAssembly instance with the memory being cleaned up through the garbage<br>collector and finalizers.</p>
<p>This is a huge win for big data applications, as only one copy of the data needs<br>to exist, reducing the memory footprint, and time spent copying between domains.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2020/07/07/wasi-finalizers-1/" data-id="cma87l7gb005awrjp1qela1vt" data-title="WASI Marshalling with Finalizers" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/C/" rel="tag">C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/FinalizationRegistry/" rel="tag">FinalizationRegistry</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/clang/" rel="tag">clang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/finalizer/" rel="tag">finalizer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/marshalling/" rel="tag">marshalling</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasi/" rel="tag">wasi</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasi-sdk/" rel="tag">wasi-sdk</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-wasi-marshalling" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2020/07/02/wasi-marshalling/" class="article-date">
  <time class="dt-published" datetime="2020-07-02T19:06:00.000Z" itemprop="datePublished">2020-07-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/WebAssembly/">WebAssembly</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2020/07/02/wasi-marshalling/">WASI Marshalling</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>In this series of posts I’ve done a lot of experimentation. An element which<br>I’ve had to implement a number of times is calling functions defined in a<br>WebAssembly module.</p>
<p>Calling a WebAssembly function involves transferring data to an instance,<br>calling a function, and retrieving the results. This is known as marshalling.</p>
<p>The source code for the examples can be found<br><a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/example-wasi-marshalling">here</a><br>and the marshalling package<br><a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/jetblack-wasi-marshalling">here</a>.</p>
<h2 id="Our-First-C-Function"><a href="#Our-First-C-Function" class="headerlink" title="Our First C Function"></a>Our First C Function</h2><p>Here is an example function written in C and compiled to WebAssembly.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((used)) <span class="type">double</span>* <span class="title function_">multipleFloat64ArraysReturningPtr</span> <span class="params">(</span></span><br><span class="line"><span class="params">    <span class="type">double</span>* array1,</span></span><br><span class="line"><span class="params">    <span class="type">double</span>* array2, </span></span><br><span class="line"><span class="params">    <span class="type">int</span> length)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">double</span>* result = (<span class="type">double</span>*) <span class="built_in">malloc</span>(length * <span class="keyword">sizeof</span>(<span class="type">double</span>));</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">    result[i] = array1[i] + array2[i];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>At the highest level the function takes two floating point arrays which it<br>multiplies and returns the result. At a lower level, two pointers to double<br>arrays are passed with a length. A result pointer is allocated with the required<br>length in which the result is stored. Finally the pointer to the result array<br>is returned.</p>
<p>To make this happen, first memory has to be allocated for the two input arrays<br>in the WebAssembly module. The data must then be copied into the arrays. When<br>the function is called it creates a third array by allocating space in the<br>WebAssembly. The pointer to this memory is then returned. The JavaScript must<br>copy the result array, then free the two input arrays and the result array.</p>
<h2 id="Our-First-JavaScript-Prototype"><a href="#Our-First-JavaScript-Prototype" class="headerlink" title="Our First JavaScript Prototype"></a>Our First JavaScript Prototype</h2><p>I’ve written a package to simplify the marshalling of data between JavaScript<br>and WebAssembly. Here is how to create a binding for the function.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> proto = <span class="keyword">new</span> <span class="title class_">FunctionPrototype</span>(</span><br><span class="line">    [</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">In</span>(<span class="keyword">new</span> <span class="title class_">ArrayType</span>(<span class="keyword">new</span> <span class="title class_">Float64Type</span>())),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">In</span>(<span class="keyword">new</span> <span class="title class_">ArrayType</span>(<span class="keyword">new</span> <span class="title class_">Float64Type</span>())),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">In</span>(<span class="keyword">new</span> <span class="title class_">Int32Type</span>())</span><br><span class="line">    ],</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ArrayType</span>(<span class="keyword">new</span> <span class="title class_">Float64Type</span>(), <span class="number">4</span>))</span><br></pre></td></tr></table></figure>

<p>This matches the <code>C</code> prototype.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((used)) <span class="type">double</span>* <span class="title function_">multipleFloat64ArraysReturningPtr</span> <span class="params">(</span></span><br><span class="line"><span class="params">    <span class="type">double</span>* array1,</span></span><br><span class="line"><span class="params">    <span class="type">double</span>* array2, </span></span><br><span class="line"><span class="params">    <span class="type">int</span> length)</span></span><br></pre></td></tr></table></figure>

<p>Note that the return type also declares the length of the returned array. The<br><code>C</code> function will only return a pointer to the start of the array, so we need<br>the length. In the real world we’d probably make a function out of prototypes<br>that require length parameters.</p>
<p>We can invoke the function as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = proto.<span class="title function_">invoke</span>(</span><br><span class="line">  wasi.<span class="property">memoryManager</span>,</span><br><span class="line">  wasi.<span class="property">instance</span>.<span class="property">exports</span>.<span class="property">multipleFloat64ArraysReturningPtr</span>,</span><br><span class="line">  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">  [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>],</span><br><span class="line">  <span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>As well as the function arguments we provide <code>wasi.memoryManager</code> to allow<br>access to the WebAssembly memory and <code>wasi.instance</code> to retrieve the function.</p>
<p>When the function is invoked three things happen. First the input arguments are<br><em>marshalled</em>. Memory is allocated for each array, and the array data is copied<br>into that memory. The integer value can be passed directly.</p>
<p>Second the function is called with the marshalled arguments and the return value<br>is received.</p>
<p>Third the memory for the input arguments is freed, the result value is copied<br>from the WebAssembly memory to a JavaScript array, and the memory that was<br>allocated inside the WebAssembly instance is freed.</p>
<h2 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h2><p>While not strictly part of WASI, memory management is the first problem to<br>solve. When a WebAssembly module is instantiated a memory buffer is either<br>passed, or created by the instance. When using the WASM standard library<br>provided by <a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wasi-libc">wasi-libc</a> the memory<br>management functions <code>malloc</code> and <code>free</code> can be exported from the instance.</p>
<p>After instantiation they are held in the following class.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryManager</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (memory, malloc, free) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">memory</span> = memory</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">malloc</span> = malloc</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">free</span> = free</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dataView</span> = <span class="keyword">new</span> <span class="title class_">DataView</span>(<span class="variable language_">this</span>.<span class="property">memory</span>.<span class="property">buffer</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>An array of floats might be marshalled as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">marshallFloat64Array</span>(<span class="params">memoryManager, array</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> address = memoryManager.<span class="title function_">malloc</span>(<span class="title class_">Float64Array</span>.<span class="property">BYTES_PER_ELEMENT</span> * array.<span class="property">length</span>)</span><br><span class="line">  <span class="keyword">const</span> typedArray = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(memoryManager.<span class="property">memory</span>.<span class="property">buffer</span>, address, array.<span class="property">length</span>)</span><br><span class="line">  typedArray.<span class="title function_">set</span>(array)</span><br><span class="line">  <span class="keyword">return</span> address</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>An array that was allocated inside the WebAssembly instance might be<br>un-marshalled as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">unmarshallFloat64Array</span>(<span class="params">memoryManager, address, length</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> typedArray = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(memoryManager.<span class="property">memory</span>.<span class="property">buffer</span>, address, length)</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(typedArray)</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    memoryManager.<span class="title function_">free</span>(address)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Our-Second-C-Function"><a href="#Our-Second-C-Function" class="headerlink" title="Our Second C Function"></a>Our Second C Function</h2><p>Here is our second <code>C</code> function.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((used)) <span class="type">void</span> <span class="title function_">multipleFloat64ArraysWithOutputArray</span> <span class="params">(<span class="type">double</span>* array1, <span class="type">double</span>* array2, <span class="type">double</span>* result, <span class="type">int</span> length)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">    result[i] = array1[i] + array2[i];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This time the calling function allocates the memory for the output array and<br>passes it in.</p>
<h2 id="Our-Second-JavaScript-Function-Prototype"><a href="#Our-Second-JavaScript-Function-Prototype" class="headerlink" title="Our Second JavaScript Function Prototype"></a>Our Second JavaScript Function Prototype</h2><p>The JvaScript function prototype looks as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> proto2 = <span class="keyword">new</span> <span class="title class_">FunctionPrototype</span>(</span><br><span class="line">  [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">In</span>(<span class="keyword">new</span> <span class="title class_">ArrayType</span>(<span class="keyword">new</span> <span class="title class_">Float64Type</span>())),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">In</span>(<span class="keyword">new</span> <span class="title class_">ArrayType</span>(<span class="keyword">new</span> <span class="title class_">Float64Type</span>())),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Out</span>(<span class="keyword">new</span> <span class="title class_">ArrayType</span>(<span class="keyword">new</span> <span class="title class_">Float64Type</span>())),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">In</span>(<span class="keyword">new</span> <span class="title class_">Int32Type</span>())</span><br><span class="line">  ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>We don’t need to provide a return type as nothing is returned. The <em>output</em><br>argument is wrapped in an <code>Out</code> class to inform the marshaller to unpack it<br>after the function is called.</p>
<p>The function is called as follows.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> output = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">4</span>)</span><br><span class="line">proto2.<span class="title function_">invoke</span>(</span><br><span class="line">  wasi.<span class="property">memoryManager</span>,</span><br><span class="line">  wasi.<span class="property">instance</span>.<span class="property">exports</span>.<span class="property">multipleFloat64ArraysWithOutputArray</span>,</span><br><span class="line">  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">  [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>],</span><br><span class="line">  output,</span><br><span class="line">  <span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>Because we supplied the output array with the correct length, we didn’t need<br>to supply a length argument to <code>ArrayType</code>.</p>
<h2 id="Where’s-WASI"><a href="#Where’s-WASI" class="headerlink" title="Where’s WASI?"></a>Where’s WASI?</h2><p>So far there’s been no need for WASI. That ends with strings.</p>
<p>WASI enters the picture when we need to leave the WebAssembly sandbox and<br>interact with the system in which we’re running. It’s not obvious why this<br>should happen with strings. In JavaSCript strings use UTF-8. As soon<br>as we need to decode a string the C standard library will want to know about<br>our <em>locale</em> (our language environment). To do this it it checks the environment<br>variables, which exist outside the sandbox!</p>
<p>This introduces the first of our system call requirement: <code>environ_sizes_get</code><br>and <code>environ_get</code>. The first call finds the amount of space required to store<br>the environment variables; the second fetches them.</p>
<p>The other need for WASI is when the code interacts with stdout&#x2F;stderr. While<br>we might think this is unnecessary, it is common for C libraries to report<br>errors through the <code>perror</code> function which returns and error and reports the<br>cause to stderr.</p>
<p>There are a small bunch of functions we need to support here. The final outcome<br>is the following set of imports to the WebAssembly.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">WebAssembly</span>.<span class="title function_">instantiate</span>(buf, &#123;</span><br><span class="line">  <span class="attr">wasi_snapshot_preview1</span>: &#123;</span><br><span class="line">    <span class="attr">environ_get</span>: <span class="function">(<span class="params">environ, environBuf</span>) =&gt;</span> wasi.<span class="title function_">environ_get</span>(environ, environBuf),</span><br><span class="line">    <span class="attr">environ_sizes_get</span>: <span class="function">(<span class="params">environCount, environBufSize</span>) =&gt;</span> wasi.<span class="property">environ_sizes_getnvironCount</span>, environBufSize),</span><br><span class="line">    <span class="attr">proc_exit</span>: <span class="function"><span class="params">rval</span> =&gt;</span> wasi.<span class="title function_">proc_exit</span>(rval),</span><br><span class="line">    <span class="attr">fd_close</span>: <span class="function"><span class="params">fd</span> =&gt;</span> wasi.<span class="title function_">fd_close</span>(fd),</span><br><span class="line">    <span class="attr">fd_seek</span>: <span class="function">(<span class="params">fd, offset_low, offset_high, whence, newOffset</span>) =&gt;</span> wasi.<span class="title function_">fd_seek</span>(fd, fset_low, offset_high, whence, newOffset),</span><br><span class="line">    <span class="attr">fd_write</span>: <span class="function">(<span class="params">fd, iovs, iovsLen, nwritten</span>) =&gt;</span> wasi.<span class="title function_">fd_write</span>(fd, iovs, iovsLen, ritten),</span><br><span class="line">    <span class="attr">fd_fdstat_get</span>: <span class="function">(<span class="params">fd, stat</span>) =&gt;</span> wasi.<span class="title function_">fd_fdstat_get</span>(fd, stat)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>With this relatively small set of imports we can import the vast majority of<br>publicly available C libraries.</p>
<h2 id="Strings-Stdout-Stderr"><a href="#Strings-Stdout-Stderr" class="headerlink" title="Strings &amp; Stdout&#x2F;Stderr"></a>Strings &amp; Stdout&#x2F;Stderr</h2><p>You can check out the source code fore the implementations and use of these.<br>They are not typically use from JavaScript, and are only provided to allow<br>imported C libraries to run.</p>
<h2 id="Wiring-It-Up"><a href="#Wiring-It-Up" class="headerlink" title="Wiring It Up"></a>Wiring It Up</h2><p>The example project shows how this works with node and in the browser. Here’s<br>the browser version.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="title class_">Wasi</span>,</span><br><span class="line">    <span class="title class_">Float64Type</span>,</span><br><span class="line">    <span class="title class_">ArrayType</span>,</span><br><span class="line">    <span class="title class_">Int32Type</span>,</span><br><span class="line">    <span class="title class_">StringType</span>,</span><br><span class="line">    <span class="title class_">FunctionPrototype</span>,</span><br><span class="line">    <span class="title class_">In</span>,</span><br><span class="line">    <span class="title class_">Out</span></span><br><span class="line">&#125; = wasiMarshalling</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the Wasi instance passing in environment variables.</span></span><br><span class="line"><span class="keyword">const</span> wasi = <span class="keyword">new</span> <span class="title class_">Wasi</span>(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Instantiate the wasm module.</span></span><br><span class="line"><span class="title class_">WebAssembly</span>.<span class="title function_">instantiateStreaming</span>(</span><br><span class="line">  <span class="title function_">fetch</span>(<span class="string">&#x27;example.wasm&#x27;</span>), &#123;</span><br><span class="line">    <span class="attr">wasi_snapshot_preview1</span>: wasi.imports()</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Initialise the wasi instance</span></span><br><span class="line">    wasi.<span class="title function_">init</span>(res.<span class="property">instance</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The first example takes in two arrays on the same length and</span></span><br><span class="line">    <span class="comment">// multiplies them, returning a third array.</span></span><br><span class="line">    <span class="keyword">const</span> proto1 = <span class="keyword">new</span> <span class="title class_">FunctionPrototype</span>(</span><br><span class="line">      [</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">In</span>(<span class="keyword">new</span> <span class="title class_">ArrayType</span>(<span class="keyword">new</span> <span class="title class_">Float64Type</span>())),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">In</span>(<span class="keyword">new</span> <span class="title class_">ArrayType</span>(<span class="keyword">new</span> <span class="title class_">Float64Type</span>())),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">In</span>(<span class="keyword">new</span> <span class="title class_">Int32Type</span>())</span><br><span class="line">      ],</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">ArrayType</span>(<span class="keyword">new</span> <span class="title class_">Float64Type</span>(), <span class="number">4</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result1 = proto1.<span class="title function_">invoke</span>(</span><br><span class="line">      wasi.<span class="property">memoryManager</span>,</span><br><span class="line">      wasi.<span class="property">instance</span>.<span class="property">exports</span>.<span class="property">multipleFloat64ArraysReturningPtr</span>,</span><br><span class="line">      [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">      [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>],</span><br><span class="line">      <span class="number">4</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(result1)</span><br><span class="line">    ...</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>We’ve got a generic marshalling layer between JavaScript and WebAssembly which<br>is pretty cool! We’ve also got enough WASI to drop in publicly available<br><code>C</code> libraries.</p>
<p>We’ve not yet addressed C++ libraries and we’re waiting for the <code>flang</code> compiler<br>to be incorporated into the <code>llvm</code> toolchain, so there’s a way to go before we<br>have access to everything we need to use JavaSCript to do real work with<br>native libraries.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2020/07/02/wasi-marshalling/" data-id="cma87l7g1000cwrjpgkp39nkk" data-title="WASI Marshalling" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/C/" rel="tag">C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/clang/" rel="tag">clang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/marshalling/" rel="tag">marshalling</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasi-sdk/" rel="tag">wasi-sdk</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-wasm-gsl" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2020/06/24/wasm-gsl/" class="article-date">
  <time class="dt-published" datetime="2020-06-24T16:48:00.000Z" itemprop="datePublished">2020-06-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blog/categories/WebAssembly/">WebAssembly</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2020/06/24/wasm-gsl/">How to Cross Compile a C library to WebAssembly for use with JavaScript</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>In this post I’ll explore how to use an existing C library in a JavaScript with WebAssembly.</p>
<p>This uses information from previous posts for<br><a href="https://rob-blackbourn.github.io/blog/2020/06/14/wasm-dataframe-libc/">dataframes</a>,<br>and<br><a href="https://rob-blackbourn.github.io/blog/2020/06/20/wasm-stdout-stderr/">wasi</a>.</p>
<p>You can find the source code<br><a target="_blank" rel="noopener" href="https://github.com/rob-blackbourn/example-wasm-gsl">here</a>.</p>
<h2 id="The-Toolchain"><a href="#The-Toolchain" class="headerlink" title="The Toolchain"></a>The Toolchain</h2><p>In this example I used the ready made clang toolchain from<br><a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wasi-sdk">wasi-sdk</a>. I downloaded<br><a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-11/wasi-sdk-11.0-linux.tar.gz">wasi-sdk-11.0-linux.tar.gz</a><br>and unpacked it in <code>/opt/wasi-sdk</code> as follows.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">wget https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-11/wasi-sdk-11.0-linux.tar.gz</span><br><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line">sudo tar xvf /tmp/wasi-sdk-11.0-linux.tar.gz</span><br><span class="line">sudo <span class="built_in">ln</span> -s wasi-sdk-11.0 wasi-sdk</span><br><span class="line"><span class="built_in">rm</span> /tmp/wasi-sdk-11.0-linux.tar.gz</span><br></pre></td></tr></table></figure>

<p>I also installed <a target="_blank" rel="noopener" href="https://github.com/WebAssembly/wabt">wabt 1.0.16</a>, and<br><a target="_blank" rel="noopener" href="https://github.com/wasmerio/wasmer">wasmer</a>, and unpacked them in &#x2F;opt. I then<br>put the <code>bin</code> directories from all on my path.</p>
<h2 id="Cross-Compiling"><a href="#Cross-Compiling" class="headerlink" title="Cross Compiling"></a>Cross Compiling</h2><p>I decided to use the<br><a target="_blank" rel="noopener" href="https://www.gnu.org/software/gsl">GNU Scientific Library</a><br>as it is written in plain old C, and I can use it to further the<br><a href="https://rob-blackbourn.github.io/blog/2020/06/14/wasm-dataframe-libc/">dataframes</a><br>project I have discuessed in previous posts.</p>
<p>Compiling it proved to be remarkably straightforward. After downloading and<br>unpacking the tarball I did the following.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ensure wasi-sdk is on the path</span></span><br><span class="line"><span class="built_in">export</span> PATH=/opt/wasi-sdk/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Go to the project folder and make a build folder.</span></span><br><span class="line"><span class="built_in">cd</span> gsl-2.6</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure the project setting the clang toolchain</span></span><br><span class="line">CC=clang \</span><br><span class="line">CFLAGS=<span class="string">&quot;-fno-trapping-math --target=wasm32-wasi -mthread-model single&quot;</span> \</span><br><span class="line">CPP=clang-cpp \</span><br><span class="line">AR=llvm-ar \</span><br><span class="line">RANLIB=llvm-ranlib \</span><br><span class="line">NM=llvm-nm \</span><br><span class="line">LD=wasm-ld \</span><br><span class="line">../configure \</span><br><span class="line">    --prefix=/opt/gsl-2.6 \</span><br><span class="line">    --host=wasm32-wasi \</span><br><span class="line">    --enable-shared=no</span><br><span class="line"></span><br><span class="line"><span class="comment"># build and install it (you need to have permissions to /opt/gsl-2.6)</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>Amazingly that just worked. The result of the install was the folder<br><code>/opt/gsl-2.6</code> with three sub-folders: <code>include</code>, <code>lib</code>, and <code>share</code>.</p>
<h2 id="Testing-the-Static-Library"><a href="#Testing-the-Static-Library" class="headerlink" title="Testing the Static Library"></a>Testing the Static Library</h2><p>I created an <code>example.c</code> with the following contents taken from the<br><a target="_blank" rel="noopener" href="https://www.gnu.org/software/gsl/doc/html/usage.html#an-example-program">gsl documentation</a>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gsl/gsl_sf_bessel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">double</span> x = <span class="number">5.0</span>;</span><br><span class="line">  <span class="type">double</span> y = gsl_sf_bessel_J0 (x);</span><br><span class="line">  <span class="built_in">printf</span> (<span class="string">&quot;J0(%g) = %.18e\n&quot;</span>, x, y);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I compiled this in the following manner (using the wasi-sdk clang).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang example.c -o example -O2 --target=wasm32-wasi -I/opt/gsl-2.6/include -L/opt/gsl-2.6/lib -lgsl -lm -lc</span><br></pre></td></tr></table></figure>

<p>No errors! But is it really a wasm file? We can test with the <code>file</code> utility.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file ./example</span><br><span class="line">example: WebAssembly (wasm) binary module version 0x1 (MVP)</span><br></pre></td></tr></table></figure>

<p>This is all very cool, but what’s in the static library? Let’s take a look.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Make sure we&#x27;re using the llvm archive function.</span></span><br><span class="line">$ <span class="built_in">which</span> ar</span><br><span class="line">/opt/wasi-sdk/bin/ar</span><br><span class="line"><span class="comment"># Find the first file in the library.</span></span><br><span class="line">$ ar t /opt/gsl-2.6/lib/libgsl.a | <span class="built_in">head</span> -1</span><br><span class="line">version.o</span><br><span class="line"><span class="comment"># Extract the file</span></span><br><span class="line">$ ar xv /opt/gsl-2.6/lib/libgsl.a version.o</span><br><span class="line">x - version.o</span><br><span class="line"><span class="comment"># What kind of object file is it?</span></span><br><span class="line">$ file version.o</span><br><span class="line">version.o: WebAssembly (wasm) binary module version 0x1 (MVP)</span><br></pre></td></tr></table></figure>

<p>It seems that the “object” files are themselves wasm, which get linked in to the<br>finaly module, which is itself wasm. Interesting!</p>
<p>We can run the “executable” file with <code>wasmer</code>. Wasmer is a runtime engine for WebAssembly<br>modules.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /opt/wasmer/bin/wasmer example1</span><br><span class="line">J0(5) = -1.775967713143382642e-01</span><br></pre></td></tr></table></figure>

<p>It works :) Let’s see how to use the library in our JavaScript code.</p>
<h2 id="Create-the-JavaScript"><a href="#Create-the-JavaScript" class="headerlink" title="Create the JavaScript"></a>Create the JavaScript</h2><p>This is definately TL;DR</p>
<p>Making a concise example of this would have been much shorted, but I’m exploring<br>the data science possibilities of WebAssembly, so what I’ve done is wire the<br>functions in to my growing dataframe&#x2F;series code.</p>
<p>First I need to create a helper to call aggregate functions. I do this in<br>the file <code>wasi-memorymanager.js</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WasmMemoryManager</span> &#123;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="title function_">invokeAggregateFunction</span>(<span class="params">func, array, typedArrayType</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> input = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      input = <span class="variable language_">this</span>.<span class="title function_">createTypedArray</span>(typedArrayType, array.<span class="property">length</span>)</span><br><span class="line">      input.<span class="title function_">set</span>(array)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">func</span>(input.<span class="property">byteOffset</span>, array.<span class="property">length</span>)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">free</span>(input.<span class="property">byteOffset</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To use the aggregate function I add it to the <code>setup-wasi.js</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">arrayMethods.<span class="title function_">set</span>(</span><br><span class="line">  <span class="string">&#x27;mean&#x27;</span>,</span><br><span class="line">  <span class="title function_">makeAggregateOperation</span>(</span><br><span class="line">    wasi.<span class="property">wasiMemoryManager</span>,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    <span class="function">(<span class="params">array, length</span>) =&gt;</span> <span class="title function_">gsl_stats_mean</span>(array, <span class="number">1</span>, length),</span><br><span class="line">    <span class="function">(<span class="params">series</span>) =&gt;</span> series.<span class="property">array</span>.<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b, <span class="number">0</span>) / series.<span class="property">array</span>.<span class="property">length</span></span><br><span class="line">  )</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>You can see here I’m calling the raw gsl function <code>gsl_stats_mean</code> (I needed the<br>arrow function to provide a <code>stride</code> parameter of <code>1</code>). What I want to show is<br>that there is little or no requirement for a binding library. We’re using generic<br>marshalling code.</p>
<p>The <code>Series.js</code> needs a small patch to handle functions that return a single<br>value, rather than a new series. I added a check for the return value of the<br>function.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Series</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">...</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="variable language_">this</span>, &#123;</span><br><span class="line">      <span class="attr">get</span>: <span class="function">(<span class="params">obj, prop, receiver</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(obj, prop, receiver)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (arrayMethods.<span class="title function_">has</span>(prop)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> [value, type] = arrayMethods.<span class="title function_">get</span>(prop)(obj, ...args)</span><br><span class="line">            <span class="keyword">if</span> (value <span class="keyword">instanceof</span> <span class="title class_">Array</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Series</span>(<span class="string">&#x27;&#x27;</span>, value, type)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// An aggregated value</span></span><br><span class="line">              <span class="keyword">return</span> value</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(obj.<span class="property">array</span>, prop, receiver.<span class="property">array</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      ...</span><br></pre></td></tr></table></figure>

<h2 id="Dude-Where’s-My-Function"><a href="#Dude-Where’s-My-Function" class="headerlink" title="Dude Where’s My Function?"></a>Dude Where’s My Function?</h2><p>Ideally we would like to call the function without any extra effort, but a<br>function from a static library will not be included in the final module unless<br>there is a reference to it. This means we need a C file to create a reference so<br>it gets exported. I did this as follows.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gsl/gsl_statistics.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">force_gsl_imports</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span>* funcs[] = &#123;</span><br><span class="line">      gsl_stats_mean</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is all we need to ensure the function is included in the emitted wasm module. A<br>specific binding function is unnecessary.</p>
<h2 id="The-example-program"><a href="#The-example-program" class="headerlink" title="The example program"></a>The example program</h2><p>Now we just need to see if it works.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> height = <span class="keyword">new</span> <span class="title class_">Series</span>(<span class="string">&#x27;height&#x27;</span>, [<span class="number">1.82</span>, <span class="number">1.72</span>, <span class="number">1.64</span>, <span class="number">1.88</span>], <span class="string">&#x27;double&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> avg = height.<span class="title function_">mean</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;mean&#x27;</span>, avg)</span><br></pre></td></tr></table></figure>

<p>Success!</p>
<h2 id="Thoughts"><a href="#Thoughts" class="headerlink" title="Thoughts"></a>Thoughts</h2><p>The thing that surprised me the most was how simple it was to create the static<br>library (although it’s possible I just got lucky with the library I chose).</p>
<p>My example was too verbose, But I’m hoping you’re following the journey with me<br>and have read my previous posts.</p>
<p>The gsl already provides a BLAS library, so we could write a JavaScript matrix<br>class and do linear algebra. My hope is that the anticipated FORTRAN compiler<br>(flang) will be just as easy to create a library from.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rob-blackbourn.github.io/blog/2020/06/24/wasm-gsl/" data-id="cma87l7gb005cwrjp6ii37tc2" data-title="How to Cross Compile a C library to WebAssembly for use with JavaScript" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/C/" rel="tag">C</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/clang/" rel="tag">clang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/cross-compile/" rel="tag">cross-compile</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasi-sdk/" rel="tag">wasi-sdk</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><a class="extend next" rel="next" href="/blog/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Admin/">Admin</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Serialization/">Serialization</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/WebAssembly/">WebAssembly</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/7610/" rel="tag">7610</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/DataFrame/" rel="tag">DataFrame</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/FinalizationRegistry/" rel="tag">FinalizationRegistry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/NegotiateStream/" rel="tag">NegotiateStream</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Pydantic/" rel="tag">Pydantic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Serialization/" rel="tag">Serialization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/array/" rel="tag">array</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/arrays/" rel="tag">arrays</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/asyncio/" rel="tag">asyncio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/clang/" rel="tag">clang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/cross-compile/" rel="tag">cross-compile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/data/" rel="tag">data</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/dataframe/" rel="tag">dataframe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/datascience/" rel="tag">datascience</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/dell/" rel="tag">dell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/finalizer/" rel="tag">finalizer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/inspiron/" rel="tag">inspiron</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/libc/" rel="tag">libc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/llvm/" rel="tag">llvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/malloc/" rel="tag">malloc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/marshalling/" rel="tag">marshalling</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/memory/" rel="tag">memory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/science/" rel="tag">science</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/series/" rel="tag">series</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ssl/" rel="tag">ssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/strings/" rel="tag">strings</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ubuntu/" rel="tag">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/ubuntu-20-04/" rel="tag">ubuntu-20.04</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/vscode/" rel="tag">vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/wasi/" rel="tag">wasi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/wasi-sdk/" rel="tag">wasi-sdk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/wasm/" rel="tag">wasm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/wasm-libc/" rel="tag">wasm-libc</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/7610/" style="font-size: 10px;">7610</a> <a href="/blog/tags/C/" style="font-size: 17.5px;">C</a> <a href="/blog/tags/DataFrame/" style="font-size: 12.5px;">DataFrame</a> <a href="/blog/tags/FinalizationRegistry/" style="font-size: 11.25px;">FinalizationRegistry</a> <a href="/blog/tags/JavaScript/" style="font-size: 18.75px;">JavaScript</a> <a href="/blog/tags/NegotiateStream/" style="font-size: 10px;">NegotiateStream</a> <a href="/blog/tags/Pydantic/" style="font-size: 10px;">Pydantic</a> <a href="/blog/tags/Python/" style="font-size: 10px;">Python</a> <a href="/blog/tags/Serialization/" style="font-size: 10px;">Serialization</a> <a href="/blog/tags/WebAssembly/" style="font-size: 20px;">WebAssembly</a> <a href="/blog/tags/array/" style="font-size: 13.75px;">array</a> <a href="/blog/tags/arrays/" style="font-size: 13.75px;">arrays</a> <a href="/blog/tags/asyncio/" style="font-size: 11.25px;">asyncio</a> <a href="/blog/tags/clang/" style="font-size: 16.25px;">clang</a> <a href="/blog/tags/cross-compile/" style="font-size: 11.25px;">cross-compile</a> <a href="/blog/tags/data/" style="font-size: 11.25px;">data</a> <a href="/blog/tags/dataframe/" style="font-size: 11.25px;">dataframe</a> <a href="/blog/tags/datascience/" style="font-size: 10px;">datascience</a> <a href="/blog/tags/dell/" style="font-size: 10px;">dell</a> <a href="/blog/tags/finalizer/" style="font-size: 11.25px;">finalizer</a> <a href="/blog/tags/inspiron/" style="font-size: 10px;">inspiron</a> <a href="/blog/tags/libc/" style="font-size: 12.5px;">libc</a> <a href="/blog/tags/linux/" style="font-size: 10px;">linux</a> <a href="/blog/tags/llvm/" style="font-size: 10px;">llvm</a> <a href="/blog/tags/malloc/" style="font-size: 10px;">malloc</a> <a href="/blog/tags/marshalling/" style="font-size: 12.5px;">marshalling</a> <a href="/blog/tags/memory/" style="font-size: 10px;">memory</a> <a href="/blog/tags/python/" style="font-size: 11.25px;">python</a> <a href="/blog/tags/science/" style="font-size: 11.25px;">science</a> <a href="/blog/tags/series/" style="font-size: 10px;">series</a> <a href="/blog/tags/ssl/" style="font-size: 10px;">ssl</a> <a href="/blog/tags/strings/" style="font-size: 11.25px;">strings</a> <a href="/blog/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/blog/tags/ubuntu-20-04/" style="font-size: 10px;">ubuntu-20.04</a> <a href="/blog/tags/vscode/" style="font-size: 10px;">vscode</a> <a href="/blog/tags/wasi/" style="font-size: 11.25px;">wasi</a> <a href="/blog/tags/wasi-sdk/" style="font-size: 15px;">wasi-sdk</a> <a href="/blog/tags/wasm/" style="font-size: 18.75px;">wasm</a> <a href="/blog/tags/wasm-libc/" style="font-size: 12.5px;">wasm-libc</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2025/05/">May 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2024/01/">January 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2023/05/">May 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/06/">June 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2025/05/03/pydantic-generic-serialization/">Serializing Pydantic with Metadata and Generic Fields</a>
          </li>
        
          <li>
            <a href="/blog/2024/01/24/wasm-gsl/">Revisiting WebAssembly Cross Compilation in January 2024</a>
          </li>
        
          <li>
            <a href="/blog/2023/05/23/python-start_tls/">Using asyncio start_tls in Python 3.11</a>
          </li>
        
          <li>
            <a href="/blog/2022/12/21/python-negotiatestream-client/">A Python client for .Net NegotiateStream</a>
          </li>
        
          <li>
            <a href="/blog/2021/12/19/dell-inspiron-7610-linux/">Setting up a Dell Inspiron 16 Plus (7610) for Linux</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
        <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" /></a></br>
All website licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></br>
      
      &copy; 2025 Rob Blackbourn<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/blog/js/jquery-3.6.4.min.js"></script>



  
<script src="/blog/fancybox/jquery.fancybox.min.js"></script>




<script src="/blog/js/script.js"></script>





  </div>
</body>
</html>